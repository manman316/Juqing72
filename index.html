<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>控制台 (SETTINGS) - 黎梨 V29 終極修正版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- 核心样式 --- */
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #1a1b26; color: #a9b1d6; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        
        /* 封面 V27 */
        #view-cover { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 1s ease-in-out, transform 1s ease-in-out; }
        .cover-hidden { opacity: 0; transform: scale(1.05); pointer-events: none; }
        #aesthetic-title { position: absolute; top: 15%; right: 12%; writing-mode: vertical-rl; text-orientation: upright; font-family: 'Noto Serif SC', serif; color: rgba(255, 255, 255, 0.9); text-shadow: 2px 2px 8px rgba(0,0,0,0.6); display: flex; gap: 12px; height: 60%; flex-wrap: wrap-reverse; align-content: flex-start; pointer-events: none; }
        .title-line { font-size: 2rem; font-weight: 600; letter-spacing: 0.2em; transition: all 0.5s; }
        .title-line:nth-child(odd) { margin-top: 0; } .title-line:nth-child(even) { margin-top: 40px; }
        .scan-line { position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: rgba(122, 162, 247, 0.8); box-shadow: 0 0 10px #7aa2f7; animation: scan 1.5s ease-in-out infinite; display: none; }
        @keyframes scan { 0% { top: 20%; opacity: 0; } 50% { opacity: 1; } 100% { top: 80%; opacity: 0; } }

        #keypad-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        #keypad-overlay.active { opacity: 1; pointer-events: auto; }
        .key-btn { width: 70px; height: 70px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; transition: all 0.1s; cursor: pointer; }
        .key-btn:active { background: rgba(255,255,255,0.3); transform: scale(0.95); }
        .pin-dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid white; transition: background 0.2s; }
        .pin-dot.filled { background: white; }

        /* 通用 */
        #app-background { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-size: cover; background-position: center; z-index: -1; opacity: 0.15; transition: opacity 0.5s ease; pointer-events: none; }
        .custom-scroll::-webkit-scrollbar { width: 4px; } .custom-scroll::-webkit-scrollbar-track { background: rgba(22, 22, 30, 0.5); } .custom-scroll::-webkit-scrollbar-thumb { background: rgba(47, 51, 77, 0.8); border-radius: 2px; }
        .nav-item.active { color: #ff9e64; font-weight: 500; position: relative; } .nav-item.active::after { content: ''; position: absolute; bottom: -12px; left: 0; width: 100%; height: 2px; background-color: #ff9e64; }
        .custom-input { background-color: rgba(22, 22, 30, 0.8); border: 1px solid #2f334d; color: #c0caf5; transition: all 0.2s; backdrop-filter: blur(4px); } .custom-input:focus { outline: none; border-color: #ff9e64; box-shadow: 0 0 0 1px rgba(255, 158, 100, 0.2); }
        select.custom-input { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; }
        input[type=range] { -webkit-appearance: none; background: transparent; } input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #ff9e64; margin-top: -6px; cursor: pointer; } input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #2f334d; border-radius: 2px; }
        .page-section { display: none; animation: fadeIn 0.3s ease; } .page-section.active { display: block; } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .msg-actions { opacity: 0; transition: opacity 0.2s ease; z-index: 50; pointer-events: none; }
        .message-group:hover .msg-actions, .message-group:active .msg-actions, .message-group.active-touch .msg-actions { opacity: 1; pointer-events: auto; }
        .hidden-file-input { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; opacity: 0; pointer-events: none; }
        .view-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; background-color: transparent; } .view-hidden { display: none !important; }
        .toast-enter { transform: translateY(100%); opacity: 0; } .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 0.3s ease; } .toast-exit { transform: translateY(0); opacity: 1; } .toast-exit-active { transform: translateY(100%); opacity: 0; transition: all 0.3s ease; }
    </style>
</head>
<body class="h-screen flex flex-col w-full text-sm relative">

    <audio id="startup-audio" preload="auto"></audio>

    <!-- VIEW 0: COVER -->
    <div id="view-cover">
        <div class="absolute inset-0 bg-black bg-opacity-40 backdrop-blur-sm"></div>
        <div id="aesthetic-title"></div>
        <div class="relative z-10 flex flex-col items-center gap-4 mt-32">
            <div id="login-btn" onclick="App.tryUnlock()" class="w-16 h-16 rounded-full border border-white/30 bg-white/10 backdrop-blur-md flex items-center justify-center cursor-pointer hover:bg-white/20 hover:scale-95 active:scale-90 transition-all relative overflow-hidden group tap-highlight-transparent">
                <i class="fa-solid fa-fingerprint text-2xl text-white/80 group-hover:text-white"></i>
                <div id="scan-line" class="scan-line"></div>
            </div>
            <p id="login-text" class="text-[10px] text-gray-400 tracking-widest uppercase font-serif">Touch ID</p>
        </div>
        <div id="keypad-overlay">
            <div class="mb-8 flex gap-4"><div class="pin-dot" id="dot-1"></div><div class="pin-dot" id="dot-2"></div><div class="pin-dot" id="dot-3"></div><div class="pin-dot" id="dot-4"></div></div>
            <div class="grid grid-cols-3 gap-6"><div class="key-btn" onclick="App.inputPin(1)">1</div><div class="key-btn" onclick="App.inputPin(2)">2</div><div class="key-btn" onclick="App.inputPin(3)">3</div><div class="key-btn" onclick="App.inputPin(4)">4</div><div class="key-btn" onclick="App.inputPin(5)">5</div><div class="key-btn" onclick="App.inputPin(6)">6</div><div class="key-btn" onclick="App.inputPin(7)">7</div><div class="key-btn" onclick="App.inputPin(8)">8</div><div class="key-btn" onclick="App.inputPin(9)">9</div><div class="key-btn opacity-0 cursor-default"></div><div class="key-btn" onclick="App.inputPin(0)">0</div><div class="key-btn text-sm" onclick="App.clearPin()"><i class="fa-solid fa-delete-left"></i></div></div>
            <button onclick="App.cancelPin()" class="mt-8 text-white/60 text-xs tracking-widest hover:text-white">CANCEL</button>
        </div>
        <div class="absolute bottom-8 text-[10px] text-gray-500 tracking-widest font-serif opacity-50">SYSTEM V29.0 READY</div>
    </div>

    <div id="app-background"></div>

    <!-- VIEW A: DASHBOARD -->
    <div id="view-dashboard" class="view-container view-hidden" style="background-color: #1a1b26;">
        <header class="h-14 bg-[#1f2335] flex items-center justify-between px-4 border-b border-[#16161e] shrink-0 z-50 shadow-sm"><div class="flex items-center gap-3"><i class="fa-solid fa-gear text-[#ff9e64] text-lg"></i><span class="font-bold text-lg text-[#c0caf5]">控制台</span></div><button class="text-[#565f89] hover:text-[#ff9e64] transition-colors" onclick="App.showToast('已自动保存')"><i class="fa-solid fa-check text-xl"></i></button></header>
        <nav class="h-12 bg-[#1f2335] flex items-center justify-around border-b border-[#292e42] shrink-0 text-[#787c99]">
            <div class="nav-item active w-1/3 text-center py-3 cursor-pointer" onclick="App.switchTab('adventure')" id="nav-adventure">冒险</div>
            <div class="nav-item w-1/3 text-center py-3 cursor-pointer" onclick="App.switchTab('settings')" id="nav-settings">设定</div>
            <div class="nav-item w-1/3 text-center py-3 cursor-pointer" onclick="App.switchTab('system')" id="nav-system">系统</div>
        </nav>
        <main class="flex-1 overflow-y-auto custom-scroll relative">
            <div id="page-adventure" class="page-section p-4 space-y-4 pb-24">
                <!-- V29: 确保 onclick 直接调用 App.createNewAdventure() -->
                <div onclick="App.createNewAdventure()" class="border-2 border-dashed border-[#3b4261] rounded-lg h-16 flex items-center justify-center cursor-pointer text-[#7aa2f7] hover:text-[#ff9e64] hover:border-[#ff9e64] transition-all bg-[#1a1b26] hover:bg-[#1f2335]"><div class="flex items-center gap-2"><i class="fa-solid fa-circle-plus"></i><span class="font-medium">新建冒险 (NEW)</span></div></div>
                <div id="adventure-list" class="space-y-3"></div>
                <div class="pt-6 border-t border-[#292e42] mt-6"><label class="text-xs font-bold text-[#565f89] uppercase mb-3 block">数据管理</label><div class="flex gap-3"><button onclick="App.exportData()" class="flex-1 bg-[#24283b] hover:bg-[#2f334d] text-[#c0caf5] py-2 rounded border border-[#414868] flex items-center justify-center gap-2 transition-colors"><i class="fa-solid fa-file-export text-[#7aa2f7]"></i> 备份</button><button onclick="document.getElementById('file-backup-import').click()" class="flex-1 bg-[#24283b] hover:bg-[#2f334d] text-[#c0caf5] py-2 rounded border border-[#414868] flex items-center justify-center gap-2 transition-colors"><i class="fa-solid fa-file-import text-[#ff9e64]"></i> 恢复</button><input type="file" id="file-backup-import" accept=".json" class="hidden-file-input" onchange="App.importData(this)"></div></div>
            </div>

            <div id="page-settings" class="hidden p-4 pb-24 space-y-6">
                <div class="space-y-2"><label class="text-xs font-bold text-[#ff9e64] uppercase tracking-wider">剧本标题</label><input type="text" id="input-title" class="custom-input w-full p-3 rounded-md text-sm font-bold" oninput="App.updateData('title', this.value)"></div>
                <div class="space-y-3"><div class="flex justify-between items-end"><label class="text-xs font-bold text-[#ff9e64] uppercase tracking-wider flex items-center gap-2"><i class="fa-solid fa-user"></i> 角色卡</label><label class="cursor-pointer bg-[#24283b] hover:bg-[#2f334d] text-[10px] text-[#c0caf5] px-3 py-1.5 rounded border border-[#414868] transition-colors flex items-center gap-1"><i class="fa-solid fa-upload"></i> 导入JSON<input type="file" id="file-char-import" class="hidden-file-input" onchange="App.handleFileImport(this, 'character')"></label></div><div class="bg-[#1f2335] rounded-lg p-3 border border-[#292e42]"><div class="flex gap-3 mb-3"><label class="w-16 h-16 shrink-0 bg-[#1a1b26] rounded-md relative overflow-hidden group cursor-pointer border border-[#414868] hover:border-[#ff9e64]"><img id="img-char-avatar" class="w-full h-full object-cover hidden"><div id="ph-char-avatar" class="absolute inset-0 flex flex-col items-center justify-center text-[#565f89] group-hover:text-[#ff9e64]"><i class="fa-solid fa-camera text-sm"></i></div><input type="file" id="file-char-avatar" accept="image/*" class="hidden-file-input" onchange="App.handleImageUpload(this, 'charAvatar')"></label><div class="flex-1 flex flex-col justify-center gap-2"><input type="text" id="input-char-name" class="custom-input p-2 rounded text-sm w-full font-bold" placeholder="角色名称" oninput="App.updateData('charName', this.value)"></div></div><div class="mt-3"><div class="flex justify-between mb-1"><p class="text-[10px] text-[#565f89]">人设描述</p><div class="flex gap-2"><button onclick="App.clearInput('input-char-desc')" class="text-[#565f89] hover:text-red-400 text-xs px-2 py-1"><i class="fa-solid fa-trash-can pointer-events-none"></i></button><button onclick="App.openFullscreen('input-char-desc', '人设描述')" class="text-[#565f89] hover:text-[#ff9e64] text-xs px-2 py-1"><i class="fa-solid fa-expand pointer-events-none"></i></button></div></div><textarea id="input-char-desc" class="custom-input w-full p-2 rounded text-xs leading-relaxed h-24 resize-none" oninput="App.updateData('charDesc', this.value)"></textarea></div><div class="mt-3"><div class="flex justify-between mb-1"><p class="text-[10px] text-[#565f89]">开场白</p><div class="flex gap-2"><button onclick="App.clearInput('input-first-mes')" class="text-[#565f89] hover:text-red-400 text-xs px-2 py-1"><i class="fa-solid fa-trash-can pointer-events-none"></i></button><button onclick="App.openFullscreen('input-first-mes', '开场白')" class="text-[#565f89] hover:text-[#ff9e64] text-xs px-2 py-1"><i class="fa-solid fa-expand pointer-events-none"></i></button></div></div><textarea id="input-first-mes" class="custom-input w-full p-2 rounded text-xs leading-relaxed h-20 resize-none" oninput="App.updateData('firstMes', this.value)"></textarea></div></div></div>
                <div class="space-y-3"><div class="flex justify-between items-end"><label class="text-xs font-bold text-[#ff9e64] uppercase tracking-wider flex items-center gap-2"><i class="fa-solid fa-globe"></i> 世界观</label><label class="cursor-pointer bg-[#24283b] hover:bg-[#2f334d] text-[10px] text-[#c0caf5] px-3 py-1.5 rounded border border-[#414868] transition-colors flex items-center gap-1"><i class="fa-solid fa-file-import pointer-events-none"></i> 导入<input type="file" id="file-world-import" accept=".json,.txt" class="hidden-file-input" onchange="App.handleFileImport(this, 'world')"></label></div><div class="bg-[#1f2335] rounded-lg p-3 border border-[#292e42] space-y-3"><div><div class="flex justify-between mb-1"><p class="text-[10px] text-[#565f89]">世界背景</p><div class="flex gap-2"><button onclick="App.clearInput('input-world-scenario')" class="text-[#565f89] hover:text-red-400 text-xs px-2 py-1"><i class="fa-solid fa-trash-can pointer-events-none"></i></button><button onclick="App.openFullscreen('input-world-scenario', '世界背景')" class="text-[#565f89] hover:text-[#ff9e64] text-xs px-2 py-1"><i class="fa-solid fa-expand pointer-events-none"></i></button></div></div><textarea id="input-world-scenario" class="custom-input w-full p-2 rounded text-xs leading-relaxed h-24 resize-none font-mono text-[#9aa5ce]" oninput="App.updateData('worldScenario', this.value)"></textarea></div></div></div>
                <div class="space-y-3"><div class="flex justify-between items-end"><label class="text-xs font-bold text-[#bb9af7] uppercase tracking-wider flex items-center gap-2"><i class="fa-solid fa-sliders"></i> 高级预设</label></div><div class="relative bg-[#1f2335] p-2 rounded border border-[#292e42] flex gap-2"><label class="w-10 h-10 shrink-0 bg-[#2f334d] rounded-full relative overflow-hidden group cursor-pointer"><img id="img-user-avatar" class="w-full h-full object-cover hidden"><div id="ph-user-avatar" class="absolute inset-0 flex items-center justify-center text-[#7aa2f7]"><i class="fa-solid fa-user pointer-events-none"></i></div><input type="file" id="file-user-avatar" accept="image/*" class="hidden-file-input" onchange="App.handleImageUpload(this, 'userAvatar')"></label><div class="flex-1"><div class="flex justify-between mb-1"><p class="text-[10px] text-[#565f89]">玩家设定 (YOU)</p><div class="flex gap-2"><button onclick="App.clearInput('input-user-persona')" class="text-[#565f89] hover:text-red-400 text-xs px-2 py-1"><i class="fa-solid fa-trash-can pointer-events-none"></i></button><button onclick="App.openFullscreen('input-user-persona', '玩家设定')" class="text-[#565f89] hover:text-[#ff9e64] text-xs px-2 py-1"><i class="fa-solid fa-expand pointer-events-none"></i></button></div></div><textarea id="input-user-persona" class="custom-input w-full p-2 rounded text-xs leading-relaxed h-12 resize-none" oninput="App.updateData('userPersona', this.value)"></textarea></div></div><div class="relative"><div class="flex justify-between items-end mb-1 ml-1"><p class="text-[10px] text-[#565f89]">破限 (JAILBREAK)</p><div class="flex gap-2 items-center"><label class="cursor-pointer bg-[#24283b] hover:bg-[#2f334d] text-[10px] text-[#c0caf5] px-2 py-0.5 rounded border border-[#414868] transition-colors flex items-center gap-1 mr-2"><i class="fa-solid fa-folder-open pointer-events-none"></i> 批量导入<input type="file" id="file-preset-raw" multiple class="hidden-file-input" onchange="App.handleRawPresetUpload(this)"></label><button onclick="App.clearInput('input-jailbreak')" class="text-[#565f89] hover:text-red-400 text-xs px-2 py-1"><i class="fa-solid fa-trash-can pointer-events-none"></i></button><button onclick="App.openFullscreen('input-jailbreak', '破限设置')" class="text-[#565f89] hover:text-[#ff9e64] text-xs px-2 py-1"><i class="fa-solid fa-expand pointer-events-none"></i></button></div></div><textarea id="input-jailbreak" class="custom-input w-full p-2 rounded text-[10px] font-mono leading-relaxed h-32 resize-none text-[#73daca]" oninput="App.updateData('jailbreak', this.value)"></textarea></div></div>
            </div>

            <!-- 3. 系统页 -->
            <div id="page-system" class="hidden p-4 space-y-6">
                <div class="space-y-4 border-b border-[#292e42] pb-6">
                    <label class="text-xs font-bold text-[#bb9af7] uppercase tracking-wider flex items-center gap-2"><i class="fa-solid fa-wand-magic-sparkles"></i> 門戶與個性化</label>
                    <div class="flex justify-between items-center"><span class="text-[10px] text-[#565f89]">全局壁紙</span><div class="flex gap-2"><label class="cursor-pointer text-[10px] bg-[#24283b] px-2 py-1 rounded border border-[#414868] text-[#c0caf5]">上傳<input type="file" id="file-bg-upload" accept="image/*" class="hidden-file-input" onchange="App.handleBgUpload(this)"></label><button onclick="App.clearBackground()" class="text-[10px] bg-[#24283b] px-2 py-1 rounded border border-[#414868] text-red-400">清除</button></div></div>
                    <div class="flex justify-between items-center"><span class="text-[10px] text-[#565f89]">封面圖片</span><div class="flex gap-2"><label class="cursor-pointer text-[10px] bg-[#24283b] px-2 py-1 rounded border border-[#414868] text-[#c0caf5]">上傳<input type="file" id="file-cover-upload" accept="image/*" class="hidden-file-input" onchange="App.handleCoverUpload(this)"></label><button onclick="App.clearCover()" class="text-[10px] bg-[#24283b] px-2 py-1 rounded border border-[#414868] text-red-400">重置</button></div></div>
                    <div class="flex justify-between items-center"><span class="text-[10px] text-[#565f89]">啟動音效 (支持視頻)</span><div class="flex gap-2"><label class="cursor-pointer text-[10px] bg-[#24283b] px-2 py-1 rounded border border-[#414868] text-[#c0caf5]">上傳<input type="file" id="file-audio-upload" accept="audio/*,video/*" class="hidden-file-input" onchange="App.handleAudioUpload(this)"></label><button onclick="App.clearAudio()" class="text-[10px] bg-[#24283b] px-2 py-1 rounded border border-[#414868] text-red-400">默認</button></div></div>
                    <div class="space-y-1"><span class="text-[10px] text-[#565f89]">歡迎詞 (自動豎排錯位)</span><textarea id="input-welcome-text" class="custom-input w-full p-2 rounded text-xs" rows="2" placeholder="以文為碼，重構森羅萬象" oninput="App.saveSystemSettings()"></textarea></div>
                    <div class="space-y-1"><span class="text-[10px] text-[#565f89]">安全鎖密碼 (4位)</span><input type="number" id="input-passcode" class="custom-input w-full p-2 rounded text-xs font-mono" placeholder="留空則不啟用" oninput="if(this.value.length>4) this.value=this.value.slice(0,4); App.saveSystemSettings()"></div>
                </div>
                <!-- API Setting -->
                <div class="space-y-4 border-b border-[#292e42] pb-6">
                    <label class="text-xs font-bold text-[#7aa2f7] uppercase tracking-wider flex items-center gap-2"><i class="fa-solid fa-network-wired"></i> API 连接</label>
                    <div class="space-y-1"><p class="text-[10px] text-[#565f89]">API 地址</p><input type="text" id="input-api-url" class="custom-input w-full p-3 rounded-md text-sm font-mono text-[#9aa5ce]" placeholder="https://generativelanguage.googleapis.com/v1beta" oninput="App.saveSystemSettings()"></div>
                    <div class="space-y-1"><p class="text-[10px] text-[#565f89]">API 密钥</p><input type="password" id="input-api-key" class="custom-input w-full p-3 rounded-md text-sm font-mono text-[#9aa5ce]" placeholder="AIzaSy..." oninput="App.saveSystemSettings()"></div>
                    <div class="space-y-1"><p class="text-[10px] text-[#565f89]">AI 模型</p><div class="flex gap-2"><select id="select-model" class="custom-input flex-1 p-3 rounded-md text-sm font-mono text-[#ff9e64] bg-[#16161e]" onchange="App.saveSystemSettings()"><option value="" disabled selected>请点击刷新...</option></select><button onclick="App.fetchModels()" class="bg-[#24283b] hover:bg-[#2f334d] text-[#c0caf5] px-4 rounded border border-[#414868] transition-colors"><i class="fa-solid fa-arrows-rotate pointer-events-none"></i></button></div></div>
                </div>
                <div class="space-y-6 px-2">
                    <div class="space-y-2"><div class="flex justify-between text-sm font-bold text-[#c0caf5]"><span>AI 随机性</span><span class="text-[#ff9e64] font-mono" id="disp-temp">0.9</span></div><input type="range" min="0" max="2" step="0.01" value="0.9" oninput="document.getElementById('disp-temp').innerText = this.value"></div>
                    <div class="space-y-2"><div class="flex justify-between text-sm font-bold text-[#c0caf5]"><span>回复长度</span><span class="text-[#ff9e64] font-mono" id="disp-tokens">2048</span></div><input type="range" min="200" max="8192" step="100" value="2048" oninput="document.getElementById('disp-tokens').innerText = this.value"></div>
                    <div class="space-y-2"><div class="flex justify-between text-sm font-bold text-[#c0caf5]"><span>上下文记忆</span><span class="text-[#ff9e64] font-mono" id="disp-context">20</span></div><input type="range" min="5" max="100" step="1" value="20" oninput="document.getElementById('disp-context').innerText = this.value"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- VIEW B: CHAT -->
    <div id="view-chat" class="view-container view-hidden fade-in">
        <div class="h-14 bg-[#1f2335] bg-opacity-90 backdrop-blur-sm flex items-center justify-between px-4 border-b border-[#16161e] shrink-0 shadow-sm">
             <div class="flex items-center gap-3"><button onclick="App.enterDashboard()" class="text-[#565f89] hover:text-[#ff9e64] flex items-center gap-2 transition-colors group"><i class="fa-solid fa-gear text-lg group-hover:rotate-90 transition-transform duration-500"></i><span class="font-bold text-sm">控制台</span></button></div>
             <div class="absolute left-1/2 transform -translate-x-1/2 text-center pointer-events-none"><h3 id="chat-title" class="font-bold text-[#c0caf5] text-sm shadow-black drop-shadow-md">...</h3><div class="flex items-center justify-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-green-500"></span><span class="text-[10px] text-[#565f89]">Online</span></div></div>
            <div class="flex gap-3"><button onclick="App.clearChatHistory()" class="text-[#565f89] hover:text-red-400" title="清空记录"><i class="fa-solid fa-trash-can pointer-events-none"></i></button><img id="chat-header-avatar" class="w-8 h-8 rounded-full border border-[#2f334d] bg-[#1a1b26] object-cover"></div>
        </div>
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scroll"></div>
        <div class="p-3 bg-[#1a1b26] bg-opacity-80 backdrop-blur-md border-t border-[#16161e] shrink-0">
            <div class="relative flex items-center gap-2">
                <button onclick="App.regenerateResponse()" class="w-10 h-10 rounded-full bg-[#24283b] text-[#ff9e64] border border-[#414868] flex items-center justify-center hover:bg-[#2f334d] shrink-0 active:scale-90 transition-transform" title="重新生成"><i class="fa-solid fa-arrows-rotate pointer-events-none"></i></button>
                <div class="relative w-full"><textarea id="chat-input" class="w-full bg-[#16161e] bg-opacity-50 text-[#c0caf5] rounded-xl p-3 pr-10 text-sm border border-[#2f334d] focus:border-[#ff9e64] outline-none h-12 resize-none" placeholder="发送消息..." oninput="App.updateCharCount(this)"></textarea><span id="char-count" class="absolute top-[-18px] right-1 text-[10px] text-[#565f89] font-mono">0 chars</span></div>
                <button onclick="App.sendUserMessage()" class="absolute right-2 bottom-2.5 text-[#ff9e64] p-2 hover:scale-110 transition-transform"><i class="fa-solid fa-paper-plane pointer-events-none"></i></button>
            </div>
        </div>
    </div>

    <div id="fullscreen-editor" class="fixed inset-0 bg-[#1a1b26] z-[100] hidden flex-col">
        <div class="h-12 bg-[#1f2335] flex items-center justify-between px-4 border-b border-[#292e42]"><span id="fs-title" class="font-bold text-[#ff9e64]">正在编辑</span><button onclick="App.closeFullscreen()" class="text-[#7aa2f7] text-sm font-bold">完成</button></div>
        <textarea id="fs-textarea" class="flex-1 bg-[#1a1b26] text-[#c0caf5] p-4 outline-none resize-none font-mono text-sm leading-relaxed"></textarea>
    </div>
    <div id="toast-container" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 z-[200]"></div>

    <script>
        const AssetDB = {
            db: null,
            init() { return new Promise((res, rej) => { const r = indexedDB.open("RP_Assets_DB", 1); r.onupgradeneeded = (e) => { if (!e.target.result.objectStoreNames.contains("assets")) e.target.result.createObjectStore("assets"); }; r.onsuccess = (e) => { this.db = e.target.result; res(); }; r.onerror = (e) => rej(e); }); },
            async save(k, d) { if (!this.db) await this.init(); return new Promise((res, rej) => { const tx = this.db.transaction(["assets"], "readwrite"); tx.objectStore("assets").put(d, k); tx.oncomplete = res; tx.onerror = rej; }); },
            async get(k) { if (!this.db) await this.init(); return new Promise((res, rej) => { const tx = this.db.transaction(["assets"], "readonly"); const r = tx.objectStore("assets").get(k); r.onsuccess = () => res(r.result); r.onerror = rej; }); },
            async delete(k) { if (!this.db) await this.init(); return new Promise((res, rej) => { const tx = this.db.transaction(["assets"], "readwrite"); tx.objectStore("assets").delete(k); tx.oncomplete = res; }); }
        };

        const App = {
            data: [], currentId: null, fsTargetId: null, editMsgIndex: null, currentPin: "",
            async init() {
                try { await AssetDB.init(); } catch(e) { console.log("DB Fail"); }
                const saved = localStorage.getItem('roleplay_saves_v2'); if (saved) { try { this.data = JSON.parse(saved); } catch(e) { this.createAdventure("默认冒险"); } } else { this.createAdventure("默认冒险"); }
                this.loadSystemSettings(); this.loadBackground(); this.loadCoverSettings(); this.loadAudioSettings();
                if (this.data.length > 0) this.loadAdventure(this.data[0].id); else this.createAdventure("默认冒险");
                this.renderAdventureList(); this.switchTab('adventure');
                document.getElementById('chat-container').addEventListener('click', (e) => { document.querySelectorAll('.message-group').forEach(el => el.classList.remove('active-touch')); const bubble = e.target.closest('.message-group'); if (bubble) bubble.classList.add('active-touch'); });
            },

            renderAestheticTitle(text) {
                const container = document.getElementById('aesthetic-title'); container.innerHTML = '';
                const str = text || "以文為碼，重構森羅萬象"; 
                const lines = str.split(/[ ，,。.\n]/).filter(l => l.trim() !== "");
                lines.forEach((line) => { const div = document.createElement('div'); div.className = 'title-line'; div.innerText = line; container.appendChild(div); });
            },

            // V29 核心修复：新建逻辑闭环
            createNewAdventure(t = "新冒险") {
                const newId = Date.now().toString() + Math.floor(Math.random() * 1000).toString(); // V29: 增加随机数防止ID冲突
                const n = { id: newId, title: t, charName: "", charDesc: "", firstMes: "你好，旅行者。", worldScenario: "", userPersona: "", jailbreak: "", charAvatar: "", userAvatar: "", chatHistory: [] };
                this.data.push(n);
                this.saveToLocal();
                
                // 核心修复：强制指针跳转与视图刷新
                this.currentId = newId;
                
                // 1. 刷新列表（确保 UI 上有这个新项目）
                this.renderAdventureList();
                
                // 2. 强制加载数据到设定页表单
                this.loadAdventure(newId);
                
                // 3. 强制切换到 Dashboard 视图 (处理 SPA 逻辑)
                this.enterDashboard();
                
                // 4. 切换到 Settings Tab
                this.switchTab('settings');
                
                // 5. 聚焦输入框
                setTimeout(() => {
                    const titleInput = document.getElementById('input-title');
                    if (titleInput) {
                        titleInput.focus();
                        titleInput.select();
                    }
                }, 200);
                
                this.showToast("新篇章已開啟");
            },

            updateData(key, value) {
                if (!this.currentId) return;
                const adv = this.data.find(a => a.id === this.currentId);
                if (adv) {
                    adv[key] = value;
                    this.saveToLocal();
                    // 实时刷新列表，确保标题同步
                    if (key === 'title') { 
                        this.renderAdventureList(); 
                        this.updateChatHeader(); 
                    }
                    if (['charName', 'charAvatar'].includes(key)) this.updateChatHeader();
                }
            },
            
            // V29: 确保点击列表也能正确跳转
            enterChat(id) {
                this.currentId = id; // 确保指针更新
                this.loadAdventure(id);
                document.getElementById('view-dashboard').classList.add('view-hidden');
                document.getElementById('view-chat').classList.remove('view-hidden');
                const c = document.getElementById('chat-container'); 
                setTimeout(() => c.scrollTop = c.scrollHeight, 50);
            },

            // --- 其他逻辑 (V28以前) ---
            async loadAudioSettings() { const a = document.getElementById('startup-audio'); const d = await AssetDB.get('custom_audio'); if (d) { a.src = URL.createObjectURL(d); } else { a.src = "data:audio/wav;base64,UklGRl9vT1BXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"; } },
            handleAudioUpload(i) { const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload = async (e) => { const b = new Blob([e.target.result], { type: f.type }); await AssetDB.save('custom_audio', b); this.loadAudioSettings(); this.showToast("音效已更换"); setTimeout(()=>document.getElementById('startup-audio').play(), 500); }; r.readAsArrayBuffer(f); i.value = ''; },
            async clearAudio() { await AssetDB.delete('custom_audio'); this.loadAudioSettings(); this.showToast("已恢复"); },
            async loadBackground() { const b = await AssetDB.get('bg_image'); const el = document.getElementById('app-background'); if (b) { el.style.backgroundImage = `url(${URL.createObjectURL(b)})`; el.style.opacity = '0.4'; } else { el.style.backgroundImage = 'none'; el.style.opacity = '0'; } },
            handleBgUpload(i) { const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload = async (e) => { const b = new Blob([e.target.result], {type: f.type}); await AssetDB.save('bg_image', b); this.loadBackground(); this.showToast("背景已设"); }; r.readAsArrayBuffer(f); i.value = ''; },
            async clearBackground() { await AssetDB.delete('bg_image'); this.loadBackground(); this.showToast("背景已删"); },
            async loadCoverSettings() { const s = JSON.parse(localStorage.getItem('roleplay_api_settings')) || {}; this.renderAestheticTitle(s.welcomeText); document.getElementById('input-welcome-text').value = s.welcomeText || ""; document.getElementById('input-passcode').value = s.passcode || ""; const b = await AssetDB.get('cover_image'); if (b) document.getElementById('view-cover').style.backgroundImage = `url(${URL.createObjectURL(b)})`; },
            handleCoverUpload(i) { const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload = async (e) => { const b = new Blob([e.target.result], {type: f.type}); await AssetDB.save('cover_image', b); this.loadCoverSettings(); this.showToast("封面已换"); }; r.readAsArrayBuffer(f); i.value = ''; },
            async clearCover() { await AssetDB.delete('cover_image'); document.getElementById('view-cover').style.backgroundImage = "url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop')"; this.showToast("封面重置"); },
            playStartupSound() { const a = document.getElementById('startup-audio'); a.volume=0.6; a.play().catch(()=>{}); },
            tryUnlock() { const s = JSON.parse(localStorage.getItem('roleplay_api_settings')) || {}; if (s.passcode && s.passcode.length === 4) { document.getElementById('keypad-overlay').classList.add('active'); this.currentPin = ""; this.updatePinDots(); } else { this.performUnlock(); } },
            performUnlock() { this.playStartupSound(); this.animateScan(); },
            inputPin(n) { if (this.currentPin.length < 4) { this.currentPin += n; this.updatePinDots(); if (this.currentPin.length === 4) setTimeout(() => this.checkPin(), 200); } },
            clearPin() { this.currentPin = this.currentPin.slice(0, -1); this.updatePinDots(); },
            cancelPin() { document.getElementById('keypad-overlay').classList.remove('active'); this.currentPin = ""; this.updatePinDots(); },
            updatePinDots() { for(let i=1; i<=4; i++) { const d = document.getElementById(`dot-${i}`); if (i <= this.currentPin.length) d.classList.add('filled'); else d.classList.remove('filled'); } },
            checkPin() { const s = JSON.parse(localStorage.getItem('roleplay_api_settings')) || {}; if (this.currentPin === s.passcode) { document.getElementById('keypad-overlay').classList.remove('active'); this.performUnlock(); } else { document.querySelector('.mb-8').classList.add('animate-bounce', 'text-red-500'); setTimeout(() => { document.querySelector('.mb-8').classList.remove('animate-bounce', 'text-red-500'); this.currentPin = ""; this.updatePinDots(); }, 500); } },
            animateScan() { document.getElementById('scan-line').style.display = 'block'; document.getElementById('login-text').innerText = "Verifying..."; document.getElementById('login-text').classList.add('text-[#7aa2f7]', 'animate-pulse'); setTimeout(() => { document.getElementById('login-text').innerText = "Granted"; document.getElementById('login-text').classList.replace('text-[#7aa2f7]', 'text-green-400'); setTimeout(() => { document.getElementById('view-cover').classList.add('cover-hidden'); document.getElementById('view-dashboard').classList.remove('view-hidden'); }, 500); }, 1200); },
            updateCharCount(t) { document.getElementById('char-count').innerText = t.value.length + ' chars'; },
            enterDashboard() { document.getElementById('view-chat').classList.add('view-hidden'); document.getElementById('view-dashboard').classList.remove('view-hidden'); this.switchTab('adventure'); },
            saveToLocal() { localStorage.setItem('roleplay_saves_v2', JSON.stringify(this.data)); },
            loadSystemSettings() { const s = JSON.parse(localStorage.getItem('roleplay_api_settings')) || { url: '', key: '', model: '' }; document.getElementById('input-api-url').value = s.url || ''; document.getElementById('input-api-key').value = s.key || ''; if(s.model) { const sel = document.getElementById('select-model'); sel.innerHTML = `<option value="${s.model}">${s.model}</option>`; sel.value = s.model; } this.loadCoverSettings(); },
            saveSystemSettings() { const url = document.getElementById('input-api-url').value; const key = document.getElementById('input-api-key').value; const model = document.getElementById('select-model').value; const welcomeText = document.getElementById('input-welcome-text').value; const passcode = document.getElementById('input-passcode').value; const old = JSON.parse(localStorage.getItem('roleplay_api_settings')) || {}; const newS = { ...old, url, key, model, welcomeText, passcode }; localStorage.setItem('roleplay_api_settings', JSON.stringify(newS)); this.renderAestheticTitle(welcomeText); },
            async fetchModels() { let url = document.getElementById('input-api-url').value.replace(/\/$/, ''); const key = document.getElementById('input-api-key').value; const select = document.getElementById('select-model'); if (!url) return alert("请先填写 API 地址"); select.innerHTML = '<option>连接中...</option>'; const fallback = ["gemini-1.5-flash", "gemini-1.5-pro", "gemini-1.5-flash-8b", "gemini-1.0-pro"]; try { let fUrl = "", h = {}; if (url.includes('googleapis.com')) { if (!url.includes('v1beta')) url += '/v1beta'; fUrl = `${url}/models?key=${key}`; } else { fUrl = `${url}/models`; h = { 'Authorization': `Bearer ${key}` }; } const res = await fetch(fUrl, { method: 'GET', headers: h }); if (!res.ok) throw new Error("Err"); const data = await res.json(); const models = data.models || data.data || []; select.innerHTML = ''; if (models.length === 0) { select.innerHTML = '<option value="">未找到</option>'; return; } models.forEach(m => { let id = m.name || m.id; if (id.startsWith('models/')) id = id.replace('models/', ''); const opt = document.createElement('option'); opt.value = id; opt.text = id; select.appendChild(opt); }); this.showToast(`已获取 ${models.length} 个模型`); } catch (err) { if (url.includes('googleapis')) { select.innerHTML = ''; fallback.forEach(m => { const opt = document.createElement('option'); opt.value = m; opt.text = m; select.appendChild(opt); }); this.showToast("已加载内置 Gemini 列表"); select.value = fallback[0]; this.saveSystemSettings(); } else { select.innerHTML = '<option value="">获取失败</option>'; const manual = prompt("连接失败，请输入模型：", "gpt-3.5-turbo"); if(manual) { select.innerHTML = `<option value="${manual}">${manual}</option>`; this.saveSystemSettings(); } } } },
            handleRawPresetUpload(i) { const f = i.files; if (!f || f.length === 0) return; let txt = ""; let c = 0; Array.from(f).forEach(file => { const r = new FileReader(); r.onload = (e) => { txt += `\n\n--- File: ${file.name} ---\n${e.target.result}`; c++; if (c === f.length) { const j = document.getElementById('input-jailbreak'); j.value += txt; this.updateData('jailbreak', j.value); this.showToast(`已追加 ${f.length} 个文件`); i.value = ''; } }; r.readAsText(file); }); },
            async generateAIResponse() { const adv = this.data.find(a => a.id === this.currentId); if (!adv) return; const s = JSON.parse(localStorage.getItem('roleplay_api_settings')); if (!s || !s.url || !s.key) { this.showToast("请先配置 API"); return; } const sys = [`[Character: ${adv.charName}]`, `[Description: ${adv.charDesc}]`, `[Scenario: ${adv.worldScenario}]`, `[User: ${adv.userPersona}]`, adv.jailbreak].join('\n\n'); let hist = []; const isGemini = s.url.includes('googleapis'); if (isGemini) { if(adv.firstMes) hist.push({ role: 'model', parts: [{ text: adv.firstMes }] }); adv.chatHistory.forEach(msg => hist.push({ role: msg.role === 'user' ? 'user' : 'model', parts: [{ text: msg.content }] })); } else { hist.push({ role: "system", content: sys }); if(adv.firstMes) hist.push({ role: "assistant", content: adv.firstMes }); adv.chatHistory.forEach(msg => hist.push({ role: msg.role === 'user' ? 'user' : 'assistant', content: msg.content })); } const c = document.getElementById('chat-container'); const tid = 'thinking-' + Date.now(); c.insertAdjacentHTML('beforeend', `<div id="${tid}" class="flex gap-3 animate-pulse"><div class="w-8 h-8 rounded-full bg-gray-700 shrink-0"></div><div class="bg-[#24283b] bg-opacity-60 backdrop-blur-md border border-[#2f334d] text-gray-400 p-3 text-sm rounded-r-xl rounded-bl-xl w-fit">Thinking...</div></div>`); c.scrollTop = c.scrollHeight; try { let fUrl, body, head = {}; if (isGemini) { let b = s.url.replace(/\/$/, ''); if (!b.includes('v1beta')) b += '/v1beta'; fUrl = `${b}/models/${s.model || 'gemini-1.5-flash'}:generateContent?key=${s.key}`; head = { 'Content-Type': 'application/json' }; body = JSON.stringify({ contents: hist, systemInstruction: { parts: [{ text: sys }] }, generationConfig: { temperature: parseFloat(document.getElementById('disp-temp').innerText)||0.9, maxOutputTokens: parseInt(document.getElementById('disp-tokens').innerText)||2048 } }); } else { fUrl = `${s.url}/chat/completions`; head = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${s.key}` }; body = JSON.stringify({ model: s.model, messages: hist, temperature: parseFloat(document.getElementById('disp-temp').innerText)||0.9, max_tokens: parseInt(document.getElementById('disp-tokens').innerText)||2048 }); } const res = await fetch(fUrl, { method: 'POST', headers: head, body }); if (!res.ok) throw new Error((await res.text())); const data = await res.json(); let reply = isGemini ? (data.candidates?.[0]?.content?.parts?.[0]?.text || "(No response)") : (data.choices?.[0]?.message?.content || "(No response)"); document.getElementById(tid).remove(); adv.chatHistory.push({ role: 'ai', content: reply, timestamp: Date.now() }); this.saveToLocal(); this.renderChat(); } catch (e) { document.getElementById(tid).remove(); this.showToast("API 错误"); console.error(e); c.insertAdjacentHTML('beforeend', `<div class="text-red-500 text-xs p-4 text-center w-fit">Error: ${e.message}</div>`); } },
            regenerateResponse() { const adv = this.data.find(a => a.id === this.currentId); if (!adv || !adv.chatHistory || adv.chatHistory.length === 0) return; const last = adv.chatHistory[adv.chatHistory.length - 1]; if (last.role === 'ai') { adv.chatHistory.pop(); this.saveToLocal(); this.renderChat(); } this.generateAIResponse(); },
            deleteAdventure(id) { this.data = this.data.filter(a => a.id !== id); this.saveToLocal(); if (this.data.length === 0) this.createNewAdventure(); else { if (id === this.currentId) this.loadAdventure(this.data[0].id); else this.renderAdventureList(); } this.showToast("存档已删除"); },
            loadAdventure(id) { this.currentId = id; const adv = this.data.find(a => a.id === id); if (!adv) return; ['title', 'charName', 'charDesc', 'firstMes', 'worldScenario', 'userPersona', 'jailbreak'].forEach(key => { const el = document.getElementById(`input-${key.replace(/[A-Z]/g, m => "-" + m.toLowerCase())}`); if(el) el.value = adv[key] || ""; }); this.renderAvatar('char', adv.charAvatar); this.renderAvatar('user', adv.userAvatar); this.renderAdventureList(); this.renderChat(); },
            handleImageUpload(i, t) { const f = i.files[0]; if (!f) return; const r = new FileReader(); r.onload = (e) => { this.updateData(t, e.target.result); this.renderAvatar(t === 'charAvatar' ? 'char' : 'user', e.target.result); }; r.readAsDataURL(f); i.value = ''; },
            renderAvatar(p, s) { const i = document.getElementById(`img-${p}-avatar`); const ph = document.getElementById(`ph-${p}-avatar`); if (s) { i.src = s; i.classList.remove('hidden'); ph.classList.add('hidden'); } else { i.src = ""; i.classList.add('hidden'); ph.classList.remove('hidden'); } },
            exportData() { const j = JSON.stringify(this.data, null, 2); const b = new Blob([j], {type: "application/json"}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = `RP_Backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); },
            importData(i) { const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload = (e) => { try { const j = JSON.parse(e.target.result); if (Array.isArray(j)) { j.forEach(a => { a.id = Date.now().toString() + Math.random().toString().slice(2,5); this.data.push(a); }); this.saveToLocal(); this.renderAdventureList(); alert(`成功导入 ${j.length} 个存档！`); } else { alert("格式错误"); } } catch(e) { alert("解析失败"); } }; r.readAsText(f); i.value = ''; },
            handleFileImport(i, t) { const f = i.files[0]; if (!f) return; const r = new FileReader(); r.onload = (e) => { const raw = e.target.result; try { const j = JSON.parse(raw); if (t === 'character') { if(j.name) { document.getElementById('input-char-name').value = j.name; this.updateData('charName', j.name); } if(j.description) { document.getElementById('input-char-desc').value = j.description; this.updateData('charDesc', j.description); } if(j.first_mes) { document.getElementById('input-first-mes').value = j.first_mes; this.updateData('firstMes', j.first_mes); } this.showToast("导入成功"); } else if (t === 'world') { let x = j.entries ? j.entries.map(en => `[${en.keys}]: ${en.content}`).join('\n\n') : (j.world_scenario || JSON.stringify(j, null, 2)); const c = document.getElementById('input-world-scenario').value; const n = c ? c + "\n\n" + x : x; document.getElementById('input-world-scenario').value = n; this.updateData('worldScenario', n); this.showToast("世界书追加"); } } catch (err) { if (t === 'world') { const c = document.getElementById('input-world-scenario').value; const n = c ? c + "\n\n" + raw : raw; document.getElementById('input-world-scenario').value = n; this.updateData('worldScenario', n); this.showToast("文本追加"); } } }; r.readAsText(f); i.value = ''; },
            clearInput(id) { const el = document.getElementById(id); if(el) { el.value = ""; el.dispatchEvent(new Event('input')); this.showToast("已清空"); } },
            showToast(m) { const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = 'bg-[#1f2335] text-[#7aa2f7] px-4 py-2 rounded-full border border-[#2f334d] shadow-lg text-xs font-bold toast-enter'; t.innerText = m; c.appendChild(t); setTimeout(() => { t.classList.remove('toast-enter'); t.classList.add('toast-enter-active'); }, 10); setTimeout(() => { t.classList.remove('toast-enter-active'); t.classList.add('toast-exit-active'); }, 2000); setTimeout(() => t.remove(), 2300); },
            openFullscreen(id, t) { this.fsTargetId = id; document.getElementById('fs-textarea').value = document.getElementById(id).value; document.getElementById('fs-title').innerText = "正在编辑: " + t; document.getElementById('fullscreen-editor').style.display = 'flex'; document.getElementById('fs-textarea').oninput = (e) => { document.getElementById(this.fsTargetId).value = e.target.value; document.getElementById(this.fsTargetId).dispatchEvent(new Event('input')); }; },
            closeFullscreen() { document.getElementById('fullscreen-editor').style.display = 'none'; this.fsTargetId = null; if (this.editMsgIndex !== null) { const adv = this.data.find(a => a.id === this.currentId); if (adv) { const n = document.getElementById('fs-textarea').value; if (this.editMsgIndex === -1) { adv.firstMes = n; const el = document.getElementById('input-first-mes'); if(el) el.value = n; } else { adv.chatHistory[this.editMsgIndex].content = n; } this.saveToLocal(); this.renderChat(); } this.editMsgIndex = null; } },
            renderChat() { const adv = this.data.find(a => a.id === this.currentId); if (!adv) return; const c = document.getElementById('chat-container'); c.innerHTML = ''; if (adv.firstMes) this.appendChatBubble(adv.firstMes, 'ai', -1); if (adv.chatHistory) adv.chatHistory.forEach((msg, idx) => this.appendChatBubble(msg.content, msg.role, idx, msg.timestamp)); this.updateChatHeader(); },
            updateChatHeader() { const adv = this.data.find(a => a.id === this.currentId); if(!adv) return; document.getElementById('chat-title').innerText = adv.title || "未命名"; document.getElementById('chat-header-avatar').src = adv.charAvatar || "https://api.dicebear.com/7.x/adventurer/svg?seed=Gener"; },
            appendChatBubble(text, role, idx, timestamp = Date.now()) { const adv = this.data.find(a => a.id === this.currentId); const isUser = role === 'user'; const avatar = isUser ? (adv.userAvatar || "https://api.dicebear.com/7.x/initials/svg?seed=ME") : (adv.charAvatar || "https://api.dicebear.com/7.x/adventurer/svg?seed=Gener"); const name = isUser ? "YOU" : (adv.charName || "GM"); const bubbleColor = isUser ? "bg-[#3d59a1] bg-opacity-60 backdrop-blur-md text-white" : "bg-[#24283b] bg-opacity-60 backdrop-blur-md border border-[#2f334d] text-[#c0caf5]"; const date = new Date(timestamp); const timeStr = `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2,'0')}/${date.getDate().toString().padStart(2,'0')} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`; const html = `<div class="flex gap-3 ${isUser ? 'flex-row-reverse' : ''} group message-group animate-fade-in-up relative" id="msg-${idx}"><img src="${avatar}" class="w-8 h-8 rounded-full mt-1 shrink-0 object-cover bg-[#1a1b26]"><div class="flex flex-col gap-1 max-w-[98%] ${isUser ? 'items-end' : ''} relative"><div class="flex items-center gap-2"><span class="text-[10px] ${isUser ? 'text-[#7aa2f7]' : 'text-[#ff9e64]'} font-bold">${name}</span><div class="msg-actions relative flex gap-3 ml-2"><button onclick="App.editMessage(${idx})" class="text-sm text-gray-500 hover:text-[#ff9e64] transition-colors cursor-pointer"><i class="fa-solid fa-pencil pointer-events-none"></i></button>${idx !== -1 ? `<button onclick="App.deleteMessage(${idx})" class="text-sm text-gray-500 hover:text-red-400 transition-colors cursor-pointer"><i class="fa-solid fa-trash-can pointer-events-none"></i></button>` : ''}</div></div><div class="${bubbleColor} p-2 px-3 text-sm ${isUser ? 'rounded-l-xl rounded-br-xl' : 'rounded-r-xl rounded-bl-xl'} shadow-sm relative z-10 w-fit"><div class="whitespace-pre-wrap break-words" style="word-break: break-word;">${text}<span class="float-right text-[9px] opacity-50 ml-3 mt-1 select-none font-mono tracking-tighter relative top-[2px]" style="line-height: 1.2;">${timeStr}</span></div></div></div></div>`; document.getElementById('chat-container').insertAdjacentHTML('beforeend', html); },
            sendUserMessage() { const i = document.getElementById('chat-input'); const t = i.value.trim(); if (!t || !this.currentId) return; const adv = this.data.find(a => a.id === this.currentId); if(!adv.chatHistory) adv.chatHistory = []; adv.chatHistory.push({ role: 'user', content: t, timestamp: Date.now() }); this.saveToLocal(); this.renderChat(); i.value = ''; this.generateAIResponse(); this.updateCharCount(i); },
            editMessage(idx) { const adv = this.data.find(a => a.id === this.currentId); let c = idx === -1 ? adv.firstMes : adv.chatHistory[idx].content; this.editMsgIndex = idx; document.getElementById('fs-textarea').value = c; document.getElementById('fs-title').innerText = "正在编辑消息"; document.getElementById('fullscreen-editor').style.display = 'flex'; },
            deleteMessage(idx) { const adv = this.data.find(a => a.id === this.currentId); adv.chatHistory.splice(idx, 1); this.saveToLocal(); this.renderChat(); this.showToast("已删除"); },
            clearChatHistory() { if(!confirm("清空？")) return; const adv = this.data.find(a => a.id === this.currentId); adv.chatHistory = []; this.saveToLocal(); this.renderChat(); this.showToast("已清空"); },
            copyDataToClipboard() { const j = JSON.stringify(this.data, null, 2); if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(j).then(() => this.showToast("已複製")).catch(() => this.showToast("複製失敗")); } else { const ta = document.createElement('textarea'); ta.value = j; document.body.appendChild(ta); ta.select(); try { document.execCommand('copy'); this.showToast("已複製"); } catch (e) { this.showToast("複製失敗"); } document.body.removeChild(ta); } },
            pasteDataFromClipboard() { const raw = prompt("粘貼存檔碼:"); if (!raw) return; try { const imp = JSON.parse(raw); if (Array.isArray(imp)) { imp.forEach(a => { a.id = Date.now().toString() + Math.random().toString().slice(2,5); this.data.push(a); }); this.saveToLocal(); this.renderAdventureList(); alert(`成功讀取 ${imp.length} 個存檔`); } else { alert("格式錯誤"); } } catch (e) { alert("無效代碼"); } },
            renderAdventureList() { const l = document.getElementById('adventure-list'); l.innerHTML = ''; this.data.forEach(adv => { const el = document.createElement('div'); el.className = `bg-[#1f2335] border ${adv.id === this.currentId ? 'border-[#ff9e64] bg-opacity-80' : 'border-[#292e42]'} rounded-lg p-3 cursor-pointer relative group hover:border-[#414868] transition-all`; el.onclick = () => { this.loadAdventure(adv.id); this.enterDashboard(); this.switchTab('settings'); }; el.innerHTML = `<div class="flex justify-between items-center"><div class="flex-1"><h3 class="font-bold text-[#c0caf5] text-sm mb-1">${adv.title || '未命名冒险'}</h3><p class="text-xs text-[#565f89]">${adv.charName || '未知角色'}</p></div><div class="flex items-center gap-2"><button onclick="event.stopPropagation(); App.enterChat('${adv.id}')" class="w-10 h-10 rounded-full bg-[#ff9e64] text-[#1a1b26] flex items-center justify-center hover:scale-110 transition-transform shadow-lg z-10"><i class="fa-solid fa-play ml-1 text-lg pointer-events-none"></i></button><button onclick="event.stopPropagation(); App.deleteAdventure('${adv.id}')" class="text-[#565f89] hover:text-red-400 p-2 z-10"><i class="fa-solid fa-trash-can pointer-events-none"></i></button></div></div>`; l.appendChild(el); }); },
            switchTab(t) { document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); document.getElementById(`nav-${t}`).classList.add('active'); ['adventure', 'settings', 'system'].forEach(p => { document.getElementById(`page-${p}`).style.display = (p === t) ? 'block' : 'none'; }); }
        };
        window.onload = () => App.init();
    </script>
</body>
</html>
