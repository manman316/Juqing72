<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>控制台 (SETTINGS) - 黎梨 V66.2 泰坦精修版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- V66 核心变量 --- */
        :root {
            --chat-font-size: 15px;
            --chat-line-height: 1.625;
            --chat-text-color: #c0caf5;
            --chat-font-weight: 300;
        }

        /* [CSS Firewall] 强制锁定背景 */
        body { 
            font-family: 'Noto Sans SC', sans-serif; 
            background-color: #000 !important; 
            color: #a9b1d6; 
            overflow: hidden; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        /* 强制聊天文字颜色，但【排除】卡片内部 */
        .dynamic-text {
            font-size: var(--chat-font-size);
            line-height: var(--chat-line-height);
            color: var(--chat-text-color) !important;
            font-weight: var(--chat-font-weight);
            transition: all 0.2s ease;
        }

        /* [关键修复] 给卡片开特权通道 */
        .lq-scope-standalone, .lq-scope-standalone * {
            /* 允许卡片自定义颜色，不受全局锁影响 */
            color: inherit; 
            /* 允许卡片自定义行高 (解决顶部空白问题的核心) */
            line-height: inherit; 
        }

        /* [关键修复] 引擎层强制修正卡片布局 */
        .lq-scope-standalone {
            /* 强制居中，对抗 Tailwind 干扰 */
            margin-left: auto !important;
            margin-right: auto !important;
            /* 强制提拉，确保贴顶 */
            margin-top: -20px !important;
            margin-bottom: -10px !important;
            /* 确保是块级显示 */
            display: block !important;
            /* 确保宽度不塌缩 */
            width: calc(100% + 20px) !important;
            max-width: 400px !important;
        }
        
        /* 封面 & 动画 */
        #view-cover { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 1s ease-in-out, transform 1s ease-in-out; }
        .cover-hidden { opacity: 0; transform: scale(1.05); pointer-events: none; }
        #aesthetic-title { position: absolute; top: 15%; right: 12%; writing-mode: vertical-rl; text-orientation: upright; font-family: 'Noto Serif SC', serif; color: rgba(255, 255, 255, 0.9); text-shadow: 2px 2px 8px rgba(0,0,0,0.6); display: flex; gap: 12px; height: 60%; flex-wrap: wrap-reverse; align-content: flex-start; pointer-events: none; }
        .title-line { font-size: 2rem; font-weight: 600; letter-spacing: 0.2em; transition: all 0.5s; }
        .title-line:nth-child(odd) { margin-top: 0; } .title-line:nth-child(even) { margin-top: 40px; }
        .scan-line { position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: rgba(122, 162, 247, 0.8); box-shadow: 0 0 10px #7aa2f7; animation: scan 1.5s ease-in-out infinite; display: none; }
        @keyframes scan { 0% { top: 20%; opacity: 0; } 50% { opacity: 1; } 100% { top: 80%; opacity: 0; } }

        /* Keypad */
        #keypad-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20000; opacity: 0; pointer-events: none; transition: opacity 0.4s ease; }
        #keypad-overlay.active { opacity: 1; pointer-events: auto; }
        .key-btn { width: 72px; height: 72px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); color: rgba(255,255,255,0.9); font-size: 26px; font-weight: 300; display: flex; align-items: center; justify-content: center; transition: all 0.2s; cursor: pointer; backdrop-filter: blur(5px); }
        .key-btn:active { background: rgba(255,255,255,0.25); transform: scale(0.92); border-color: rgba(255,255,255,0.4); }
        .pin-dot { width: 12px; height: 12px; border-radius: 50%; border: 1.5px solid rgba(255,255,255,0.6); transition: all 0.2s; }
        .pin-dot.filled { background: white; border-color: white; box-shadow: 0 0 8px rgba(255,255,255,0.5); }

        /* V66 UI 组件升级 */
        #app-background { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-size: cover; background-position: center; z-index: -1; opacity: 0.15; transition: opacity 0.2s ease; pointer-events: none; }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; } .custom-scroll::-webkit-scrollbar-track { background: rgba(22, 22, 30, 0.1); } .custom-scroll::-webkit-scrollbar-thumb { background: rgba(47, 51, 77, 0.5); border-radius: 2px; }
        .nav-item.active { color: #ff9e64; font-weight: 500; position: relative; } .nav-item.active::after { content: ''; position: absolute; bottom: -12px; left: 0; width: 100%; height: 2px; background-color: #ff9e64; }
        
        .custom-input { background-color: rgba(22, 22, 30, 0.6); border: 1px solid rgba(47, 51, 77, 0.5); color: #c0caf5; transition: all 0.2s; backdrop-filter: blur(8px); } 
        .custom-input:focus { outline: none; border-color: #ff9e64; box-shadow: 0 0 0 1px rgba(255, 158, 100, 0.2); background-color: rgba(22, 22, 30, 0.8); }
        select.custom-input { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; }
        input[type=range] { -webkit-appearance: none; background: transparent; } input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #ff9e64; margin-top: -6px; cursor: pointer; } input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: rgba(47, 51, 77, 0.5); border-radius: 2px; }
        input[type=color] { -webkit-appearance: none; border: none; width: 32px; height: 32px; border-radius: 50%; padding: 0; overflow: hidden; cursor: pointer; } input[type=color]::-webkit-color-swatch-wrapper { padding: 0; } input[type=color]::-webkit-color-swatch { border: none; }
        
        .page-section { display: none; animation: fadeIn 0.3s ease; } .page-section.active { display: block; } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .msg-actions { opacity: 0; transition: opacity 0.2s ease; z-index: 50; pointer-events: none; }
        .message-group:hover .msg-actions, .message-group:active .msg-actions, .message-group.active-touch .msg-actions { opacity: 1; pointer-events: auto; }
        .hidden-file-input { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; opacity: 0; pointer-events: none; }
        .view-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; background-color: transparent; } .view-hidden { display: none !important; }
        .toast-enter { transform: translateY(100%); opacity: 0; } .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 0.3s ease; } .toast-exit { transform: translateY(0); opacity: 1; } .toast-exit-active { transform: translateY(100%); opacity: 0; transition: all 0.3s ease; }
        .preview-thumb { width: 24px; height: 24px; border-radius: 4px; object-fit: cover; border: 1px solid #414868; margin-left: 8px; display: none; } .preview-thumb.show { display: block; }
        .preview-audio-icon { color: #7aa2f7; margin-left: 8px; display: none; cursor: pointer; } .preview-audio-icon.show { display: block; }

        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #ff9e64; }
        .toggle-checkbox:checked + .toggle-label { background-color: #ff9e64; }
        .toggle-switch-container { position: relative; width: 44px; height: 24px; }
        .toggle-label { display: block; overflow: hidden; cursor: pointer; border: 0 solid #bbb; border-radius: 20px; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(36, 40, 59, 0.8); transition: background-color 0.2s; border: 1px solid #414868; }
        .toggle-label:before { content: ""; display: block; width: 18px; height: 18px; margin: 2px; background: #c0caf5; position: absolute; top: 0; bottom: 0; right: 20px; border-radius: 50%; transition: all 0.2s; }
        .toggle-checkbox:checked + .toggle-label:before { right: 0; background-color: #1a1b26; }
        .toggle-checkbox { position: absolute; visibility: hidden; }

        /* Appearance Menu */
        #appearance-menu { position: absolute; top: 56px; right: 10px; width: 260px; background: rgba(31, 35, 53, 0.85); backdrop-filter: blur(20px); border: 1px solid rgba(65, 72, 104, 0.5); border-radius: 12px; padding: 16px; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: none; transform-origin: top right; animation: scaleIn 0.2s ease; }
        #appearance-menu.show { display: block; }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .setting-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .setting-label { font-size: 12px; color: #787c99; font-weight: bold; }
        .setting-btn-group { display: flex; background: rgba(22, 22, 30, 0.5); border-radius: 6px; padding: 2px; border: 1px solid rgba(41, 46, 66, 0.5); gap: 2px; }
        .setting-btn { flex: 1; padding: 4px 8px; font-size: 12px; color: #565f89; border-radius: 4px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .setting-btn.active { background: rgba(59, 66, 97, 0.8); color: #c0caf5; font-weight: bold; }
        
        #input-name-display { cursor: pointer; border-bottom: 1px dashed #565f89; padding-bottom: 1px; transition: color 0.2s; }
        #input-name-display:hover { color: #ff9e64; border-color: #ff9e64; }
    </style>
</head>
<body class="h-screen flex flex-col w-full text-sm relative" ontouchstart="App.unlockAudioEngine()" onclick="App.unlockAudioEngine()">

    <audio id="startup-audio" playsinline preload="auto"></audio>

    <!-- VIEW 0: COVER -->
    <div id="view-cover">
        <div class="absolute inset-0 bg-black bg-opacity-40 backdrop-blur-sm"></div>
        <div id="aesthetic-title"></div>
        <div class="relative z-10 flex flex-col items-center gap-4 mt-32">
            <div id="login-btn" onclick="App.tryUnlock()" class="w-16 h-16 rounded-full border border-white/30 bg-white/10 backdrop-blur-md flex items-center justify-center cursor-pointer hover:bg-white/20 hover:scale-95 active:scale-90 transition-all relative overflow-hidden group tap-highlight-transparent z-50">
                <i class="fa-solid fa-fingerprint text-2xl text-white/80 group-hover:text-white"></i>
                <div id="scan-line" class="scan-line"></div>
            </div>
            <p id="login-text" class="text-[10px] text-gray-400 tracking-widest uppercase font-serif">Touch ID</p>
        </div>
        <div id="keypad-overlay">
            <div class="mb-10 flex gap-4 transform scale-110"><div class="pin-dot" id="dot-1"></div><div class="pin-dot" id="dot-2"></div><div class="pin-dot" id="dot-3"></div><div class="pin-dot" id="dot-4"></div></div>
            <div class="grid grid-cols-3 gap-x-8 gap-y-6"><div class="key-btn" onclick="App.inputPin(1)">1</div><div class="key-btn" onclick="App.inputPin(2)">2</div><div class="key-btn" onclick="App.inputPin(3)">3</div><div class="key-btn" onclick="App.inputPin(4)">4</div><div class="key-btn" onclick="App.inputPin(5)">5</div><div class="key-btn" onclick="App.inputPin(6)">6</div><div class="key-btn" onclick="App.inputPin(7)">7</div><div class="key-btn" onclick="App.inputPin(8)">8</div><div class="key-btn" onclick="App.inputPin(9)">9</div><div class="key-btn text-xl" onclick="App.cancelPin()"><i class="fa-solid fa-arrow-left"></i></div><div class="key-btn" onclick="App.inputPin(0)">0</div><div class="key-btn text-xl" onclick="App.clearPin()"><i class="fa-solid fa-delete-left"></i></div></div>
            <div class="mt-12 text-white/40 text-[10px] tracking-[0.3em] font-serif">VERIFICATION REQUIRED</div>
        </div>
        <div class="absolute bottom-8 text-[10px] text-gray-500 tracking-widest font-serif opacity-50">SYSTEM V66.2 TITANIUM REFINED</div>
    </div>

    <!-- V66: Global Background -->
    <div id="app-background"></div>

    <!-- VIEW A: DASHBOARD -->
    <div id="view-dashboard" class="view-container view-hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm -z-10"></div>
        <header class="h-14 bg-[#1f2335]/70 backdrop-blur-md flex items-center justify-between px-4 border-b border-[#16161e]/50 shrink-0 z-50 shadow-sm">
            <div class="flex items-center gap-3"><i class="fa-solid fa-book-journal-whills text-[#ff9e64] text-lg"></i><span class="font-bold text-lg text-[#c0caf5]">剧本库</span></div>
            <button class="text-[#565f89] hover:text-[#ff9e64] transition-colors" onclick="App.manualSave()" title="强制保存"><i class="fa-solid fa-check text-xl"></i></button>
        </header>
        <nav class="h-12 bg-[#1f2335]/60 backdrop-blur-md flex items-center justify-around border-b border-[#292e42]/50 shrink-0 text-[#787c99]">
            <div class="nav-item active w-1/3 text-center py-3 cursor-pointer" onclick="App.switchTab('adventure')" id="nav-adventure">剧本</div>
            <div class="nav-item w-1/3 text-center py-3 cursor-pointer" onclick="App.switchTab('system')" id="nav-system">系统</div>
        </nav>
        <main class="flex-1 overflow-y-auto custom-scroll relative">
            <div id="page-adventure" class="page-section p-4 space-y-4 pb-24">
                <div onclick="App.createNewScript()" class="border-2 border-dashed border-[#3b4261]/80 rounded-lg h-16 flex items-center justify-center cursor-pointer text-[#7aa2f7] hover:text-[#ff9e64] hover:border-[#ff9e64] transition-all bg-[#1a1b26]/60 hover:bg-[#1f2335]/80 backdrop-blur-sm"><div class="flex items-center gap-2"><i class="fa-solid fa-feather-pointed"></i><span class="font-medium">创作新剧本 (NEW SCRIPT)</span></div></div>
                <div id="script-list" class="space-y-3"></div>
                <div class="pt-6 border-t border-[#292e42]/50 mt-6"><label class="text-xs font-bold text-[#565f89] uppercase mb-3 block">数据管理</label><div class="flex gap-3"><button onclick="App.exportData()" class="flex-1 bg-[#24283b]/80 hover:bg-[#2f334d] text-[#c0caf5] py-2 rounded border border-[#414868]/50 flex items-center justify-center gap-2 transition-colors backdrop-blur-sm"><i class="fa-solid fa-file-export text-[#7aa2f7]"></i> 备份</button><button onclick="document.getElementById('file-backup-import').click()" class="flex-1 bg-[#24283b]/80 hover:bg-[#2f334d] text-[#c0caf5] py-2 rounded border border-[#414868]/50 flex items-center justify-center gap-2 transition-colors backdrop-blur-sm"><i class="fa-solid fa-file-import text-[#ff9e64]"></i> 恢复</button><input type="file" id="file-backup-import" accept=".json" class="hidden-file-input" onchange="App.importData(this)"></div></div>
            </div>
            
            <div id="page-system" class="hidden p-4 space-y-6">
                <div class="space-y-4 border-b border-[#292e42]/50 pb-6">
                    <label class="text-xs font-bold text-[#bb9af7] uppercase tracking-wider flex items-center gap-2"><i class="fa-solid fa-wand-magic-sparkles"></i> 門戶與個性化</label>
                    <div class="flex justify-between items-center"><span class="text-[10px] text-[#7a85b8] flex items-center gap-2">全局壁紙 <img id="preview-bg" class="preview-thumb"></span><div class="flex gap-2"><label class="cursor-pointer text-[10px] bg-[#24283b]/80 px-2 py-1 rounded border border-[#414868]/50 text-[#c0caf5]">上傳<input type="file" id="file-bg-upload" accept="image/*" class="hidden-file-input" onchange="App.handleBgUpload(this)"></label><button onclick="App.clearBackground()" class="text-[10px] bg-[#24283b]/80 px-2 py-1 rounded border border-[#414868]/50 text-red-400">清除</button></div></div>
                    
                    <!-- [NEW] 背景浓度滑块 -->
                    <div class="space-y-2 px-1">
                        <div class="flex justify-between text-[10px] text-[#7a85b8]"><span>背景圖浓度</span><span class="text-[#ff9e64] font-mono" id="disp-bg-opacity">15%</span></div>
                        <input type="range" min="0" max="100" step="1" value="15" id="input-bg-opacity" oninput="document.getElementById('disp-bg-opacity').innerText = this.value + '%'; App.updateBgOpacity(this.value); App.saveSystemSettings()">
                    </div>

                    <div class="flex justify-between items-center"><span class="text-[10px] text-[#7a85b8] flex items-center gap-2">封面圖片 <img id="preview-cover" class="preview-thumb"></span><div class="flex gap-2"><label class="cursor-pointer text-[10px] bg-[#24283b]/80 px-2 py-1 rounded border border-[#414868]/50 text-[#c0caf5]">上傳<input type="file" id="file-cover-upload" accept="image/*" class="hidden-file-input" onchange="App.handleCoverUpload(this)"></label><button onclick="App.clearCover()" class="text-[10px] bg-[#24283b]/80 px-2 py-1 rounded border border-[#414868]/50 text-red-400">重置</button></div></div>
                    <div class="flex justify-between items-center"><span class="text-[10px] text-[#7a85b8] flex items-center gap-2">啟動音效 <i id="preview-audio-icon" class="fa-solid fa-play-circle preview-audio-icon" onclick="document.getElementById('startup-audio').play()"></i></span><div class="flex gap-2"><label class="cursor-pointer text-[10px] bg-[#24283b]/80 px-2 py-1 rounded border border-[#414868]/50 text-[#c0caf5]">上傳<input type="file" id="file-audio-upload" accept="audio/*,video/*" class="hidden-file-input" onchange="App.handleAudioUpload(this)"></label><button onclick="App.clearAudio()" class="text-[10px] bg-[#24283b]/80 px-2 py-1 rounded border border-[#414868]/50 text-red-400">默認</button></div></div>
                    <div class="space-y-1"><span class="text-[10px] text-[#7a85b8]">歡迎詞</span><textarea id="input-welcome-text" class="custom-input w-full p-2 rounded text-xs" rows="2" placeholder="以文為碼，重構森羅萬象" oninput="App.saveSystemSettings()"></textarea></div>
                    <div class="space-y-1"><span class="text-[10px] text-[#7a85b8]">安全鎖密碼 <i id="lock-status" class="fa-solid fa-unlock text-[10px] ml-2 text-gray-500"></i></span><input type="number" id="input-passcode" class="custom-input w-full p-2 rounded text-xs font-mono" placeholder="留空則不啟用" oninput="if(this.value.length>4) this.value=this.value.slice(0,4); App.saveSystemSettings(); App.updateLockIcon()"></div>
                </div>
                <div class="space-y-4 border-b border-[#292e42]/50 pb-6">
                    <label class="text-xs font-bold text-[#7aa2f7] uppercase tracking-wider flex items-center gap-2"><i class="fa-solid fa-network-wired"></i> API 連接</label>
                    <div class="space-y-1"><p class="text-[10px] text-[#7a85b8]">API 地址</p><input type="text" id="input-api-url" class="custom-input w-full p-3 rounded-md text-sm font-mono text-[#9aa5ce]" placeholder="https://generativelanguage.googleapis.com/v1beta" oninput="App.saveSystemSettings()"></div>
                    <div class="space-y-1"><p class="text-[10px] text-[#7a85b8]">API 密鑰</p><input type="password" id="input-api-key" class="custom-input w-full p-3 rounded-md text-sm font-mono text-[#9aa5ce]" placeholder="AIzaSy..." oninput="App.saveSystemSettings()"></div>
                    <div class="space-y-1"><p class="text-[10px] text-[#7a85b8]">AI 模型</p><div class="flex gap-2"><select id="select-model" class="custom-input flex-1 p-3 rounded-md text-sm font-mono text-[#ff9e64] bg-[#16161e]/50" onchange="App.saveSystemSettings()"><option value="" disabled selected>請點擊刷新...</option></select><button onclick="App.fetchModels()" class="bg-[#24283b]/80 hover:bg-[#2f334d] text-[#c0caf5] px-4 rounded border border-[#414868]/50 transition-colors"><i class="fa-solid fa-arrows-rotate pointer-events-none"></i></button></div></div>
                </div>
                <div class="space-y-6 px-2">
                    <div class="space-y-2"><div class="flex justify-between text-sm font-bold text-[#c0caf5]"><span>AI 隨機性</span><span class="text-[#ff9e64] font-mono" id="disp-temp">0.9</span></div><input type="range" min="0" max="2" step="0.01" value="0.9" id="input-temp" oninput="document.getElementById('disp-temp').innerText = this.value; App.saveSystemSettings()"></div>
                    <div class="space-y-2"><div class="flex justify-between text-sm font-bold text-[#c0caf5]"><span>回復長度</span><span class="text-[#ff9e64] font-mono" id="disp-tokens">65536</span></div><input type="range" min="200" max="65536" step="128" value="65536" id="input-tokens" oninput="document.getElementById('disp-tokens').innerText = this.value; App.saveSystemSettings()"></div>
                    <div class="space-y-2"><div class="flex justify-between text-sm font-bold text-[#c0caf5]"><span>上下文記憶 (條數)</span><span class="text-[#ff9e64] font-mono" id="disp-context">20</span></div><input type="range" min="5" max="100" step="1" value="20" id="input-context" oninput="document.getElementById('disp-context').innerText = this.value; App.saveSystemSettings()"></div>
                </div>
                <div class="pt-6 border-t border-[#292e42]/50 mt-4 flex items-center justify-between">
                    <div>
                        <span class="text-sm font-bold text-[#ff9e64] block">沈浸式劇場模式 Pro</span>
                        <span class="text-[10px] text-[#565f89]">THEATRE: 強制AI生成精美卡片</span>
                    </div>
                    <div class="toggle-switch-container">
                        <input type="checkbox" id="theatre-mode-toggle" class="toggle-checkbox" onchange="App.saveSystemSettings()">
                        <label for="theatre-mode-toggle" class="toggle-label"></label>
                    </div>
                </div>
                <div class="h-24"></div>
            </div>
        </main>
    </div>

    <!-- VIEW B: SCRIPT SETTINGS -->
    <div id="view-settings" class="view-container view-hidden">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-md -z-10"></div>
        <header class="h-14 bg-[#1f2335]/70 backdrop-blur-md flex items-center justify-between px-4 border-b border-[#16161e]/50 shrink-0 z-50 shadow-sm">
            <div class="flex items-center gap-3">
                <button onclick="App.enterDashboard()" class="text-[#787c99] hover:text-[#c0caf5]"><i class="fa-solid fa-arrow-left"></i></button>
                <i class="fa-solid fa-sliders text-[#bb9af7] text-lg"></i>
                <span class="font-bold text-lg text-[#c0caf5]">設定</span>
            </div>
            <button onclick="App.manualSave()" class="text-[#7aa2f7] hover:text-[#ff9e64] flex items-center gap-2 px-3 py-1 rounded bg-[#16161e]/50 border border-[#2f334d]/50 transition-colors"><i class="fa-solid fa-check"></i><span class="text-xs font-bold">保存</span></button>
        </header>
        <main class="flex-1 overflow-y-auto custom-scroll relative">
            <div class="p-4 pb-24 space-y-6">
                <div class="space-y-2"><label class="text-xs font-bold text-[#ff9e64] uppercase tracking-wider">剧本标题</label><input type="text" id="input-title" class="custom-input w-full p-3 rounded-md text-sm font-bold" oninput="App.updateScriptData('title', this.value)"></div>
                <div class="space-y-3"><div class="flex justify-between items-end"><label class="text-xs font-bold text-[#ff9e64] uppercase tracking-wider flex items-center gap-2"><i class="fa-solid fa-user"></i> 角色卡</label><label class="cursor-pointer bg-[#24283b]/80 hover:bg-[#2f334d] text-[10px] text-[#c0caf5] px-3 py-1.5 rounded border border-[#414868]/50 transition-colors flex items-center gap-1"><i class="fa-solid fa-upload"></i> 导入JSON<input type="file" id="file-char-import" class="hidden-file-input" onchange="App.handleFileImport(this, 'character')"></label></div><div class="bg-[#1f2335]/60 backdrop-blur-sm rounded-lg p-3 border border-[#292e42]/50"><div class="flex gap-3 mb-3"><label class="w-16 h-16 shrink-0 bg-[#1a1b26]/50 rounded-md relative overflow-hidden group cursor-pointer border border-[#414868]/50 hover:border-[#ff9e64]"><img id="img-char-avatar" class="w-full h-full object-cover hidden"><div id="ph-char-avatar" class="absolute inset-0 flex flex-col items-center justify-center text-[#565f89] group-hover:text-[#ff9e64]"><i class="fa-solid fa-camera text-sm"></i></div><input type="file" id="file-char-avatar" accept="image/*" class="hidden-file-input" onchange="App.handleImageUpload(this, 'charAvatar')"></label><div class="flex-1 flex flex-col justify-center gap-2"><input type="text" id="input-char-name" class="custom-input p-2 rounded text-sm w-full font-bold" placeholder="角色名称" oninput="App.updateScriptData('charName', this.value)"></div></div><div class="mt-3"><div class="flex justify-between mb-1"><p class="text-[10px] text-[#7a85b8]">人设描述</p><div class="flex gap-2"><button onclick="App.clearInput('input-char-desc')" class="text-[#565f89] hover:text-red-400 text-xs px-2 py-1"><i class="fa-solid fa-trash-can pointer-events-none"></i></button><button onclick="App.openFullscreen('input-char-desc', '人设描述')" class="text-[#565f89] hover:text-[#ff9e64] text-xs px-2 py-1"><i class="fa-solid fa-expand pointer-events-none"></i></button></div></div><textarea id="input-char-desc" class="custom-input w-full p-2 rounded text-xs leading-relaxed h-24 resize-none" oninput="App.updateScriptData('charDesc', this.value)"></textarea></div><div class="mt-3"><div class="flex justify-between mb-1"><p class="text-[10px] text-[#7a85b8]">开场白 (支持HTML)</p><div class="flex gap-2"><button onclick="App.clearInput('input-first-mes')" class="text-[#565f89] hover:text-red-400 text-xs px-2 py-1"><i class="fa-solid fa-trash-can pointer-events-none"></i></button><button onclick="App.openFullscreen('input-first-mes', '开场白')" class="text-[#565f89] hover:text-[#ff9e64] text-xs px-2 py-1"><i class="fa-solid fa-expand pointer-events-none"></i></button></div></div><textarea id="input-first-mes" class="custom-input w-full p-2 rounded text-xs leading-relaxed h-20 resize-none" oninput="App.updateScriptData('firstMes', this.value)"></textarea></div></div></div>
                <div class="space-y-3"><div class="flex justify-between items-end"><label class="text-xs font-bold text-[#ff9e64] uppercase tracking-wider flex items-center gap-2"><i class="fa-solid fa-globe"></i> 世界观</label><label class="cursor-pointer bg-[#24283b]/80 hover:bg-[#2f334d] text-[10px] text-[#c0caf5] px-3 py-1.5 rounded border border-[#414868]/50 transition-colors flex items-center gap-1"><i class="fa-solid fa-file-import pointer-events-none"></i> 导入<input type="file" id="file-world-import" accept=".json,.txt" class="hidden-file-input" onchange="App.handleFileImport(this, 'world')"></label></div><div class="bg-[#1f2335]/60 backdrop-blur-sm rounded-lg p-3 border border-[#292e42]/50 space-y-3"><div><div class="flex justify-between mb-1"><p class="text-[10px] text-[#7a85b8]">世界背景</p><div class="flex gap-2"><button onclick="App.clearInput('input-world-scenario')" class="text-[#565f89] hover:text-red-400 text-xs px-2 py-1"><i class="fa-solid fa-trash-can pointer-events-none"></i></button><button onclick="App.openFullscreen('input-world-scenario', '世界背景')" class="text-[#565f89] hover:text-[#ff9e64] text-xs px-2 py-1"><i class="fa-solid fa-expand pointer-events-none"></i></button></div></div><textarea id="input-world-scenario" class="custom-input w-full p-2 rounded text-xs leading-relaxed h-24 resize-none font-mono text-[#9aa5ce]" oninput="App.updateScriptData('worldScenario', this.value)"></textarea></div></div></div>
                <div class="space-y-3"><div class="flex justify-between items-end"><label class="text-xs font-bold text-[#bb9af7] uppercase tracking-wider flex items-center gap-2"><i class="fa-solid fa-sliders"></i> 高级预设</label></div><div class="relative bg-[#1f2335]/60 backdrop-blur-sm p-2 rounded border border-[#292e42]/50 flex gap-2"><label class="w-10 h-10 shrink-0 bg-[#2f334d]/80 rounded-full relative overflow-hidden group cursor-pointer"><img id="img-user-avatar" class="w-full h-full object-cover hidden"><div id="ph-user-avatar" class="absolute inset-0 flex items-center justify-center text-[#7aa2f7]"><i class="fa-solid fa-user pointer-events-none"></i></div><input type="file" id="file-user-avatar" accept="image/*" class="hidden-file-input" onchange="App.handleImageUpload(this, 'userAvatar')"></label><div class="flex-1"><div class="flex justify-between mb-1"><p class="text-[10px] text-[#7a85b8]">玩家设定 (YOU)</p><div class="flex gap-2"><button onclick="App.clearInput('input-user-persona')" class="text-[#565f89] hover:text-red-400 text-xs px-2 py-1"><i class="fa-solid fa-trash-can pointer-events-none"></i></button><button onclick="App.openFullscreen('input-user-persona', '玩家设定')" class="text-[#565f89] hover:text-[#ff9e64] text-xs px-2 py-1"><i class="fa-solid fa-expand pointer-events-none"></i></button></div></div><textarea id="input-user-persona" class="custom-input w-full p-2 rounded text-xs leading-relaxed h-12 resize-none" oninput="App.updateScriptData('userPersona', this.value)"></textarea></div></div><div class="relative"><div class="flex justify-between items-end mb-1 ml-1"><p class="text-[10px] text-[#7a85b8]">破限 (JAILBREAK)</p><div class="flex gap-2 items-center"><label class="cursor-pointer bg-[#24283b]/80 hover:bg-[#2f334d] text-[10px] text-[#c0caf5] px-2 py-0.5 rounded border border-[#414868]/50 transition-colors flex items-center gap-1 mr-2"><i class="fa-solid fa-folder-open pointer-events-none"></i> 批量导入<input type="file" id="file-preset-raw" multiple class="hidden-file-input" onchange="App.handleRawPresetUpload(this)"></label><button onclick="App.clearInput('input-jailbreak')" class="text-[#565f89] hover:text-red-400 text-xs px-2 py-1"><i class="fa-solid fa-trash-can pointer-events-none"></i></button><button onclick="App.openFullscreen('input-jailbreak', '破限设置')" class="text-[#565f89] hover:text-[#ff9e64] text-xs px-2 py-1"><i class="fa-solid fa-expand pointer-events-none"></i></button></div></div><textarea id="input-jailbreak" class="custom-input w-full p-2 rounded text-[10px] font-mono leading-relaxed h-32 resize-none text-[#73daca]" oninput="App.updateScriptData('jailbreak', this.value)"></textarea></div></div>

                <div class="pt-8 border-t border-[#292e42]/50 mt-8">
                    <label class="text-xs font-bold text-[#7aa2f7] uppercase tracking-wider flex items-center gap-2 mb-4"><i class="fa-solid fa-clock-rotate-left"></i> 时间线 (SAVES)</label>
                    <div onclick="App.createNewSave()" class="border border-dashed border-[#3b4261]/80 rounded-lg h-12 flex items-center justify-center cursor-pointer text-[#7aa2f7] hover:text-[#ff9e64] hover:border-[#ff9e64] transition-all bg-[#1f2335]/60 mb-4 text-xs backdrop-blur-sm"><div class="flex items-center gap-2"><i class="fa-solid fa-play"></i><span class="font-medium">開啟新輪迴 / 此時此刻</span></div></div>
                    <div id="save-list" class="space-y-2"></div>
                </div>
                <div class="h-24"></div>
            </div>
        </main>
    </div>

    <!-- VIEW C: CHAT -->
    <div id="view-chat" class="view-container view-hidden fade-in relative">
        <div class="h-14 bg-[#1f2335]/70 backdrop-blur-md flex items-center justify-between px-4 border-b border-[#16161e]/30 shrink-0 shadow-sm relative z-50">
             <div class="flex items-center gap-3"><button onclick="App.backToSettings()" class="text-[#565f89] hover:text-[#ff9e64] flex items-center gap-2 transition-colors group"><i class="fa-solid fa-arrow-left text-lg"></i><span class="font-bold text-sm">設定</span></button></div>
             <div class="absolute left-1/2 transform -translate-x-1/2 text-center pointer-events-none"><h3 id="chat-title" class="font-bold text-[#c0caf5] text-sm shadow-black drop-shadow-md">...</h3><div class="flex items-center justify-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-green-500"></span><span class="text-[10px] text-[#7a85b8]">Online</span></div></div>
            <div class="flex gap-3 items-center">
                <button onclick="App.toggleAppearanceMenu()" class="text-[#565f89] hover:text-[#ff9e64] w-8 h-8 flex items-center justify-center rounded transition-colors"><i class="fa-solid fa-font text-sm"></i></button>
                <img id="chat-header-avatar" class="w-8 h-8 rounded-full border border-[#2f334d]/50 bg-[#1a1b26]/50 object-cover">
            </div>
        </div>

        <div id="appearance-menu">
            <div class="setting-row">
                <span class="setting-label">字號</span>
                <div class="setting-btn-group w-32"><div class="setting-btn" onclick="App.updateAppearance('fontSize', '13px')">小</div><div class="setting-btn active" onclick="App.updateAppearance('fontSize', '15px')" data-val="15px">中</div><div class="setting-btn" onclick="App.updateAppearance('fontSize', '17px')">大</div><div class="setting-btn" onclick="App.updateAppearance('fontSize', '20px')">特</div></div>
            </div>
            <div class="setting-row">
                <span class="setting-label">行距</span>
                <div class="setting-btn-group w-32"><div class="setting-btn" onclick="App.updateAppearance('lineHeight', '1.4')">密</div><div class="setting-btn active" onclick="App.updateAppearance('lineHeight', '1.625')" data-val="1.625">適</div><div class="setting-btn" onclick="App.updateAppearance('lineHeight', '2.0')">寬</div></div>
            </div>
            <div class="setting-row">
                <span class="setting-label">濃度</span>
                <div class="setting-btn-group w-32"><div class="setting-btn active" onclick="App.updateAppearance('fontWeight', '300')" data-mode="normal">标准</div><div class="setting-btn" onclick="App.updateAppearance('fontWeight', '400')">加粗</div></div>
            </div>
            <!-- [NEW] 字体颜色选择器 -->
            <div class="setting-row">
                <span class="setting-label">颜色</span>
                <div class="flex items-center gap-2">
                    <div class="setting-btn-group flex-1">
                        <div class="setting-btn active" onclick="App.updateAppearance('color', '#c0caf5')">蓝灰</div>
                        <div class="setting-btn" onclick="App.updateAppearance('color', '#ffffff')">纯白</div>
                        <div class="setting-btn" onclick="App.updateAppearance('color', '#e0af68')">金沙</div>
                    </div>
                    <input type="color" id="color-picker" value="#c0caf5" oninput="App.updateAppearance('color', this.value)">
                </div>
            </div>
        </div>
        
        <div class="absolute right-4 bottom-24 flex flex-col gap-2 z-40">
            <button onclick="App.scrollToTop()" class="w-8 h-8 rounded-full bg-[#1f2335]/70 backdrop-blur-md border border-[#292e42]/50 text-[#565f89] flex items-center justify-center shadow-lg hover:text-[#ff9e64] active:scale-90"><i class="fa-solid fa-arrow-up"></i></button>
            <button onclick="App.scrollToBottom()" class="w-8 h-8 rounded-full bg-[#1f2335]/70 backdrop-blur-md border border-[#292e42]/50 text-[#565f89] flex items-center justify-center shadow-lg hover:text-[#ff9e64] active:scale-90"><i class="fa-solid fa-arrow-down"></i></button>
        </div>

        <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 custom-scroll message-content" style="padding-bottom: 120px;"></div>
        
        <div class="p-3 bg-[#1a1b26]/70 backdrop-blur-xl border-t border-[#16161e]/30 shrink-0">
            <div class="flex justify-end mb-2 gap-2">
                <span id="input-name-display" class="text-[10px] text-[#7a85b8] self-center mr-auto ml-2 font-mono" onclick="App.renameIdentity()">YOU</span>
                <button onclick="App.sendHiddenContinue()" class="text-[10px] text-[#565f89] hover:text-[#ff9e64] border border-[#2f334d] rounded px-2 py-1 bg-[#1f2335]/50 flex items-center gap-1"><i class="fa-solid fa-forward"></i> ⏩ 續寫</button>
            </div>
            
            <div class="relative flex items-center gap-2">
                <button onclick="App.regenerateResponse()" class="w-10 h-10 rounded-full bg-[#24283b]/80 backdrop-blur-md text-[#ff9e64] border border-[#414868]/50 flex items-center justify-center hover:bg-[#2f334d] shrink-0 active:scale-90 transition-transform" title="重新生成"><i class="fa-solid fa-arrows-rotate pointer-events-none"></i></button>
                <div class="relative w-full">
                    <textarea id="chat-input" class="w-full bg-[#16161e]/60 backdrop-blur-md text-[#c0caf5] rounded-xl p-3 pr-10 text-sm border border-[#2f334d]/50 focus:border-[#ff9e64] outline-none resize-none min-h-[48px] max-h-[150px] overflow-y-auto custom-scroll" placeholder="发消息..." oninput="App.autoResizeInput(this); App.updateCharCount(this)"></textarea>
                    <span id="char-count" class="absolute top-[-18px] right-1 text-[10px] text-[#565f89] font-mono">0 chars</span>
                </div>
                <button onclick="App.sendUserMessage()" class="absolute right-2 bottom-2.5 text-[#ff9e64] p-2 hover:scale-110 transition-transform"><i class="fa-solid fa-paper-plane pointer-events-none"></i></button>
            </div>
        </div>
    </div>

    <div id="fullscreen-editor" class="fixed inset-0 bg-[#1a1b26]/90 backdrop-blur-xl z-[100] hidden flex-col">
        <div class="h-12 bg-[#1f2335]/70 flex items-center justify-between px-4 border-b border-[#292e42]/50"><span id="fs-title" class="font-bold text-[#ff9e64]">正在编辑</span><button onclick="App.closeFullscreen()" class="text-[#7aa2f7] text-sm font-bold">完成</button></div>
        <textarea id="fs-textarea" class="flex-1 bg-transparent text-[#c0caf5] p-4 outline-none resize-none font-mono text-sm leading-relaxed"></textarea>
    </div>
    <div id="toast-container" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 z-[200]"></div>

    <script>
        const AssetDB = {
            db: null,
            init() { return new Promise((res, rej) => { const r = indexedDB.open("RP_Assets_DB", 2); r.onupgradeneeded = (e) => { const d = e.target.result; if (!d.objectStoreNames.contains("assets")) d.createObjectStore("assets"); }; r.onsuccess = (e) => { this.db = e.target.result; res(); }; r.onerror = (e) => rej(e); }); },
            async save(k, d) { if (!this.db) await this.init(); return new Promise((res, rej) => { const tx = this.db.transaction(["assets"], "readwrite"); tx.objectStore("assets").put(d, k); tx.oncomplete = res; tx.onerror = rej; }); },
            async get(k) { if (!this.db) await this.init(); return new Promise((res, rej) => { const tx = this.db.transaction(["assets"], "readonly"); const r = tx.objectStore("assets").get(k); r.onsuccess = () => res(r.result); r.onerror = rej; }); },
            async delete(k) { if (!this.db) await this.init(); return new Promise((res, rej) => { const tx = this.db.transaction(["assets"], "readwrite"); tx.objectStore("assets").delete(k); tx.oncomplete = res; }); }
        };

        window.triggerScenario = (text) => { App.handleCardSelection(text); };

        const App = {
            data: [], currentScriptId: null, currentSaveId: null, fsTargetId: null, editMsgIndex: null, currentPin: "", audioUnlocked: false,
            currentIdentity: "YOU",
            dataLoaded: false,

            async init() {
                try { 
                    try { await AssetDB.init(); } catch(e) { console.warn("DB Fail", e); } 
                    const newData = await AssetDB.get('roleplay_saves_v50'); 
                    
                    if (newData && Array.isArray(newData)) { 
                        this.data = newData; 
                        this.dataLoaded = true; 
                    } else { 
                        const oldData = localStorage.getItem('roleplay_saves_v2');
                        if(oldData) {
                             try {
                                const oldList = JSON.parse(oldData);
                                this.data = oldList.map(adv => ({
                                    id: adv.id, title: adv.title, charName: adv.charName, charDesc: adv.charDesc, firstMes: adv.firstMes, worldScenario: adv.worldScenario, userPersona: adv.userPersona, jailbreak: adv.jailbreak, charAvatar: adv.charAvatar, userAvatar: adv.userAvatar,
                                    saves: [{ id: Date.now().toString() + Math.random().toString().slice(2,5), title: "默認时间线", timestamp: Date.now(), chatHistory: adv.chatHistory || [] }]
                                }));
                                this.dataLoaded = true;
                                await this.saveToLocal(); 
                             } catch(e) { console.error("Migration failed", e); }
                        }
                    }
                } catch (e) { 
                    console.error("Critical Init Error", e);
                    alert("数据加载异常，请刷新重试。若持续报错请联系开发者。");
                    return; 
                }
                
                if (this.dataLoaded && this.data.length === 0) {
                    this.createNewScript("默認剧本");
                }
                
                try { await this.loadAudioSettings(); } catch(e) { console.warn("Audio load error:", e); } 
                try { this.loadSystemSettings(); } catch(e){}
                try { this.loadBackground(); } catch(e){}
                try { this.loadCoverSettings(); } catch(e){}
                try { this.loadAppearanceSettings(); } catch(e){}
                
                this.renderScriptList(); 
                this.switchTab('adventure'); 
                document.getElementById('chat-container').addEventListener('click', (e) => { document.querySelectorAll('.message-group').forEach(el => el.classList.remove('active-touch')); const bubble = e.target.closest('.message-group'); if (bubble) bubble.classList.add('active-touch'); });
                document.addEventListener('click', (e) => { if(!e.target.closest('#appearance-menu') && !e.target.closest('button[onclick="App.toggleAppearanceMenu()"]')) { document.getElementById('appearance-menu').classList.remove('show'); }});
                this.updatePreviewThumb('bg_image', 'preview-bg'); this.updatePreviewThumb('cover_image', 'preview-cover'); this.updateAudioPreview();
            },

            async saveToLocal() { 
                if(!this.dataLoaded) { console.warn("Prevented overwrite: Data not loaded."); return; }
                try { await AssetDB.save('roleplay_saves_v50', this.data); } catch (e) { console.error(e); } 
            },
            async manualSave() { 
                if(!this.dataLoaded) return alert("数据未加载，无法保存");
                try { await AssetDB.save('roleplay_saves_v50', this.data); this.showToast("✅ 強制保存成功"); } catch(e) { this.showToast("❌ 保存失敗"); } 
            },
            
            saveSystemSettings() {
                const s = JSON.parse(localStorage.getItem('roleplay_api_settings')) || {};
                s.url = document.getElementById('input-api-url').value;
                s.key = document.getElementById('input-api-key').value;
                s.model = document.getElementById('select-model').value;
                s.temp = document.getElementById('input-temp').value;
                s.tokens = document.getElementById('input-tokens').value;
                s.context = document.getElementById('input-context').value;
                s.welcomeText = document.getElementById('input-welcome-text').value;
                s.passcode = document.getElementById('input-passcode').value;
                s.theatreMode = document.getElementById('theatre-mode-toggle').checked;
                s.bgOpacity = document.getElementById('input-bg-opacity').value;
                localStorage.setItem('roleplay_api_settings', JSON.stringify(s));
            },

            loadSystemSettings() {
                const s = JSON.parse(localStorage.getItem('roleplay_api_settings')) || { url: '', key: '', model: '', temp: 0.9, tokens: 65536, context: 20, bgOpacity: 15 };
                if(s.url) document.getElementById('input-api-url').value = s.url;
                if(s.key) document.getElementById('input-api-key').value = s.key;
                if(s.model) {
                    const sel = document.getElementById('select-model');
                    sel.innerHTML = `<option value="${s.model}">${s.model}</option>`;
                    sel.value = s.model;
                }
                if(s.temp) { document.getElementById('input-temp').value = s.temp; document.getElementById('disp-temp').innerText = s.temp; }
                if(s.tokens) { document.getElementById('input-tokens').value = s.tokens; document.getElementById('disp-tokens').innerText = s.tokens; }
                if(s.context) { document.getElementById('input-context').value = s.context; document.getElementById('disp-context').innerText = s.context; }
                if(s.welcomeText) document.getElementById('input-welcome-text').value = s.welcomeText;
                if(s.passcode) document.getElementById('input-passcode').value = s.passcode;
                if(s.theatreMode !== undefined) document.getElementById('theatre-mode-toggle').checked = s.theatreMode;
                
                // Opacity Init
                const op = s.bgOpacity !== undefined ? s.bgOpacity : 15;
                document.getElementById('input-bg-opacity').value = op;
                document.getElementById('disp-bg-opacity').innerText = op + '%';
                this.updateBgOpacity(op);

                this.renderAestheticTitle(s.welcomeText);
                this.updateLockIcon();
            },
            
            updateBgOpacity(val) {
                const el = document.getElementById('app-background');
                el.style.opacity = val / 100;
            },
            
            updateLockIcon() {
                const p = document.getElementById('input-passcode').value;
                const icon = document.getElementById('lock-status');
                if(p && p.length === 4) { icon.className = "fa-solid fa-lock text-[10px] ml-2 text-green-400"; }
                else { icon.className = "fa-solid fa-unlock text-[10px] ml-2 text-gray-500"; }
            },

            createNewScript(t = "新剧本") { 
                const n = { id: Date.now().toString() + Math.random().toString().slice(2,5), title: t, charName: "", charDesc: "", firstMes: "你好，旅行者。", worldScenario: "", userPersona: "", jailbreak: "", charAvatar: "", userAvatar: "", saves: [] }; 
                if(!this.data) this.data = []; this.data.push(n); this.saveToLocal(); this.currentScriptId = n.id; this.loadScriptSettings(n.id); 
                if(t !== "默認劇本" && t !== "緊急恢復劇本") { this.enterSettings(); setTimeout(() => document.getElementById('input-title').focus(), 100); this.showToast("新剧本已创建"); }
            },
            
            updateScriptData(key, value) { if (!this.currentScriptId) return; const script = this.data.find(s => s.id === this.currentScriptId); if (script) { script[key] = value; this.saveToLocal(); if (key === 'title') this.renderScriptList(); } },

            createNewSave() { 
                if (!this.currentScriptId) return; 
                const script = this.data.find(s => s.id === this.currentScriptId); 
                if(!script.saves) script.saves = [];
                const saveId = Date.now().toString(); 
                const newSave = { id: saveId, title: `輪迴 #${script.saves.length + 1}`, timestamp: Date.now(), chatHistory: [] };
                script.saves.unshift(newSave); 
                this.saveToLocal(); 
                this.renderSaveList(); 
                setTimeout(() => this.enterChat(saveId), 50);
                this.showToast("新輪迴開啟"); 
            },
            
            renameSave(saveId) {
                if (!this.currentScriptId) return;
                const script = this.data.find(s => s.id === this.currentScriptId);
                const save = script.saves.find(s => s.id === saveId);
                if (save) {
                    const newName = prompt("重命名此时间线：", save.title);
                    if (newName && newName.trim() !== "") {
                        save.title = newName.trim();
                        this.saveToLocal();
                        this.renderSaveList();
                        this.showToast("更名成功");
                    }
                }
            },

            deleteSave(saveId) { if (!this.currentScriptId) return; const script = this.data.find(s => s.id === this.currentScriptId); if(!confirm("確定刪除？")) return; script.saves = script.saves.filter(s => s.id !== saveId); this.saveToLocal(); this.renderSaveList(); this.showToast("时间线已抹除"); },
            deleteScript(id) { if(!confirm("確定刪除劇本？此操作不可逆！")) return; this.data = this.data.filter(s => s.id !== id); this.saveToLocal(); this.renderScriptList(); this.showToast("剧本已销毁"); },

            enterSettings() { document.getElementById('view-dashboard').classList.add('view-hidden'); document.getElementById('view-chat').classList.add('view-hidden'); document.getElementById('view-settings').classList.remove('view-hidden'); this.renderSaveList(); },
            enterDashboard() { document.getElementById('view-settings').classList.add('view-hidden'); document.getElementById('view-chat').classList.add('view-hidden'); document.getElementById('view-dashboard').classList.remove('view-hidden'); this.currentScriptId = null; this.renderScriptList(); this.switchTab('adventure'); },
            backToSettings() { this.enterSettings(); },
            enterChat(saveId) { this.currentSaveId = saveId; document.getElementById('view-settings').classList.add('view-hidden'); document.getElementById('view-chat').classList.remove('view-hidden'); this.renderChat(); const c = document.getElementById('chat-container'); setTimeout(() => c.scrollTop = c.scrollHeight, 50); },

            renderScriptList() { const l = document.getElementById('script-list'); l.innerHTML = ''; if(!this.data) return; this.data.forEach(script => { const el = document.createElement('div'); el.className = `bg-[#1f2335]/60 backdrop-blur-sm border border-[#292e42]/50 rounded-lg p-3 cursor-pointer relative group hover:border-[#414868] transition-all`; el.onclick = () => { this.currentScriptId = script.id; this.loadScriptSettings(script.id); this.enterSettings(); }; el.innerHTML = `<div class="flex justify-between items-center"><div class="flex-1"><h3 class="font-bold text-[#c0caf5] text-sm mb-1">${script.title || '未命名劇本'}</h3><p class="text-xs text-[#565f89]">${script.charName || '未知角色'} · ${script.saves ? script.saves.length : 0} 個輪迴</p></div><div class="flex items-center gap-2"><i class="fa-solid fa-chevron-right text-[#565f89]"></i></div><button onclick="event.stopPropagation(); App.deleteScript('${script.id}')" class="absolute right-2 top-2 text-[#565f89] hover:text-red-400 p-2 hidden group-hover:block"><i class="fa-solid fa-trash-can pointer-events-none"></i></button></div>`; l.appendChild(el); }); },
            
            renderSaveList() { 
                const l = document.getElementById('save-list'); l.innerHTML = ''; 
                const script = this.data.find(s => s.id === this.currentScriptId); 
                if (!script) return; 
                if (!script.saves || script.saves.length === 0) { l.innerHTML = `<div class="text-center text-[#565f89] text-xs py-4">暂无时间线记录</div>`; return; } 
                script.saves.forEach(save => { 
                    const el = document.createElement('div'); 
                    const lastMsg = save.chatHistory.length > 0 ? save.chatHistory[save.chatHistory.length-1].content.substring(0, 30) + "..." : "（新開局）"; 
                    const date = new Date(save.timestamp).toLocaleString(); 
                    el.className = `bg-[#16161e]/60 backdrop-blur-sm border border-[#2f334d]/50 rounded p-2 flex justify-between items-center hover:bg-[#1a1b26]/80 group`; 
                    el.innerHTML = `
                        <div class="flex-1 cursor-pointer" onclick="App.enterChat('${save.id}')">
                            <div class="flex items-center gap-2"><span class="text-[#c0caf5] text-xs font-bold">${save.title}</span><span class="text-[10px] text-[#565f89]">${date}</span></div>
                            <div class="text-[10px] text-[#787c99] mt-1 truncate pr-4">${lastMsg}</div>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="App.renameSave('${save.id}')" class="text-[#565f89] hover:text-[#ff9e64] p-2" title="重命名"><i class="fa-solid fa-pen"></i></button>
                             <button onclick="App.deleteSave('${save.id}')" class="text-[#565f89] hover:text-red-400 p-2" title="刪除"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    `; 
                    l.appendChild(el); 
                }); 
            },

            loadScriptSettings(id) { const script = this.data.find(s => s.id === id); if (!script) return; ['title', 'charName', 'charDesc', 'firstMes', 'worldScenario', 'userPersona', 'jailbreak'].forEach(key => { const el = document.getElementById(`input-${key.replace(/[A-Z]/g, m => "-" + m.toLowerCase())}`); if(el) el.value = script[key] || ""; }); this.renderAvatar('char', script.charAvatar); this.renderAvatar('user', script.userAvatar); },
            renameIdentity() { const newName = prompt("设置当前发言身份（例如：旁白、系统、神秘人）：", this.currentIdentity); if (newName && newName.trim() !== "") { this.currentIdentity = newName.trim(); document.getElementById('input-name-display').innerText = this.currentIdentity; } },
            
            renderChat() { 
                const script = this.data.find(s => s.id === this.currentScriptId); 
                if(!script) { console.error("Script not found"); return; }
                const save = script.saves ? script.saves.find(s => s.id === this.currentSaveId) : null; 
                if (!save) { console.error("Save not found"); return; } 
                
                const c = document.getElementById('chat-container'); c.innerHTML = ''; 
                if (script.firstMes) { this.appendChatBubble(script.firstMes, 'ai', -1); } 
                if (save.chatHistory) save.chatHistory.forEach((msg, idx) => this.appendChatBubble(msg.content, msg.role, idx, msg.timestamp, msg.customName)); 
                this.updateChatHeader(); 
            },
            
            async generateAIResponse() { 
                const script = this.data.find(s => s.id === this.currentScriptId); 
                const save = script.saves.find(s => s.id === this.currentSaveId); 
                if (!script || !save) return; 
                
                const s = JSON.parse(localStorage.getItem('roleplay_api_settings')); 
                if (!s || !s.url || !s.key) { this.showToast("請先配置 API"); return; } 
                
                let sysPrompt = [`[Character: ${script.charName}]`, `[Description: ${script.charDesc}]`, `[Scenario: ${script.worldScenario}]`, `[User: ${script.userPersona}]`, script.jailbreak].join('\n\n'); 
                
                // V66: Enhanced Theatre Mode Prompt
                if (s.theatreMode) { 
                    sysPrompt += "\n\n[SYSTEM OVERRIDE: IMMERSIVE THEATRE MODE ACTIVE - TITANIUM EDITION]\nCRITICAL: You are now in High-Aesthetic Immersive Mode. For any content involving: SMS, Social Media, Status Screens, Letters, Inventory, or Small Scenes, you MUST NOT use plain text. You MUST render them as self-contained HTML/CSS Cards using the <div class='lq-scope-standalone'> wrapper.\n\n[Design Requirement]: The output MUST be visually stunning, using gradients, glassmorphism (backdrop-blur), and elegant typography. DO NOT output raw Markdown for these scenes. Force usage of HTML/CSS.\n\n[Behavior]: Be creative, poetic, and immersive."; 
                } 
                
                let hist = []; 
                const isGemini = s.url.includes('googleapis'); 
                
                const contextLimit = parseInt(s.context) || 20;
                const recentHistory = save.chatHistory.slice(-contextLimit);

                if (isGemini) { 
                    if(script.firstMes) hist.push({ role: 'model', parts: [{ text: script.firstMes }] }); 
                    recentHistory.forEach(msg => hist.push({ role: msg.role === 'user' ? 'user' : 'model', parts: [{ text: (msg.customName ? `[Identity: ${msg.customName}] ` : "") + msg.content }] })); 
                } else { 
                    hist.push({ role: "system", content: sysPrompt }); 
                    if(script.firstMes) hist.push({ role: "assistant", content: script.firstMes }); 
                    recentHistory.forEach(msg => hist.push({ role: msg.role === 'user' ? 'user' : 'assistant', content: (msg.customName ? `[Identity: ${msg.customName}] ` : "") + msg.content })); 
                } 
                
                const c = document.getElementById('chat-container'); 
                const tid = 'thinking-' + Date.now(); 
                c.insertAdjacentHTML('beforeend', `<div id="${tid}" class="flex gap-3 animate-pulse"><div class="w-8 h-8 rounded-full bg-gray-700 shrink-0"></div><div class="bg-[#24283b] bg-opacity-60 backdrop-blur-md border border-[#2f334d] text-gray-400 p-3 text-sm rounded-r-xl rounded-bl-xl w-fit">Thinking...</div></div>`); 
                c.scrollTop = c.scrollHeight; 
                
                try { 
                    let fUrl, body, head = {}; 
                    if (isGemini) { 
                        let b = s.url.replace(/\/$/, ''); 
                        if (!b.includes('v1beta')) b += '/v1beta'; 
                        fUrl = `${b}/models/${s.model || 'gemini-1.5-flash'}:generateContent?key=${s.key}`; 
                        head = { 'Content-Type': 'application/json' }; 
                        body = JSON.stringify({ 
                            contents: hist, 
                            systemInstruction: { parts: [{ text: sysPrompt }] }, 
                            generationConfig: { 
                                temperature: parseFloat(document.getElementById('disp-temp').innerText)||0.9, 
                                maxOutputTokens: parseInt(document.getElementById('disp-tokens').innerText)||65536 
                            } 
                        }); 
                    } else { 
                        fUrl = `${s.url}/chat/completions`; 
                        head = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${s.key}` }; 
                        body = JSON.stringify({ 
                            model: s.model, 
                            messages: hist, 
                            temperature: parseFloat(document.getElementById('disp-temp').innerText)||0.9, 
                            max_tokens: parseInt(document.getElementById('disp-tokens').innerText)||65536 
                        }); 
                    } 
                    
                    const res = await fetch(fUrl, { method: 'POST', headers: head, body }); 
                    if (!res.ok) throw new Error((await res.text())); 
                    const data = await res.json(); 
                    let reply = isGemini ? (data.candidates?.[0]?.content?.parts?.[0]?.text || "(No response)") : (data.choices?.[0]?.message?.content || "(No response)"); 
                    document.getElementById(tid).remove(); 
                    save.chatHistory.push({ role: 'ai', content: reply, timestamp: Date.now() }); 
                    save.timestamp = Date.now(); 
                    this.saveToLocal(); 
                    this.renderChat(); 
                } catch (e) { 
                    document.getElementById(tid).remove(); 
                    this.showToast("API 錯誤"); 
                    console.error(e); 
                    c.insertAdjacentHTML('beforeend', `<div class="text-red-500 text-xs p-4 text-center w-fit">Error: ${e.message}</div>`); 
                } 
            },
            regenerateResponse() { const script = this.data.find(s => s.id === this.currentScriptId); const save = script.saves.find(s => s.id === this.currentSaveId); if (!script || !save) return; if (save.chatHistory.length === 0) return; const lastMsg = save.chatHistory[save.chatHistory.length - 1]; if (lastMsg.role === 'ai') { save.chatHistory.pop(); this.saveToLocal(); this.renderChat(); this.generateAIResponse(); } else { this.showToast("最後一條不是AI消息"); } },
            scrollToTop() { document.getElementById('chat-container').scrollTo({ top: 0, behavior: 'smooth' }); },
            scrollToBottom() { const c = document.getElementById('chat-container'); c.scrollTo({ top: c.scrollHeight, behavior: 'smooth' }); },
            autoResizeInput(t) { t.style.height = 'auto'; t.style.height = (t.scrollHeight) + 'px'; },
            handleCardSelection(text) { const script = this.data.find(s => s.id === this.currentScriptId); const save = script.saves.find(s => s.id === this.currentSaveId); save.chatHistory.push({ role: 'user', content: "我選擇了：" + text, timestamp: Date.now() }); this.saveToLocal(); this.renderChat(); this.generateAIResponse(); this.showToast("劇情已觸發"); },
            sendHiddenContinue() { this.sendUserMessage("(繼續)"); },
            toggleFlip(card) { card.classList.toggle('is-flipped'); },
            async updatePreviewThumb(key, elId) { const b = await AssetDB.get(key); const el = document.getElementById(elId); if(b) { el.src = URL.createObjectURL(b); el.classList.add('show'); } else { el.classList.remove('show'); } },
            async updateAudioPreview() { const b = await AssetDB.get('custom_audio'); const el = document.getElementById('preview-audio-icon'); if(b) el.classList.add('show'); else el.classList.remove('show'); },
            async loadAudioSettings() { try { const a = document.getElementById('startup-audio'); const d = await AssetDB.get('custom_audio'); if (d) { a.src = URL.createObjectURL(d); a.load(); } else { a.src = "data:audio/wav;base64,UklGRl9vT1BXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"; } } catch(e) { console.error("Audio Load Fail", e); } },
            unlockAudioEngine() { if (this.audioUnlocked) return; const a = document.getElementById('startup-audio'); if(!a.src) return; a.volume = 0; a.play().then(() => { a.pause(); a.currentTime = 0; a.volume = 0.6; this.audioUnlocked = true; }).catch(()=>{}); },
            tryUnlock() { this.unlockAudioEngine(); try { const s = JSON.parse(localStorage.getItem('roleplay_api_settings')) || {}; if (s.passcode && s.passcode.length === 4) { document.getElementById('keypad-overlay').classList.add('active'); this.currentPin = ""; this.updatePinDots(); } else { this.performUnlock(); } } catch(e){ this.performUnlock(); } },
            performUnlock() { const a = document.getElementById('startup-audio'); if(a) { a.currentTime = 0; a.volume = 0.6; a.play().catch(e => console.warn(e)); } this.animateScan(); },
            inputPin(n) { if (this.currentPin.length < 4) { this.currentPin += n; this.updatePinDots(); if (this.currentPin.length === 4) setTimeout(() => this.checkPin(), 200); } },
            clearPin() { this.currentPin = this.currentPin.slice(0, -1); this.updatePinDots(); },
            cancelPin() { document.getElementById('keypad-overlay').classList.remove('active'); this.currentPin = ""; this.updatePinDots(); },
            updatePinDots() { for(let i=1; i<=4; i++) { const d = document.getElementById(`dot-${i}`); if (i <= this.currentPin.length) d.classList.add('filled'); else d.classList.remove('filled'); } },
            checkPin() { const s = JSON.parse(localStorage.getItem('roleplay_api_settings')) || {}; if (this.currentPin === s.passcode) { document.getElementById('keypad-overlay').classList.remove('active'); this.performUnlock(); } else { document.querySelector('.mb-10').classList.add('animate-bounce'); setTimeout(() => { document.querySelector('.mb-10').classList.remove('animate-bounce'); this.currentPin = ""; this.updatePinDots(); }, 500); } },
            animateScan() { document.getElementById('scan-line').style.display = 'block'; document.getElementById('login-text').innerText = "Verifying..."; document.getElementById('login-text').classList.add('text-[#7aa2f7]', 'animate-pulse'); setTimeout(() => { document.getElementById('login-text').innerText = "Granted"; document.getElementById('login-text').classList.replace('text-[#7aa2f7]', 'text-green-400'); setTimeout(() => { document.getElementById('view-cover').classList.add('cover-hidden'); document.getElementById('view-dashboard').classList.remove('view-hidden'); }, 500); }, 1200); },
            renderAestheticTitle(text) { const c = document.getElementById('aesthetic-title'); c.innerHTML = ''; const str = text || "以文為碼，重構森羅萬象"; const lines = str.split(/[ ，,。.\n]/).filter(l => l.trim() !== ""); lines.forEach((line) => { const div = document.createElement('div'); div.className = 'title-line'; div.innerText = line; c.appendChild(div); }); },
            handleImageUpload(i, t) { const f = i.files[0]; if (!f) return; const r = new FileReader(); r.onload = (e) => { this.updateScriptData(t, e.target.result); this.renderAvatar(t === 'charAvatar' ? 'char' : 'user', e.target.result); }; r.readAsDataURL(f); i.value = ''; },
            renderAvatar(p, s) { const i = document.getElementById(`img-${p}-avatar`); const ph = document.getElementById(`ph-${p}-avatar`); if (s) { i.src = s; i.classList.remove('hidden'); ph.classList.add('hidden'); } else { i.src = ""; i.classList.add('hidden'); ph.classList.remove('hidden'); } },
            exportData() { const j = JSON.stringify(this.data, null, 2); const b = new Blob([j], {type: "application/json"}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = `RP_V66_Backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); },
            importData(i) { const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload = (e) => { try { const j = JSON.parse(e.target.result); if (Array.isArray(j)) { this.data = j; this.dataLoaded = true; this.saveToLocal(); this.renderScriptList(); alert(`成功導入 ${j.length} 個劇本！`); } else { alert("格式錯誤"); } } catch(e) { alert("解析失敗"); } }; r.readAsText(f); i.value = ''; },
            handleFileImport(i, t) { const f = i.files[0]; if (!f) return; const r = new FileReader(); r.onload = (e) => { const raw = e.target.result; try { const j = JSON.parse(raw); if (t === 'character') { if(j.name) { document.getElementById('input-char-name').value = j.name; this.updateScriptData('charName', j.name); } if(j.description) { document.getElementById('input-char-desc').value = j.description; this.updateScriptData('charDesc', j.description); } if(j.first_mes) { document.getElementById('input-first-mes').value = j.first_mes; this.updateScriptData('firstMes', j.first_mes); } this.showToast("导入成功"); } else if (t === 'world') { let x = j.entries ? j.entries.map(en => `[${en.keys}]: ${en.content}`).join('\n\n') : (j.world_scenario || JSON.stringify(j, null, 2)); const c = document.getElementById('input-world-scenario').value; const n = c ? c + "\n\n" + x : x; document.getElementById('input-world-scenario').value = n; this.updateScriptData('worldScenario', n); this.showToast("世界书追加"); } } catch (err) { if (t === 'world') { const c = document.getElementById('input-world-scenario').value; const n = c ? c + "\n\n" + raw : raw; document.getElementById('input-world-scenario').value = n; this.updateScriptData('worldScenario', n); this.showToast("文本追加"); } } }; r.readAsText(f); i.value = ''; },
            handleAudioUpload(i) { const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload = async (e) => { const b = new Blob([e.target.result], { type: f.type }); await AssetDB.save('custom_audio', b); this.loadAudioSettings(); this.updateAudioPreview(); this.showToast("音效已更換"); setTimeout(()=>document.getElementById('startup-audio').play(), 500); }; r.readAsArrayBuffer(f); i.value = ''; },
            async clearAudio() { await AssetDB.delete('custom_audio'); this.loadAudioSettings(); this.updateAudioPreview(); this.showToast("已恢復"); },
            async loadBackground() { try{ const b = await AssetDB.get('bg_image'); const el = document.getElementById('app-background'); if (b) { el.style.backgroundImage = `url(${URL.createObjectURL(b)})`; const s = JSON.parse(localStorage.getItem('roleplay_api_settings')) || {}; const op = s.bgOpacity !== undefined ? s.bgOpacity : 15; el.style.opacity = op / 100; } else { el.style.backgroundImage = 'none'; el.style.opacity = '0'; } }catch(e){} },
            handleBgUpload(i) { const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload = async (e) => { const b = new Blob([e.target.result], {type: f.type}); await AssetDB.save('bg_image', b); this.loadBackground(); this.updatePreviewThumb('bg_image', 'preview-bg'); this.showToast("背景已設"); }; r.readAsArrayBuffer(f); i.value = ''; },
            async clearBackground() { await AssetDB.delete('bg_image'); this.showToast("背景已刪"); },
            async loadCoverSettings() { try { const s = JSON.parse(localStorage.getItem('roleplay_api_settings')) || {}; this.renderAestheticTitle(s.welcomeText); document.getElementById('input-welcome-text').value = s.welcomeText || ""; document.getElementById('input-passcode').value = s.passcode || ""; document.getElementById('theatre-mode-toggle').checked = s.theatreMode || false; const b = await AssetDB.get('cover_image'); if (b) document.getElementById('view-cover').style.backgroundImage = `url(${URL.createObjectURL(b)})`; } catch(e){}},
            handleCoverUpload(i) { const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload = async (e) => { const b = new Blob([e.target.result], {type: f.type}); await AssetDB.save('cover_image', b); this.loadCoverSettings(); this.updatePreviewThumb('cover_image', 'preview-cover'); this.showToast("封面已換"); }; r.readAsArrayBuffer(f); i.value = ''; },
            async clearCover() { await AssetDB.delete('cover_image'); document.getElementById('view-cover').style.backgroundImage = "url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop')"; this.showToast("封面重置"); },
            updateCharCount(t) { document.getElementById('char-count').innerText = t.value.length + ' chars'; },
            toggleAppearanceMenu() { document.getElementById('appearance-menu').classList.toggle('show'); },
            updateAppearance(key, value) { document.documentElement.style.setProperty(`--chat-${key.replace(/[A-Z]/g, m => "-" + m.toLowerCase())}`, value); const settings = JSON.parse(localStorage.getItem('roleplay_ui_settings')) || {}; settings[key] = value; localStorage.setItem('roleplay_ui_settings', JSON.stringify(settings)); const btns = document.querySelectorAll(`.setting-btn[onclick*="${key}"]`); btns.forEach(b => { if (b.getAttribute('onclick').includes(`'${value}'`)) { btns.forEach(btn => btn.classList.remove('active')); b.classList.add('active'); } }); if(key === 'color' && document.getElementById('color-picker')) { document.getElementById('color-picker').value = value; } },
            loadAppearanceSettings() { const s = JSON.parse(localStorage.getItem('roleplay_ui_settings')) || {}; if(s.fontSize) this.updateAppearance('fontSize', s.fontSize); if(s.lineHeight) this.updateAppearance('lineHeight', s.lineHeight); if(s.color) this.updateAppearance('color', s.color); if(s.fontWeight) this.updateAppearance('fontWeight', s.fontWeight); },
            clearInput(id) { const el = document.getElementById(id); if(el) { el.value = ""; el.dispatchEvent(new Event('input')); this.showToast("已清空"); } },
            showToast(m) { const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = 'bg-[#1f2335] text-[#7aa2f7] px-4 py-2 rounded-full border border-[#2f334d] shadow-lg text-xs font-bold toast-enter'; t.innerText = m; c.appendChild(t); setTimeout(() => { t.classList.remove('toast-enter'); t.classList.add('toast-enter-active'); }, 10); setTimeout(() => { t.classList.remove('toast-enter-active'); t.classList.add('toast-exit-active'); }, 2000); setTimeout(() => t.remove(), 2300); },
            openFullscreen(id, t) { this.fsTargetId = id; document.getElementById('fs-textarea').value = document.getElementById(id).value; document.getElementById('fs-title').innerText = "正在編輯: " + t; document.getElementById('fullscreen-editor').style.display = 'flex'; document.getElementById('fs-textarea').oninput = (e) => { document.getElementById(this.fsTargetId).value = e.target.value; document.getElementById(this.fsTargetId).dispatchEvent(new Event('input')); }; },
            closeFullscreen() { document.getElementById('fullscreen-editor').style.display = 'none'; this.fsTargetId = null; if (this.editMsgIndex !== null) { const script = this.data.find(s => s.id === this.currentScriptId); const save = script.saves.find(s => s.id === this.currentSaveId); if (script && save) { const n = document.getElementById('fs-textarea').value; if (this.editMsgIndex === -1) { script.firstMes = n; const el = document.getElementById('input-first-mes'); if(el) el.value = n; } else { save.chatHistory[this.editMsgIndex].content = n; } this.saveToLocal(); this.renderChat(); } this.editMsgIndex = null; } },
            
            appendChatBubble(text, role, idx, timestamp = Date.now(), customName = null) { 
                const script = this.data.find(s => s.id === this.currentScriptId); 
                const isUser = role === 'user'; 
                const avatar = isUser ? (script.userAvatar || "https://api.dicebear.com/7.x/initials/svg?seed=ME") : (script.charAvatar || "https://api.dicebear.com/7.x/adventurer/svg?seed=Gener"); 
                const name = isUser ? (customName || "YOU") : (script.charName || "GM"); 
                const date = new Date(timestamp); 
                const timeStr = `${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`; 
                let html = "";
                if (isUser) { const bubbleColor = "bg-[#3d59a1]/80 backdrop-blur-md text-white"; html = `<div class="flex flex-row-reverse gap-3 group message-group animate-fade-in-up relative mb-4" id="msg-${idx}"><img src="${avatar}" class="w-8 h-8 rounded-full mt-1 shrink-0 object-cover bg-[#1a1b26]/50 border border-[#2f334d]/50"><div class="flex flex-col gap-1 max-w-[85%] items-end relative"><div class="flex items-center gap-2"><span class="text-[10px] text-[#7aa2f7] font-bold">${name}</span><div class="msg-actions relative flex gap-3 mr-2"><button onclick="App.editMessage(${idx})" class="text-sm text-gray-500 hover:text-[#ff9e64] transition-colors cursor-pointer"><i class="fa-solid fa-pencil"></i></button>${idx !== -1 ? `<button onclick="App.deleteMessage(${idx})" class="text-sm text-gray-500 hover:text-red-400 transition-colors cursor-pointer"><i class="fa-solid fa-trash-can"></i></button>` : ''}</div></div><div class="${bubbleColor} p-2 px-3 text-sm rounded-l-xl rounded-br-xl shadow-sm relative z-10 w-fit"><div class="whitespace-pre-wrap break-words">${text}</div><span class="float-right text-[9px] opacity-50 ml-2 mt-1 select-none font-mono tracking-tighter">${timeStr}</span></div></div></div>`; } 
                else { html = `<div class="flex flex-col gap-2 group message-group animate-fade-in-up relative mb-6 w-full" id="msg-${idx}"><div class="flex items-center justify-between px-0.5"><div class="flex items-center gap-3"><img src="${avatar}" class="w-8 h-8 rounded-full object-cover bg-[#1a1b26]/50 border border-[#414868]/50 shadow-sm"><span class="text-xs text-[#ff9e64] font-bold tracking-wider uppercase">${name}</span></div><div class="msg-actions flex gap-3 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="App.editMessage(${idx})" class="text-xs text-gray-500 hover:text-[#ff9e64]"><i class="fa-solid fa-pencil"></i></button>${idx !== -1 ? `<button onclick="App.deleteMessage(${idx})" class="text-xs text-gray-500 hover:text-red-400"><i class="fa-solid fa-trash-can"></i></button>` : ''}</div></div><div class="dynamic-text w-full prose prose-invert max-w-none"><div class="whitespace-pre-wrap break-words">${text}</div></div><div class="text-[9px] text-[#565f89] font-mono opacity-30">${timeStr}</div></div>`; }
                document.getElementById('chat-container').insertAdjacentHTML('beforeend', html); 
            },
            updateChatHeader() { const script = this.data.find(s => s.id === this.currentScriptId); if(!script) return; document.getElementById('chat-title').innerText = script.title || "未命名"; document.getElementById('chat-header-avatar').src = script.charAvatar || "https://api.dicebear.com/7.x/adventurer/svg?seed=Gener"; },
            sendUserMessage(contentOverride) { const i = document.getElementById('chat-input'); const t = contentOverride || i.value.trim(); if (!t || !this.currentScriptId || !this.currentSaveId) return; const script = this.data.find(s => s.id === this.currentScriptId); const save = script.saves.find(s => s.id === this.currentSaveId); 
            save.chatHistory.push({ role: 'user', content: t, timestamp: Date.now(), customName: this.currentIdentity !== 'YOU' ? this.currentIdentity : null }); 
            this.saveToLocal(); this.renderChat(); if(!contentOverride) i.value = ''; this.generateAIResponse(); this.updateCharCount(i); },
            editMessage(idx) { const script = this.data.find(s => s.id === this.currentScriptId); const save = script.saves.find(s => s.id === this.currentSaveId); let c = idx === -1 ? script.firstMes : save.chatHistory[idx].content; this.editMsgIndex = idx; document.getElementById('fs-textarea').value = c; document.getElementById('fs-title').innerText = "正在編輯消息"; document.getElementById('fullscreen-editor').style.display = 'flex'; },
            deleteMessage(idx) { const script = this.data.find(s => s.id === this.currentScriptId); const save = script.saves.find(s => s.id === this.currentSaveId); save.chatHistory.splice(idx, 1); this.saveToLocal(); this.renderChat(); this.showToast("已刪除"); },
            handleRawPresetUpload(i) { const f = i.files; if (!f || f.length === 0) return; let txt = ""; let c = 0; Array.from(f).forEach(file => { const r = new FileReader(); r.onload = (e) => { txt += `\n\n--- File: ${file.name} ---\n${e.target.result}`; c++; if (c === f.length) { 
                const currentVal = document.getElementById('input-jailbreak').value;
                const newVal = currentVal + txt;
                document.getElementById('input-jailbreak').value = newVal;
                this.updateScriptData('jailbreak', newVal); 
                this.showToast(`已追加 ${f.length} 個文件`); i.value = ''; } }; r.readAsText(file); }); },
            async fetchModels() { 
                let url = document.getElementById('input-api-url').value.replace(/\/$/, ''); const key = document.getElementById('input-api-key').value; const select = document.getElementById('select-model'); 
                if (!url) return alert("請先填寫 API 地址"); select.innerHTML = '<option>連接中...</option>'; 
                const fallback = ["gemini-1.5-flash", "gemini-1.5-pro", "gemini-1.5-flash-8b", "gemini-1.0-pro", "gpt-4o", "gpt-4o-mini", "claude-3-5-sonnet"]; 
                try { 
                    let fUrl = "", h = {}; 
                    if (url.includes('googleapis.com')) { if (!url.includes('v1beta')) url += '/v1beta'; fUrl = `${url}/models?key=${key}`; } else { fUrl = `${url}/models`; h = { 'Authorization': `Bearer ${key}` }; } 
                    const res = await fetch(fUrl, { method: 'GET', headers: h }); if (!res.ok) throw new Error("Err"); const data = await res.json(); 
                    const models = data.models || data.data || []; select.innerHTML = ''; 
                    if (models.length === 0) throw new Error("No models");
                    models.forEach(m => { let id = m.name || m.id; if (id.startsWith('models/')) id = id.replace('models/', ''); const opt = document.createElement('option'); opt.value = id; opt.text = id; select.appendChild(opt); }); 
                    this.showToast(`已獲取 ${models.length} 個模型`); 
                } catch (err) { 
                    select.innerHTML = ''; fallback.forEach(m => { const opt = document.createElement('option'); opt.value = m; opt.text = m; select.appendChild(opt); }); 
                    this.showToast("已加載通用模型列表"); select.value = fallback[0]; this.saveSystemSettings(); 
                } 
            },
            switchTab(t) { document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); document.getElementById(`nav-${t}`).classList.add('active'); ['adventure', 'system'].forEach(p => { const el = document.getElementById(`page-${p}`); if(el) el.style.display = (p === t) ? 'block' : 'none'; }); }
        };
        window.onload = () => App.init();
    </script>
</body>
</html>
