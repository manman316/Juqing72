<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>控制台 (SETTINGS) - 黎梨 V79 調色修復版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- V79 核心变量 (修復變量名) --- */
        :root {
            --chat-font-size: 15px;
            --chat-line-height: 1.625;
            --chat-color: #c0caf5; /* [V79] 統一變量名 */
            --chat-font-weight: 300;
            --theme-orange: #ff9e64; 
        }

        body { 
            font-family: 'Noto Sans SC', sans-serif; 
            background-color: #000 !important; 
            color: #a9b1d6; 
            overflow: hidden; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        /* [V78] 智能排版引擎 */
        .ai-content-area {
            width: 100%;
            display: block; 
        }

        .dynamic-text {
            font-size: var(--chat-font-size);
            line-height: var(--chat-line-height);
            font-weight: var(--chat-font-weight);
            color: var(--chat-color) !important; /* [V79] 綁定變量 */
            white-space: pre-wrap; 
            word-wrap: break-word;
            text-align: left; 
            transition: all 0.2s ease;
        }

        .ai-content-area > div, 
        .ai-content-area > table,
        .ai-content-area > img,
        .ai-content-area > figure {
            margin-left: auto !important;
            margin-right: auto !important;
            display: block;
            max-width: 100% !important;
        }

        /* [V79] 卡片樣式修復：顏色綁定變量 */
        .ai-content-area div[style*="background"], 
        .ai-content-area div[class*="card"] {
            background-color: rgba(30, 32, 40, 0.6) !important; 
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: var(--chat-color) !important; /* [V79] 關鍵修復：不再寫死顏色 */
            box-shadow: 0 4px 20px rgba(0,0,0,0.5) !important; 
            border-radius: 8px !important;
            white-space: normal !important; 
            text-align: left;
        }
        
        .ai-content-area img {
            filter: brightness(0.9);
            border-radius: 4px;
        }

        /* 封面 & 动画 */
        #view-cover { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 1s ease-in-out, transform 1s ease-in-out; pointer-events: none; }
        .login-wrapper { position: relative; width: 100px; height: 100px; display: flex; justify-content: center; align-items: center; margin-top: 8rem; pointer-events: auto; }
        #login-btn { position: relative; pointer-events: none; transition: transform 0.1s; }
        #login-hitbox { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 999999; cursor: pointer; background: transparent; }
        #login-hitbox:active + #login-btn { transform: scale(0.95); }
        #aesthetic-title { position: absolute; top: 15%; right: 12%; writing-mode: vertical-rl; text-orientation: upright; font-family: 'Noto Serif SC', serif; color: rgba(255, 255, 255, 0.9); text-shadow: 2px 2px 8px rgba(0,0,0,0.6); display: flex; gap: 12px; height: 60%; flex-wrap: wrap-reverse; align-content: flex-start; pointer-events: none; }
        .title-line { font-size: 2rem; font-weight: 600; letter-spacing: 0.2em; transition: all 0.5s; }
        .title-line:nth-child(odd) { margin-top: 0; } .title-line:nth-child(even) { margin-top: 40px; }
        .scan-line { position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: rgba(122, 162, 247, 0.8); box-shadow: 0 0 10px #7aa2f7; animation: scan 1.5s ease-in-out infinite; display: none; }
        @keyframes scan { 0% { top: 20%; opacity: 0; } 50% { opacity: 1; } 100% { top: 80%; opacity: 0; } }

        /* Keypad */
        #keypad-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 999990; opacity: 0; transition: opacity 0.3s ease; pointer-events: auto; }
        #keypad-overlay.active { display: flex; opacity: 1; }
        .key-btn { width: 72px; height: 72px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); color: rgba(255,255,255,0.9); font-size: 26px; font-weight: 300; display: flex; align-items: center; justify-content: center; transition: all 0.2s; cursor: pointer; backdrop-filter: blur(5px); }
        .key-btn:active { background: rgba(255,255,255,0.25); transform: scale(0.92); border-color: rgba(255,255,255,0.4); }
        .pin-dot { width: 12px; height: 12px; border-radius: 50%; border: 1.5px solid rgba(255,255,255,0.6); transition: all 0.2s; }
        .pin-dot.filled { background: white; border-color: white; box-shadow: 0 0 8px rgba(255,255,255,0.5); }

        /* UI 组件 */
        #app-background { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-size: cover; background-position: center; z-index: -1; opacity: 0.15; transition: opacity 0.2s ease; pointer-events: none; }
        .custom-scroll::-webkit-scrollbar { width: 4px; } .custom-scroll::-webkit-scrollbar-track { background: rgba(22, 22, 30, 0.1); } .custom-scroll::-webkit-scrollbar-thumb { background: rgba(47, 51, 77, 0.5); border-radius: 2px; }
        .nav-item.active { color: var(--theme-orange); font-weight: 500; position: relative; } .nav-item.active::after { content: ''; position: absolute; bottom: -12px; left: 0; width: 100%; height: 2px; background-color: var(--theme-orange); }
        .custom-input { background-color: rgba(22, 22, 30, 0.6); border: 1px solid rgba(47, 51, 77, 0.5); color: #c0caf5; transition: all 0.2s; backdrop-filter: blur(8px); } 
        .custom-input:focus { outline: none; border-color: var(--theme-orange); box-shadow: 0 0 0 1px rgba(255, 158, 100, 0.2); background-color: rgba(22, 22, 30, 0.8); }
        select.custom-input { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; }
        input[type=range] { -webkit-appearance: none; background: transparent; } input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--theme-orange); margin-top: -6px; cursor: pointer; } input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: rgba(47, 51, 77, 0.5); border-radius: 2px; }
        input[type=color] { -webkit-appearance: none; border: none; width: 32px; height: 32px; border-radius: 50%; padding: 0; overflow: hidden; cursor: pointer; } input[type=color]::-webkit-color-swatch-wrapper { padding: 0; } input[type=color]::-webkit-color-swatch { border: none; }
        .page-section { display: none; animation: fadeIn 0.3s ease; } .page-section.active { display: block; } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .msg-actions { opacity: 0; transition: opacity 0.2s ease; z-index: 50; pointer-events: none; }
        .message-group:hover .msg-actions, .message-group:active .msg-actions, .message-group.active-touch .msg-actions { opacity: 1; pointer-events: auto; }
        .hidden-file-input { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; opacity: 0; pointer-events: none; }
        .view-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; background-color: transparent; } .view-hidden { display: none !important; }
        .toast-enter { transform: translateY(100%); opacity: 0; } .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 0.3s ease; } .toast-exit { transform: translateY(0); opacity: 1; } .toast-exit-active { transform: translateY(100%); opacity: 0; transition: all 0.3s ease; }
        .preview-thumb { width: 24px; height: 24px; border-radius: 4px; object-fit: cover; border: 1px solid #414868; margin-left: 8px; display: none; } .preview-thumb.show { display: block; }
        .preview-audio-icon { color: #7aa2f7; margin-left: 8px; display: none; cursor: pointer; } .preview-audio-icon.show { display: block; }
        .toggle-checkbox:checked { right: 0; border-color: var(--theme-orange); } .toggle-checkbox:checked + .toggle-label { background-color: var(--theme-orange); } .toggle-switch-container { position: relative; width: 44px; height: 24px; } .toggle-label { display: block; overflow: hidden; cursor: pointer; border: 0 solid #bbb; border-radius: 20px; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(36, 40, 59, 0.8); transition: background-color 0.2s; border: 1px solid #414868; } .toggle-label:before { content: ""; display: block; width: 18px; height: 18px; margin: 2px; background: #c0caf5; position: absolute; top: 0; bottom: 0; right: 20px; border-radius: 50%; transition: all 0.2s; } .toggle-checkbox:checked + .toggle-label:before { right: 0; background-color: #1a1b26; } .toggle-checkbox { position: absolute; visibility: hidden; }
        #appearance-menu { position: absolute; top: 56px; right: 10px; width: 260px; background: rgba(31, 35, 53, 0.85); backdrop-filter: blur(20px); border: 1px solid rgba(65, 72, 104, 0.5); border-radius: 12px; padding: 16px; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: none; transform-origin: top right; animation: scaleIn 0.2s ease; } #appearance-menu.show { display: block; } @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .setting-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; } .setting-label { font-size: 12px; color: #787c99; font-weight: bold; } .setting-btn-group { display: flex; background: rgba(22, 22, 30, 0.5); border-radius: 6px; padding: 2px; border: 1px solid rgba(41, 46, 66, 0.5); gap: 2px; } .setting-btn { flex: 1; padding: 4px 8px; font-size: 12px; color: #565f89; border-radius: 4px; text-align: center; cursor: pointer; transition: all 0.2s; } .setting-btn.active { background: rgba(59, 66, 97, 0.8); color: #c0caf5; font-weight: bold; }
        #input-name-display { cursor: pointer; border-bottom: 1px dashed #565f89; padding-bottom: 1px; transition: color 0.2s; } #input-name-display:hover { color: var(--theme-orange); border-color: var(--theme-orange); }
        .persona-avatar-item { width: 42px; height: 42px; border-radius: 50%; border: 2px solid transparent; opacity: 0.6; transition: all 0.2s; cursor: pointer; position: relative; flex-shrink: 0; } .persona-avatar-item.active { opacity: 1; border-color: var(--theme-orange); transform: scale(1.1); box-shadow: 0 0 10px rgba(255,158,100,0.3); } .persona-avatar-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; background: #1a1b26; }
        #modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 9999; display: none; align-items: center; justify-content: center; animation: fadeIn 0.3s ease; } #modal-overlay.active { display: flex; } .modal-card { background: rgba(31, 35, 53, 0.95); border: 1px solid rgba(65, 72, 104, 0.5); border-radius: 16px; width: 85%; max-width: 320px; padding: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); text-align: center; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); } #modal-overlay.active .modal-card { transform: scale(1); }
        #login-hitbox { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 999999; cursor: pointer; background: transparent; pointer-events: auto; }

        /* --- Crystal Vinyl Widget --- */
        #music-widget-min { position: fixed; right: 10px; top: 20%; width: 70px; height: 70px; z-index: 60000; cursor: grab; touch-action: none; transition: transform 0.1s; display: none; }
        #music-widget-min:active { cursor: grabbing; transform: scale(0.95); }
        .vinyl-base { 
            width: 100%; height: 100%; border-radius: 50%; 
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3); 
            position: relative; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; 
        }
        #music-widget-min.playing .vinyl-base { animation: breathe-beat 1.5s infinite ease-in-out alternate; box-shadow: 0 0 20px rgba(255, 158, 100, 0.3); border-color: rgba(255, 158, 100, 0.4); }
        @keyframes breathe-beat { 0% { transform: scale(1); } 100% { transform: scale(1.05); } }
        
        .vinyl-body { 
            width: 70%; height: 70%; border-radius: 50%; 
            background: rgba(0,0,0,0.5); 
            background-image: repeating-radial-gradient(rgba(255,255,255,0.05) 0, rgba(255,255,255,0.05) 2px, transparent 3px, transparent 4px); 
            position: relative; display: flex; align-items: center; justify-content: center; 
            animation: spin 4s linear infinite; animation-play-state: paused; 
        }
        #music-widget-min.playing .vinyl-body { animation-play-state: running; }
        
        .vinyl-reflection { position: absolute; inset: 0; border-radius: 50%; background: conic-gradient(transparent 0deg, rgba(255,255,255,0.2) 40deg, rgba(255,255,255,0.4) 50deg, rgba(255,255,255,0.2) 60deg, transparent 100deg, transparent 180deg, rgba(255,255,255,0.2) 220deg, rgba(255,255,255,0.4) 230deg, rgba(255,255,255,0.2) 240deg, transparent 280deg); opacity: 0.8; pointer-events: none; }
        .vinyl-label { width: 35%; height: 35%; border-radius: 50%; background: var(--theme-orange); border: 2px solid rgba(255,255,255,0.2); position: relative; opacity: 0.8; }
        .vinyl-label::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 6px; height: 6px; background: rgba(255,255,255,0.8); border-radius: 50%; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Transparent Glass Player */
        #music-widget-max { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); 
            width: 320px; height: auto; 
            background: rgba(20, 20, 25, 0.25); 
            backdrop-filter: blur(40px); 
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 24px; 
            box-shadow: 0 30px 80px rgba(0,0,0,0.5); 
            z-index: 60001; opacity: 0; pointer-events: none; 
            display: flex; flex-direction: column; padding: 20px; transition: all 0.3s ease; 
        }
        #music-widget-max.active { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }
        .player-stage { position: relative; width: 100%; height: 140px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; }
        .album-art { width: 140px; height: 140px; border-radius: 12px; background-color: #222; background-size: cover; background-position: center; position: relative; z-index: 10; box-shadow: 0 15px 35px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); transition: transform 0.3s ease; }
        .vinyl-disc-large { position: absolute; top: 10px; left: 50%; margin-left: -60px; width: 120px; height: 120px; border-radius: 50%; background: #111; background-image: repeating-radial-gradient(#111 0, #111 2px, #222 3px, #222 4px); z-index: 5; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 20px rgba(0,0,0,0.5); transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #music-widget-max.playing .vinyl-disc-large { transform: translateX(70px); }
        .vinyl-disc-large-inner-spin { width: 100%; height: 100%; border-radius: 50%; position: absolute; inset: 0; animation: spin 4s linear infinite; animation-play-state: paused; }
        #music-widget-max.playing .vinyl-disc-large-inner-spin { animation-play-state: running; }
        .vinyl-large-inner { width: 40%; height: 40%; background: var(--theme-orange); border-radius: 50%; border: 2px solid #111; position: absolute; top: 30%; left: 30%; }
        .vinyl-large-shine { position: absolute; inset: 0; border-radius: 50%; background: conic-gradient(transparent 0deg, rgba(255,255,255,0.1) 60deg, transparent 120deg); }
        .visualizer { display: flex; justify-content: center; gap: 4px; height: 20px; margin-bottom: 10px; align-items: flex-end; }
        .v-bar { width: 4px; background: var(--theme-orange); border-radius: 2px; height: 4px; opacity: 0.8; }
        #music-widget-max.playing .v-bar { animation: jump 0.5s infinite ease-in-out alternate; }
        .v-bar:nth-child(odd) { animation-duration: 0.4s; } .v-bar:nth-child(even) { animation-duration: 0.6s; }
        @keyframes jump { 0% { height: 4px; } 100% { height: 18px; } }
        .info-area { text-align: center; margin-bottom: 20px; }
        .song-title { font-size: 16px; font-weight: bold; color: #fff; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .song-status { font-size: 10px; color: #787c99; letter-spacing: 1px; text-transform: uppercase; }
        .ctrl-row { display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 15px; }
        .c-btn { color: #787c99; font-size: 20px; cursor: pointer; transition: all 0.2s; }
        .c-btn:hover { color: #fff; }
        .play-toggle { width: 54px; height: 54px; border-radius: 50%; background: #fff; color: #000; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 0 20px rgba(255,255,255,0.3); transition: all 0.2s; }
        .play-toggle:active { transform: scale(0.95); }
        .upload-row { border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px; display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: #565f89; }
        .add-music { cursor: pointer; display: flex; align-items: center; gap: 5px; transition: color 0.2s; }
        .add-music:hover { color: var(--theme-orange); }
        .playlist-box { max-height: 120px; overflow-y: auto; background: rgba(0,0,0,0.1); border-radius: 8px; margin-top: 10px; padding: 5px; min-height: 50px; border: 1px solid rgba(255,255,255,0.05); }
        .p-item { padding: 8px; border-radius: 4px; color: #888; cursor: pointer; display: flex; justify-content: space-between; font-size: 11px; align-items: center; }
        .p-item:hover { background: rgba(255,255,255,0.1); color: #c0caf5; }
        .p-item.active { color: var(--theme-orange); font-weight: bold; background: rgba(255,158,100,0.1); }

        /* --- TRANSPARENT PHONE STYLES --- */
        #phone-overlay-backdrop {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 499; display: none; opacity: 0; transition: opacity 0.3s ease;
        }
        #phone-overlay-backdrop.active { display: block; opacity: 1; pointer-events: auto; }

        #view-phone { 
            position: fixed; 
            top: 50%; left: 50%; 
            width: 340px; height: 680px; 
            transform: translate(-50%, -40%) scale(0.8); 
            z-index: 500; 
            display: none; flex-direction: column; 
            opacity: 0; 
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); 
            pointer-events: none;
            border-radius: 45px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8), 0 0 0 8px #1f2335; 
            overflow: hidden;
            background: transparent;
        }

        #view-phone.active { 
            display: flex; opacity: 1; 
            transform: translate(-50%, -50%) scale(1); 
            pointer-events: auto; 
        }
        
        .phone-notch {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 120px; height: 30px; 
            background: #1f2335; 
            border-bottom-left-radius: 16px; border-bottom-right-radius: 16px;
            z-index: 50; pointer-events: none;
        }

        .phone-frame {
            position: absolute; inset: 0; display: flex; flex-direction: column; overflow: hidden;
            background-color: rgba(20, 20, 25, 0.2); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        .ios-status-bar { height: 44px; display: flex; justify-content: space-between; align-items: center; padding: 0 24px; color: white; font-size: 12px; font-weight: 600; z-index: 20; margin-top: 5px;}
        
        .ios-nav-bar { 
            height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 16px; z-index: 20; 
            background: rgba(245, 245, 247, 0.1); 
            border-bottom: 0.5px solid rgba(255,255,255,0.1); 
            backdrop-filter: blur(20px); 
        }
        
        .ios-chat-container { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 8px; z-index: 10; padding-bottom: 20px; }
        .ios-bubble { max-width: 80%; padding: 8px 14px; font-size: 14px; line-height: 1.4; position: relative; word-wrap: break-word; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .ios-bubble .delete-btn {
            position: absolute; top: -8px; right: -8px; width: 18px; height: 18px; background: #ff3b30; color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.3); z-index: 50;
        }
        .ios-bubble:hover .delete-btn { display: flex; }

        .ios-bubble-user { align-self: flex-end; background-color: #34c759; color: white; border-radius: 18px 18px 0 18px; margin-right: 4px; }
        .ios-bubble-user::after { content: ""; position: absolute; bottom: 0; right: -4px; width: 10px; height: 10px; background: inherit; border-bottom-left-radius: 10px; clip-path: polygon(0 0, 0% 100%, 100% 100%); }
        
        .ios-bubble-other { align-self: flex-start; background-color: #e9e9eb; color: #000; border-radius: 18px 18px 18px 0; margin-left: 4px; }
        .ios-bubble-other::after { content: ""; position: absolute; bottom: 0; left: -4px; width: 10px; height: 10px; background: inherit; border-bottom-right-radius: 10px; clip-path: polygon(100% 0, 0% 100%, 100% 100%); transform: scaleX(-1); }

        .ios-timestamp { text-align: center; color: rgba(255,255,255,0.5); font-size: 10px; margin: 12px 0 4px 0; font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        
        .ios-input-area { 
            background: rgba(30, 30, 30, 0.5); backdrop-filter: blur(20px); 
            border-top: 0.5px solid rgba(255,255,255,0.1); 
            padding: 10px 12px; padding-bottom: 20px; 
            display: flex; align-items: flex-end; gap: 10px; z-index: 20; 
        }
        .ios-input-field { background: #ffffff; border-radius: 20px; padding: 9px 12px; color: #000; font-size: 15px; max-height: 80px; width: 100%; outline: none; resize: none; }
        .ios-send-btn { width: 34px; height: 34px; border-radius: 50%; background: #34c759; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0; margin-bottom: 2px; transition: transform 0.1s; cursor: pointer; }
        .ios-send-btn:active { transform: scale(0.9); }

        #phone-badge { position: absolute; top: -5px; right: -5px; width: 16px; height: 16px; background: #ff3b30; border-radius: 50%; border: 2px solid #1f2335; color: white; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; pointer-events: none; opacity: 0; transform: scale(0); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        #phone-badge.show { opacity: 1; transform: scale(1); }

        .typing-bubble { align-self: flex-start; background-color: #e9e9eb; border-radius: 18px 18px 18px 0; margin-left: 4px; padding: 12px 16px; display: flex; gap: 4px; width: fit-content; margin-bottom: 10px; position: relative; }
        .typing-bubble::after { content: ""; position: absolute; bottom: 0; left: -4px; width: 10px; height: 10px; background: inherit; border-bottom-right-radius: 10px; clip-path: polygon(100% 0, 0% 100%, 100% 100%); transform: scaleX(-1); }
        .typing-dot { width: 6px; height: 6px; background: #8e8e93; border-radius: 50%; animation: typingBounce 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typingBounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="h-screen flex flex-col w-full text-sm relative" ontouchstart="App.unlockAudioEngine()" onclick="App.unlockAudioEngine()">

    <audio id="startup-audio" playsinline preload="auto"></audio>
    <audio id="bgm-player" playsinline preload="auto"></audio>
    <audio id="phone-notification-sound" src="data:audio/wav;base64,UklGRn4AAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YV4AAAAAAAABAAAAAQAAAAEAAAABAAEAAQABAAIAAgACAAIAAwADAAMAAwAEAAQABAAFAAUABQAFAAYABgAGAAcABwAHAAgACAAIAAkACQAJAAoACgAKAAoACwALAAwADAA="></audio>

    <!-- VIEW 0: COVER -->
    <div id="view-cover">
        <div class="absolute inset-0 bg-black bg-opacity-40 backdrop-blur-sm"></div>
        <div id="aesthetic-title"></div>
        <div class="login-wrapper"><div id="login-hitbox" onclick="App.tryUnlock()"></div><div id="login-btn" class="w-16 h-16 rounded-full border border-white/30 bg-white/10 backdrop-blur-md flex items-center justify-center relative overflow-hidden"><i class="fa-solid fa-fingerprint text-2xl text-white/80 group-hover:text-white"></i><div id="scan-line" class="scan-line"></div></div></div>
        <p id="login-text" class="text-[10px] text-gray-400 tracking-widest uppercase font-serif mt-4 pointer-events-auto cursor-pointer" onclick="App.tryUnlock()">Touch ID</p>
        <div id="keypad-overlay"><div class="mb-10 flex gap-4 transform scale-110"><div class="pin-dot" id="dot-1"></div><div class="pin-dot" id="dot-2"></div><div class="pin-dot" id="dot-3"></div><div class="pin-dot" id="dot-4"></div></div><div class="grid grid-cols-3 gap-x-8 gap-y-6"><div class="key-btn" onclick="App.inputPin(1)">1</div><div class="key-btn" onclick="App.inputPin(2)">2</div><div class="key-btn" onclick="App.inputPin(3)">3</div><div class="key-btn" onclick="App.inputPin(4)">4</div><div class="key-btn" onclick="App.inputPin(5)">5</div><div class="key-btn" onclick="App.inputPin(6)">6</div><div class="key-btn" onclick="App.inputPin(7)">7</div><div class="key-btn" onclick="App.inputPin(8)">8</div><div class="key-btn" onclick="App.inputPin(9)">9</div><div class="key-btn text-xl" onclick="App.cancelPin()"><i class="fa-solid fa-arrow-left"></i></div><div class="key-btn" onclick="App.inputPin(0)">0</div><div class="key-btn text-xl" onclick="App.clearPin()"><i class="fa-solid fa-delete-left"></i></div></div><div class="mt-12 text-white/40 text-[10px] tracking-[0.3em] font-serif">VERIFICATION REQUIRED</div></div>
        <div class="absolute bottom-8 text-[10px] text-gray-500 tracking-widest font-serif opacity-50 cursor-pointer pointer-events-auto" onclick="App.tryUnlock()">SYSTEM V79 ETERNAL MELODY</div>
    </div>

    <!-- Background -->
    <div id="app-background"></div>

    <!-- Modal -->
    <div id="modal-overlay"><div class="modal-card"><h3 class="text-[#c0caf5] font-bold text-lg mb-1 font-serif">靈魂選擇</h3><p class="text-[10px] text-[#787c99] mb-4">此時間線，你將以何種身份存在？</p><div id="persona-select-list" class="grid grid-cols-2 gap-3 mb-4 max-h-[200px] overflow-y-auto custom-scroll"></div><button onclick="document.getElementById('modal-overlay').classList.remove('active')" class="text-xs text-[#565f89] hover:text-[#c0caf5] mt-2">取消</button></div></div>

    <!-- Music Widget (Draggable Min) -->
    <div id="music-widget-min"><div class="vinyl-base"><div class="vinyl-body"><div class="vinyl-reflection"></div><div class="vinyl-label"></div></div></div></div>

    <!-- Expanded Player -->
    <div id="music-widget-max">
        <div class="flex justify-between items-center text-[#565f89] text-[10px] mb-2">
            <span class="tracking-widest">NOW PLAYING</span>
            <i class="fa-solid fa-chevron-down cursor-pointer hover:text-white" onclick="MusicPlayer.togglePanel()"></i>
        </div>
        <div class="player-stage"><div class="vinyl-disc-large"><div class="vinyl-disc-large-inner-spin"><div class="vinyl-large-shine"></div><div class="vinyl-large-inner"></div></div></div><div id="album-art-display" class="album-art"></div></div>
        <div class="visualizer"><div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div></div>
        <div class="info-area"><div id="player-title" class="song-title">No Music Selected</div><div id="player-status" class="song-status">Waiting...</div></div>
        <div class="ctrl-row">
            <i class="fa-solid fa-backward-step c-btn" onclick="MusicPlayer.prev()"></i>
            <div class="play-toggle" onclick="MusicPlayer.togglePlay()"><i id="main-play-icon" class="fa-solid fa-play"></i></div>
            <i class="fa-solid fa-forward-step c-btn" onclick="MusicPlayer.next()"></i>
        </div>
        <div class="upload-row">
            <label class="add-music"><i class="fa-solid fa-plus"></i> 導入音樂/視頻<input type="file" accept="audio/*,video/*" class="hidden-file-input" onchange="MusicPlayer.upload(this)" multiple></label>
            <i class="fa-solid fa-trash cursor-pointer hover:text-red-400" onclick="MusicPlayer.clearAll()"></i>
        </div>
        <div id="playlist-box" class="playlist-box custom-scroll"><div class="text-center text-[#565f89] text-[10px] py-2">暫無播放列表</div></div>
    </div>
    
    <!-- [V73] Floating Phone Structure -->
    <div id="phone-overlay-backdrop" onclick="App.togglePhone()"></div>
    <div id="view-phone">
        <div class="phone-notch"></div>
        <div class="phone-frame">
            <div class="ios-status-bar">
                <span id="ios-clock">00:00</span>
                <div class="flex gap-1.5 items-center">
                    <i class="fa-solid fa-signal"></i>
                    <i class="fa-solid fa-wifi"></i>
                    <i class="fa-solid fa-battery-half"></i>
                </div>
            </div>
            <div class="ios-nav-bar">
                <div class="flex items-center gap-1 text-[#0a84ff] cursor-pointer" onclick="App.togglePhone()">
                    <i class="fa-solid fa-chevron-left text-lg"></i>
                    <span class="text-[16px]">Chats</span>
                </div>
                <div class="flex flex-col items-center">
                    <div class="flex items-center gap-2">
                        <img id="ios-header-avatar" class="w-6 h-6 rounded-full object-cover bg-gray-500 border border-white/20">
                        <span id="ios-contact-name" class="font-bold text-[14px] text-white shadow-sm">Contact</span>
                    </div>
                </div>
                <div class="w-10 flex justify-end"><i class="fa-solid fa-video text-[#0a84ff]/50"></i></div>
            </div>
            
            <div id="ios-chat-container" class="ios-chat-container custom-scroll">
                <div class="text-center mt-4 opacity-50 text-[10px] text-white">iMessage with <span id="ios-contact-name-hint">Char</span></div>
            </div>
            
            <div class="ios-input-area">
                <i class="fa-solid fa-camera text-gray-400 text-xl mb-2"></i>
                <textarea id="ios-chat-input" class="ios-input-field custom-scroll" placeholder="iMessage" rows="1" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
                <div class="ios-send-btn" onclick="App.sendPhoneMessage()">
                    <i class="fa-solid fa-arrow-up text-sm font-bold"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD & SETTINGS & CHAT -->
    <div id="view-dashboard" class="view-container view-hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm -z-10"></div>
        <header class="h-14 bg-[#1f2335]/70 backdrop-blur-md flex items-center justify-between px-4 border-b border-[#16161e]/50 shrink-0 z-50 shadow-sm">
            <div class="flex items-center gap-3"><i class="fa-solid fa-book-journal-whills text-[#ff9e64] text-lg"></i><span class="font-bold text-lg text-[#c0caf5]">剧本库</span></div>
            <button class="text-[#565f89] hover:text-[#ff9e64] transition-colors" onclick="App.manualSave()" title="强制保存"><i class="fa-solid fa-check text-xl"></i></button>
        </header>
        <nav class="h-12 bg-[#1f2335]/60 backdrop-blur-md flex items-center justify-around border-b border-[#292e42]/50 shrink-0 text-[#787c99]"><div class="nav-item active w-1/3 text-center py-3 cursor-pointer" onclick="App.switchTab('adventure')" id="nav-adventure">剧本</div><div class="nav-item w-1/3 text-center py-3 cursor-pointer" onclick="App.switchTab('system')" id="nav-system">系统</div></nav>
        <main class="flex-1 overflow-y-auto custom-scroll relative">
            <div id="page-adventure" class="page-section p-4 space-y-4 pb-24">
                <div onclick="App.createNewScript()" class="border-2 border-dashed border-[#3b4261]/80 rounded-lg h-16 flex items-center justify-center cursor-pointer text-[#7aa2f7] hover:text-[#ff9e64] hover:border-[#ff9e64] transition-all bg-[#1a1b26]/60 hover:bg-[#1f2335]/80 backdrop-blur-sm"><div class="flex items-center gap-2"><i class="fa-solid fa-feather-pointed"></i><span class="font-medium">创作新剧本 (NEW SCRIPT)</span></div></div>
                <div id="script-list" class="space-y-3"></div>
                <div class="pt-6 border-t border-[#292e42]/50 mt-6"><label class="text-xs font-bold text-[#565f89] uppercase mb-3 block">数据管理</label><div class="flex gap-3"><button onclick="App.exportData()" class="flex-1 bg-[#24283b]/80 hover:bg-[#2f334d] text-[#c0caf5] py-2 rounded border border-[#414868]/50 flex items-center justify-center gap-2 transition-colors backdrop-blur-sm"><i class="fa-solid fa-file-export text-[#7aa2f7]"></i> 备份</button><button onclick="document.getElementById('file-backup-import').click()" class="flex-1 bg-[#24283b]/80 hover:bg-[#2f334d] text-[#c0caf5] py-2 rounded border border-[#414868]/50 flex items-center justify-center gap-2 transition-colors backdrop-blur-sm"><i class="fa-solid fa-file-import text-[#ff9e64]"></i> 恢复</button><input type="file" id="file-backup-import" accept=".json" class="hidden-file-input" onchange="App.importData(this)"></div></div>
            </div>
            <div id="page-system" class="hidden p-4 space-y-6">
                <div class="space-y-4 border-b border-[#292e42]/50 pb-6">
                    <label class="text-xs font-bold text-[#bb9af7] uppercase tracking-wider flex items-center gap-2"><i class="fa-solid fa-wand-magic-sparkles"></i> 門戶與個性化</label>
                    <div class="flex justify-between items-center"><span class="text-[10px] text-[#7a85b8] flex items-center gap-2">全局壁紙 <img id="preview-bg" class="preview-thumb"></span><div class="flex gap-2"><label class="cursor-pointer text-[10px] bg-[#24283b]/80 px-2 py-1 rounded border border-[#414868]/50 text-[#c0caf5]">上傳<input type="file" id="file-bg-upload" accept="image/*" class="hidden-file-input" onchange="App.handleBgUpload(this)"></label><button onclick="App.clearBackground()" class="text-[10px] bg-[#24283b]/80 px-2 py-1 rounded border border-[#414868]/50 text-red-400">清除</button></div></div>
                    <div class="space-y-2 px-1"><div class="flex justify-between text-[10px] text-[#7a85b8]"><span>背景圖浓度</span><span class="text-[#ff9e64] font-mono" id="disp-bg-opacity">15%</span></div><input type="range" min="0" max="100" step="1" value="15" id="input-bg-opacity" oninput="document.getElementById('disp-bg-opacity').innerText = this.value + '%'; App.updateBgOpacity(this.value); App.saveSystemSettings()"></div>
                    <div class="flex justify-between items-center"><span class="text-[10px] text-[#7a85b8] flex items-center gap-2">封面圖片 <img id="preview-cover" class="preview-thumb"></span><div class="flex gap-2"><label class="cursor-pointer text-[10px] bg-[#24283b]/80 px-2 py-1 rounded border border-[#414868]/50 text-[#c0caf5]">上傳<input type="file" id="file-cover-upload" accept="image/*" class="hidden-file-input" onchange="App.handleCoverUpload(this)"></label><button onclick="App.clearCover()" class="text-[10px] bg-[#24283b]/80 px-2 py-1 rounded border border-[#414868]/50 text-red-400">重置</button></div></div>
                    <div class="flex justify-between items-center"><span class="text-[10px] text-[#7a85b8] flex items-center gap-2">啟動音效 <i id="preview-audio-icon" class="fa-solid fa-play-circle preview-audio-icon" onclick="document.getElementById('startup-audio').play()"></i></span><div class="flex gap-2"><label class="cursor-pointer text-[10px] bg-[#24283b]/80 px-2 py-1 rounded border border-[#414868]/50 text-[#c0caf5]">上傳<input type="file" id="file-audio-upload" accept="audio/*,video/*" class="hidden-file-input" onchange="App.handleAudioUpload(this)"></label><button onclick="App.clearAudio()" class="text-[10px] bg-[#24283b]/80 px-2 py-1 rounded border border-[#414868]/50 text-red-400">默認</button></div></div>
                    <div class="space-y-1"><span class="text-[10px] text-[#7a85b8]">歡迎詞</span><textarea id="input-welcome-text" class="custom-input w-full p-2 rounded text-xs" rows="2" placeholder="以文為碼，重構森羅萬象" oninput="App.saveSystemSettings()"></textarea></div>
                    <div class="space-y-1"><span class="text-[10px] text-[#7a85b8]">安全鎖密碼 <i id="lock-status" class="fa-solid fa-unlock text-[10px] ml-2 text-gray-500"></i></span><input type="number" id="input-passcode" class="custom-input w-full p-2 rounded text-xs font-mono" placeholder="留空則不啟用" oninput="if(this.value.length>4) this.value=this.value.slice(0,4); App.saveSystemSettings(); App.updateLockIcon()"></div>
                </div>
                <div class="space-y-4 border-b border-[#292e42]/50 pb-6">
                    <label class="text-xs font-bold text-[#7aa2f7] uppercase tracking-wider flex items-center gap-2"><i class="fa-solid fa-network-wired"></i> API 連接</label>
                    <div class="space-y-1"><p class="text-[10px] text-[#7a85b8]">API 地址</p><input type="text" id="input-api-url" class="custom-input w-full p-3 rounded-md text-sm font-mono text-[#9aa5ce]" placeholder="https://generativelanguage.googleapis.com/v1beta" oninput="App.saveSystemSettings()"></div>
                    <div class="space-y-1"><p class="text-[10px] text-[#7a85b8]">API 密鑰</p><input type="password" id="input-api-key" class="custom-input w-full p-3 rounded-md text-sm font-mono text-[#9aa5ce]" placeholder="AIzaSy..." oninput="App.saveSystemSettings()"></div>
                    <div class="space-y-1"><p class="text-[10px] text-[#7a85b8]">AI 模型</p><div class="flex gap-2"><select id="select-model" class="custom-input flex-1 p-3 rounded-md text-sm font-mono text-[#ff9e64] bg-[#16161e]/50" onchange="App.saveSystemSettings()"><option value="" disabled selected>請點擊刷新...</option></select><button onclick="App.fetchModels()" class="bg-[#24283b]/80 hover:bg-[#2f334d] text-[#c0caf5] px-4 rounded border border-[#414868]/50 transition-colors"><i class="fa-solid fa-arrows-rotate pointer-events-none"></i></button></div></div>
                </div>
                <div class="space-y-6 px-2">
                    <div class="space-y-2"><div class="flex justify-between text-sm font-bold text-[#c0caf5]"><span>AI 隨機性</span><span class="text-[#ff9e64] font-mono" id="disp-temp">0.9</span></div><input type="range" min="0" max="2" step="0.01" value="0.9" id="input-temp" oninput="document.getElementById('disp-temp').innerText = this.value; App.saveSystemSettings()"></div>
                    <div class="space-y-2"><div class="flex justify-between text-sm font-bold text-[#c0caf5]"><span>回復長度</span><span class="text-[#ff9e64] font-mono" id="disp-tokens">65536</span></div><input type="range" min="200" max="65536" step="128" value="65536" id="input-tokens" oninput="document.getElementById('disp-tokens').innerText = this.value; App.saveSystemSettings()"></div>
                    <div class="space-y-2"><div class="flex justify-between text-sm font-bold text-[#c0caf5]"><span>上下文記憶 (條數)</span><span class="text-[#ff9e64] font-mono" id="disp-context">20</span></div><input type="range" min="5" max="100" step="1" value="20" id="input-context" oninput="document.getElementById('disp-context').innerText = this.value; App.saveSystemSettings()"></div>
                </div>
                <div class="pt-6 border-t border-[#292e42]/50 mt-4 flex items-center justify-between">
                    <div>
                        <span class="text-sm font-bold text-[#ff9e64] block">沈浸式劇場模式 Pro</span>
                        <span class="text-[10px] text-[#565f89]">THEATRE: 強制AI生成精美卡片</span>
                    </div>
                    <div class="toggle-switch-container">
                        <input type="checkbox" id="theatre-mode-toggle" class="toggle-checkbox" onchange="App.saveSystemSettings()">
                        <label for="theatre-mode-toggle" class="toggle-label"></label>
                    </div>
                </div>
                <div class="h-24"></div>
            </div>
        </main>
    </div>

    <!-- VIEW B: SCRIPT SETTINGS -->
    <div id="view-settings" class="view-container view-hidden">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-md -z-10"></div>
        <header class="h-14 bg-[#1f2335]/70 backdrop-blur-md flex items-center justify-between px-4 border-b border-[#16161e]/50 shrink-0 z-50 shadow-sm">
            <div class="flex items-center gap-3"><button onclick="App.enterDashboard()" class="text-[#787c99] hover:text-[#c0caf5]"><i class="fa-solid fa-arrow-left"></i></button><i class="fa-solid fa-sliders text-[#bb9af7] text-lg"></i><span class="font-bold text-lg text-[#c0caf5]">設定</span></div>
            <button onclick="App.manualSave()" class="text-[#7aa2f7] hover:text-[#ff9e64] flex items-center gap-2 px-3 py-1 rounded bg-[#16161e]/50 border border-[#2f334d]/50 transition-colors"><i class="fa-solid fa-check"></i><span class="text-xs font-bold">保存</span></button>
        </header>
        <main class="flex-1 overflow-y-auto custom-scroll relative">
            <div class="p-4 pb-24 space-y-6">
                <div class="space-y-2"><label class="text-xs font-bold text-[#ff9e64] uppercase tracking-wider">剧本标题</label><input type="text" id="input-title" class="custom-input w-full p-3 rounded-md text-sm font-bold" oninput="App.updateScriptData('title', this.value)"></div>
                <div class="space-y-3"><div class="flex justify-between items-end"><label class="text-xs font-bold text-[#ff9e64] uppercase tracking-wider flex items-center gap-2"><i class="fa-solid fa-user"></i> 角色卡</label><label class="cursor-pointer bg-[#24283b]/80 hover:bg-[#2f334d] text-[10px] text-[#c0caf5] px-3 py-1.5 rounded border border-[#414868]/50 transition-colors flex items-center gap-1"><i class="fa-solid fa-upload"></i> 导入JSON<input type="file" id="file-char-import" class="hidden-file-input" onchange="App.handleFileImport(this, 'character')"></label></div><div class="bg-[#1f2335]/60 backdrop-blur-sm rounded-lg p-3 border border-[#292e42]/50"><div class="flex gap-3 mb-3"><label class="w-16 h-16 shrink-0 bg-[#1a1b26]/50 rounded-md relative overflow-hidden group cursor-pointer border border-[#414868]/50 hover:border-[#ff9e64]"><img id="img-char-avatar" class="w-full h-full object-cover hidden"><div id="ph-char-avatar" class="absolute inset-0 flex flex-col items-center justify-center text-[#565f89] group-hover:text-[#ff9e64]"><i class="fa-solid fa-camera text-sm"></i></div><input type="file" id="file-char-avatar" accept="image/*" class="hidden-file-input" onchange="App.handleImageUpload(this, 'charAvatar')"></label><div class="flex-1 flex flex-col justify-center gap-2"><input type="text" id="input-char-name" class="custom-input p-2 rounded text-sm w-full font-bold" placeholder="角色名称" oninput="App.updateScriptData('charName', this.value)"></div></div><div class="mt-3"><div class="flex justify-between mb-1"><p class="text-[10px] text-[#7a85b8]">人设描述</p><div class="flex gap-2"><button onclick="App.clearInput('input-char-desc')" class="text-[#565f89] hover:text-red-400 text-xs px-2 py-1"><i class="fa-solid fa-trash-can pointer-events-none"></i></button><button onclick="App.openFullscreen('input-char-desc', '人设描述')" class="text-[#565f89] hover:text-[#ff9e64] text-xs px-2 py-1"><i class="fa-solid fa-expand pointer-events-none"></i></button></div></div><textarea id="input-char-desc" class="custom-input w-full p-2 rounded text-xs leading-relaxed h-24 resize-none" oninput="App.updateScriptData('charDesc', this.value)"></textarea></div><div class="mt-3"><div class="flex justify-between mb-1"><p class="text-[10px] text-[#7a85b8]">开场白 (支持HTML)</p><div class="flex gap-2"><button onclick="App.clearInput('input-first-mes')" class="text-[#565f89] hover:text-red-400 text-xs px-2 py-1"><i class="fa-solid fa-trash-can pointer-events-none"></i></button><button onclick="App.openFullscreen('input-first-mes', '开场白')" class="text-[#565f89] hover:text-[#ff9e64] text-xs px-2 py-1"><i class="fa-solid fa-expand pointer-events-none"></i></button></div></div><textarea id="input-first-mes" class="custom-input w-full p-2 rounded text-xs leading-relaxed h-20 resize-none" oninput="App.updateScriptData('firstMes', this.value)"></textarea></div></div></div>
                <div class="space-y-3"><div class="flex justify-between items-end"><label class="text-xs font-bold text-[#ff9e64] uppercase tracking-wider flex items-center gap-2"><i class="fa-solid fa-globe"></i> 世界观</label><label class="cursor-pointer bg-[#24283b]/80 hover:bg-[#2f334d] text-[10px] text-[#c0caf5] px-3 py-1.5 rounded border border-[#414868]/50 transition-colors flex items-center gap-1"><i class="fa-solid fa-file-import pointer-events-none"></i> 导入<input type="file" id="file-world-import" accept=".json,.txt" class="hidden-file-input" onchange="App.handleFileImport(this, 'world')"></label></div><div class="bg-[#1f2335]/60 backdrop-blur-sm rounded-lg p-3 border border-[#292e42]/50 space-y-3"><div><div class="flex justify-between mb-1"><p class="text-[10px] text-[#7a85b8]">世界背景</p><div class="flex gap-2"><button onclick="App.clearInput('input-world-scenario')" class="text-[#565f89] hover:text-red-400 text-xs px-2 py-1"><i class="fa-solid fa-trash-can pointer-events-none"></i></button><button onclick="App.openFullscreen('input-world-scenario', '世界背景')" class="text-[#565f89] hover:text-[#ff9e64] text-xs px-2 py-1"><i class="fa-solid fa-expand pointer-events-none"></i></button></div></div><textarea id="input-world-scenario" class="custom-input w-full p-2 rounded text-xs leading-relaxed h-24 resize-none font-mono text-[#9aa5ce]" oninput="App.updateScriptData('worldScenario', this.value)"></textarea></div></div></div>
                
                <div class="space-y-3">
                    <div class="flex justify-between items-end">
                        <label class="text-xs font-bold text-[#bb9af7] uppercase tracking-wider flex items-center gap-2"><i class="fa-solid fa-masks-theater"></i> 玩家多重身份</label>
                    </div>
                    <div class="bg-[#1f2335]/60 backdrop-blur-sm p-3 rounded border border-[#292e42]/50">
                        <div class="flex items-center gap-3 mb-4 overflow-x-auto custom-scroll pb-2" id="persona-list-container"></div>
                        <div id="current-persona-editor" class="flex gap-3 border-t border-[#292e42]/50 pt-3 relative">
                            <label class="w-16 h-16 shrink-0 bg-[#2f334d]/80 rounded-md relative overflow-hidden group cursor-pointer border border-[#414868]/50 hover:border-[#ff9e64] transition-all">
                                <img id="img-persona-avatar" class="w-full h-full object-cover hidden">
                                <div id="ph-persona-avatar" class="absolute inset-0 flex items-center justify-center text-[#7aa2f7]"><i class="fa-solid fa-user pointer-events-none"></i></div>
                                <input type="file" id="file-persona-avatar" accept="image/*" class="hidden-file-input" onchange="App.handlePersonaAvatar(this)">
                            </label>
                            <div class="flex-1 flex flex-col gap-2">
                                <div class="flex justify-between gap-2">
                                    <input type="text" id="input-persona-name" class="custom-input p-2 rounded text-sm w-full font-bold text-[#ff9e64]" placeholder="身份名稱 (如: 正妻)" oninput="App.saveCurrentPersona()">
                                    <button onclick="App.deleteCurrentPersona()" class="px-2 rounded bg-[#24283b] text-red-400 border border-[#2f334d] hover:bg-red-900/30"><i class="fa-solid fa-trash-can"></i></button>
                                </div>
                                <textarea id="input-persona-desc" class="custom-input w-full p-2 rounded text-xs leading-relaxed h-16 resize-none" placeholder="該身份的具體設定..." oninput="App.saveCurrentPersona()"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="relative"><div class="flex justify-between items-end mb-1 ml-1"><p class="text-[10px] text-[#7a85b8]">破限 (JAILBREAK)</p><div class="flex gap-2 items-center"><label class="cursor-pointer bg-[#24283b]/80 hover:bg-[#2f334d] text-[10px] text-[#c0caf5] px-2 py-0.5 rounded border border-[#414868]/50 transition-colors flex items-center gap-1 mr-2"><i class="fa-solid fa-folder-open pointer-events-none"></i> 批量导入<input type="file" id="file-preset-raw" multiple class="hidden-file-input" onchange="App.handleRawPresetUpload(this)"></label><button onclick="App.clearInput('input-jailbreak')" class="text-[#565f89] hover:text-red-400 text-xs px-2 py-1"><i class="fa-solid fa-trash-can pointer-events-none"></i></button><button onclick="App.openFullscreen('input-jailbreak', '破限设置')" class="text-[#565f89] hover:text-[#ff9e64] text-xs px-2 py-1"><i class="fa-solid fa-expand pointer-events-none"></i></button></div></div><textarea id="input-jailbreak" class="custom-input w-full p-2 rounded text-[10px] font-mono leading-relaxed h-32 resize-none text-[#73daca]" oninput="App.updateScriptData('jailbreak', this.value)"></textarea></div>

                <div class="pt-8 border-t border-[#292e42]/50 mt-8">
                    <label class="text-xs font-bold text-[#7aa2f7] uppercase tracking-wider flex items-center gap-2 mb-4"><i class="fa-solid fa-clock-rotate-left"></i> 时间线 (SAVES)</label>
                    <div onclick="App.promptNewSave()" class="border border-dashed border-[#3b4261]/80 rounded-lg h-12 flex items-center justify-center cursor-pointer text-[#7aa2f7] hover:text-[#ff9e64] hover:border-[#ff9e64] transition-all bg-[#1f2335]/60 mb-4 text-xs backdrop-blur-sm"><div class="flex items-center gap-2"><i class="fa-solid fa-play"></i><span class="font-medium">開啟新輪迴 / 此時此刻</span></div></div>
                    <div id="save-list" class="space-y-2"></div>
                </div>
                <div class="h-24"></div>
            </div>
        </main>
    </div>

    <!-- VIEW C: CHAT -->
    <div id="view-chat" class="view-container view-hidden fade-in relative">
        <div class="h-14 bg-[#1f2335]/70 backdrop-blur-md flex items-center justify-between px-4 border-b border-[#16161e]/30 shrink-0 shadow-sm relative z-50">
             <div class="flex items-center gap-3"><button onclick="App.backToSettings()" class="text-[#565f89] hover:text-[#ff9e64] flex items-center gap-2 transition-colors group"><i class="fa-solid fa-arrow-left text-lg"></i><span class="font-bold text-sm">設定</span></button></div>
             <div class="absolute left-1/2 transform -translate-x-1/2 text-center pointer-events-none"><h3 id="chat-title" class="font-bold text-[#c0caf5] text-sm shadow-black drop-shadow-md">...</h3><div class="flex items-center justify-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-green-500"></span><span class="text-[10px] text-[#7a85b8]">Online</span></div></div>
            <div class="flex gap-3 items-center">
                <button onclick="App.toggleAppearanceMenu()" class="text-[#565f89] hover:text-[#ff9e64] w-8 h-8 flex items-center justify-center rounded transition-colors"><i class="fa-solid fa-font text-sm"></i></button>
                <img id="chat-header-avatar" class="w-8 h-8 rounded-full border border-[#2f334d]/50 bg-[#1a1b26]/50 object-cover">
            </div>
        </div>

        <div id="appearance-menu">
            <div class="setting-row"><span class="setting-label">字號</span><div class="setting-btn-group w-32"><div class="setting-btn" onclick="App.updateAppearance('fontSize', '13px')">小</div><div class="setting-btn active" onclick="App.updateAppearance('fontSize', '15px')" data-val="15px">中</div><div class="setting-btn" onclick="App.updateAppearance('fontSize', '17px')">大</div><div class="setting-btn" onclick="App.updateAppearance('fontSize', '20px')">特</div></div></div>
            <div class="setting-row"><span class="setting-label">行距</span><div class="setting-btn-group w-32"><div class="setting-btn" onclick="App.updateAppearance('lineHeight', '1.4')">密</div><div class="setting-btn active" onclick="App.updateAppearance('lineHeight', '1.625')" data-val="1.625">適</div><div class="setting-btn" onclick="App.updateAppearance('lineHeight', '2.0')">寬</div></div></div>
            <div class="setting-row"><span class="setting-label">濃度</span><div class="setting-btn-group w-32"><div class="setting-btn active" onclick="App.updateAppearance('fontWeight', '300')" data-mode="normal">标准</div><div class="setting-btn" onclick="App.updateAppearance('fontWeight', '400')">加粗</div></div></div>
            <div class="setting-row">
                <span class="setting-label">顏色</span>
                <div class="flex items-center gap-2">
                    <div class="setting-btn-group flex-1">
                        <div class="setting-btn active" onclick="App.updateAppearance('color', '#c0caf5')">蓝灰</div>
                        <div class="setting-btn" onclick="App.updateAppearance('color', '#ffffff')">纯白</div>
                        <div class="setting-btn" onclick="App.updateAppearance('color', '#e0af68')">金沙</div>
                    </div>
                    <input type="color" id="color-picker" value="#c0caf5" oninput="App.updateAppearance('color', this.value)">
                </div>
            </div>
        </div>
        
        <div class="absolute right-4 bottom-24 flex flex-col gap-2 z-40">
            <button onclick="App.scrollToTop()" class="w-8 h-8 rounded-full bg-[#1f2335]/70 backdrop-blur-md border border-[#292e42]/50 text-[#565f89] flex items-center justify-center shadow-lg hover:text-[#ff9e64] active:scale-90"><i class="fa-solid fa-arrow-up"></i></button>
            <button onclick="App.scrollToBottom()" class="w-8 h-8 rounded-full bg-[#1f2335]/70 backdrop-blur-md border border-[#292e42]/50 text-[#565f89] flex items-center justify-center shadow-lg hover:text-[#ff9e64] active:scale-90"><i class="fa-solid fa-arrow-down"></i></button>
        </div>

        <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 custom-scroll message-content" style="padding-bottom: 120px;"></div>
        
        <div class="p-3 bg-[#1a1b26]/70 backdrop-blur-xl border-t border-[#16161e]/30 shrink-0">
            <div class="flex justify-end mb-2 gap-2">
                <span id="input-name-display" class="text-[10px] text-[#7a85b8] self-center mr-auto ml-2 font-mono" onclick="App.renameIdentity()">YOU</span>
                
                <button onclick="App.togglePhone()" class="relative text-[12px] text-[#565f89] hover:text-[#ff9e64] border border-[#2f334d] rounded px-3 py-1 bg-[#1f2335]/50 flex items-center gap-1.5 transition-all">
                    <i class="fa-solid fa-mobile-screen-button"></i> 
                    <div id="phone-badge">1</div>
                </button>

                <button onclick="App.sendHiddenContinue()" class="text-[10px] text-[#565f89] hover:text-[#ff9e64] border border-[#2f334d] rounded px-2 py-1 bg-[#1f2335]/50 flex items-center gap-1"><i class="fa-solid fa-forward"></i> ⏩ 續寫</button>
            </div>
            <div class="relative flex items-center gap-2">
                <button onclick="App.regenerateResponse()" class="w-10 h-10 rounded-full bg-[#24283b]/80 backdrop-blur-md text-[#ff9e64] border border-[#414868]/50 flex items-center justify-center hover:bg-[#2f334d] shrink-0 active:scale-90 transition-transform" title="重新生成"><i class="fa-solid fa-arrows-rotate pointer-events-none"></i></button>
                <div class="relative w-full">
                    <textarea id="chat-input" class="w-full bg-[#16161e]/60 backdrop-blur-md text-[#c0caf5] rounded-xl p-3 pr-10 text-sm border border-[#2f334d]/50 focus:border-[#ff9e64] outline-none resize-none min-h-[48px] max-h-[150px] overflow-y-auto custom-scroll" placeholder="发消息..." oninput="App.autoResizeInput(this); App.updateCharCount(this)"></textarea>
                    <span id="char-count" class="absolute top-[-18px] right-1 text-[10px] text-[#565f89] font-mono">0 chars</span>
                </div>
                <button onclick="App.sendUserMessage()" class="absolute right-2 bottom-2.5 text-[#ff9e64] p-2 hover:scale-110 transition-transform"><i class="fa-solid fa-paper-plane pointer-events-none"></i></button>
            </div>
        </div>
    </div>

    <div id="fullscreen-editor" class="fixed inset-0 bg-[#1a1b26]/90 backdrop-blur-xl z-[100] hidden flex-col">
        <div class="h-12 bg-[#1f2335]/70 flex items-center justify-between px-4 border-b border-[#292e42]/50"><span id="fs-title" class="font-bold text-[#ff9e64]">正在编辑</span><button onclick="App.closeFullscreen()" class="text-[#7aa2f7] text-sm font-bold">完成</button></div>
        <textarea id="fs-textarea" class="flex-1 bg-transparent text-[#c0caf5] p-4 outline-none resize-none font-mono text-sm leading-relaxed"></textarea>
    </div>
    <div id="toast-container" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 z-[200]"></div>

    <script>
        const AssetDB = {
            db: null,
            init() { 
                return new Promise((res, rej) => { 
                    const r = indexedDB.open("RP_Assets_DB", 3); 
                    r.onupgradeneeded = (e) => { 
                        const d = e.target.result; 
                        if (!d.objectStoreNames.contains("assets")) d.createObjectStore("assets"); 
                        if (!d.objectStoreNames.contains("tracks")) {
                            d.createObjectStore("tracks", { keyPath: "id" });
                        }
                    }; 
                    r.onsuccess = (e) => { this.db = e.target.result; res(); }; 
                    r.onerror = (e) => rej(e); 
                }); 
            },
            async save(k, d) { if (!this.db) await this.init(); return new Promise((res, rej) => { const tx = this.db.transaction(["assets"], "readwrite"); tx.objectStore("assets").put(d, k); tx.oncomplete = res; tx.onerror = rej; }); },
            async get(k) { if (!this.db) await this.init(); return new Promise((res, rej) => { const tx = this.db.transaction(["assets"], "readonly"); const r = tx.objectStore("assets").get(k); r.onsuccess = () => res(r.result); r.onerror = rej; }); },
            async delete(k) { if (!this.db) await this.init(); return new Promise((res, rej) => { const tx = this.db.transaction(["assets"], "readwrite"); tx.objectStore("assets").delete(k); tx.oncomplete = res; }); },
            async saveTrack(track) {
                if (!this.db) await this.init();
                return new Promise((res, rej) => {
                    const tx = this.db.transaction(["tracks"], "readwrite");
                    tx.objectStore("tracks").put(track);
                    tx.oncomplete = res; tx.onerror = rej;
                });
            },
            async getAllTracks() {
                if (!this.db) await this.init();
                return new Promise((res, rej) => {
                    const tx = this.db.transaction(["tracks"], "readonly");
                    const r = tx.objectStore("tracks").getAll();
                    r.onsuccess = () => res(r.result);
                    r.onerror = rej;
                });
            },
            async deleteTrack(id) {
                if (!this.db) await this.init();
                return new Promise((res, rej) => {
                    const tx = this.db.transaction(["tracks"], "readwrite");
                    tx.objectStore("tracks").delete(id);
                    tx.oncomplete = res;
                });
            }
        };

        window.triggerScenario = (text) => { App.handleCardSelection(text); };

        const MusicPlayer = {
            audio: null,
            tracks: [],
            currentIdx: 0,
            isPlaying: false,
            
            async init() {
                this.audio = document.getElementById('bgm-player');
                this.audio.onended = () => this.next();
                this.makeDraggable();
                await this.loadPlaylistFromDB(); 
            },

            async loadPlaylistFromDB() {
                try {
                    const savedTracks = await AssetDB.getAllTracks();
                    if (savedTracks && savedTracks.length > 0) {
                        this.tracks = savedTracks.map(t => ({
                            id: t.id,
                            name: t.name,
                            url: URL.createObjectURL(t.blob),
                            thumb: t.thumb
                        }));
                        this.updateUI();
                    }
                } catch (e) { console.error("Failed to load music", e); }
            },

            makeDraggable() {
                const el = document.getElementById('music-widget-min');
                let isDragging = false;
                let startX, startY, startLeft, startTop;
                let moved = false;
                const getCoords = (e) => { if(e.touches) return { x: e.touches[0].clientX, y: e.touches[0].clientY }; return { x: e.clientX, y: e.clientY }; }
                const onStart = (e) => {
                    isDragging = true; moved = false;
                    const coords = getCoords(e); startX = coords.x; startY = coords.y;
                    const rect = el.getBoundingClientRect();
                    el.style.right = 'auto'; el.style.bottom = 'auto'; el.style.left = rect.left + 'px'; el.style.top = rect.top + 'px';
                    startLeft = rect.left; startTop = rect.top;
                    el.style.transition = 'none'; 
                };
                const onMove = (e) => {
                    if (!isDragging) return; e.preventDefault(); 
                    const coords = getCoords(e);
                    const dx = coords.x - startX; const dy = coords.y - startY;
                    if (Math.abs(dx) > 3 || Math.abs(dy) > 3) moved = true;
                    el.style.left = (startLeft + dx) + 'px'; el.style.top = (startTop + dy) + 'px';
                };
                const onEnd = () => {
                    if (!isDragging) return; isDragging = false; el.style.transition = 'transform 0.1s'; 
                };
                el.addEventListener('mousedown', onStart); window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onEnd);
                el.addEventListener('touchstart', onStart, {passive: false}); window.addEventListener('touchmove', onMove, {passive: false}); window.addEventListener('touchend', onEnd);
                el.onclick = (e) => { if (!moved) this.togglePanel(); };
            },
            
            async upload(input) {
                const files = Array.from(input.files);
                if (!files.length) return;
                
                for (let f of files) {
                    let thumb = null;
                    if (f.type.startsWith('video/')) { thumb = await this.extractVideoThumb(f); }
                    
                    const trackId = Date.now() + Math.random().toString();
                    const trackData = { id: trackId, name: f.name, blob: f, thumb: thumb }; 
                    await AssetDB.saveTrack(trackData);
                    
                    const url = URL.createObjectURL(f);
                    this.tracks.push({ id: trackId, name: f.name, url: url, thumb: thumb });
                }
                this.updateUI();
                if (!this.isPlaying && this.tracks.length > 0) {
                    this.play(this.tracks.length - files.length); 
                }
                input.value = '';
            },

            extractVideoThumb(file) {
                return new Promise((resolve) => {
                    const video = document.createElement('video');
                    video.preload = 'metadata';
                    video.onloadedmetadata = () => { video.currentTime = 1; };
                    video.onseeked = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL());
                    };
                    video.onerror = () => resolve(null);
                    video.src = URL.createObjectURL(file);
                });
            },

            togglePanel() { document.getElementById('music-widget-max').classList.toggle('active'); },

            togglePlay() {
                if (this.tracks.length === 0) return;
                if (this.isPlaying) this.pause(); else this.play(this.currentIdx);
            },

            play(idx) {
                if (idx < 0 || idx >= this.tracks.length) return;
                this.currentIdx = idx;
                const track = this.tracks[this.currentIdx];
                if (this.audio.src !== track.url) { this.audio.src = track.url; }
                this.audio.play().then(() => { this.isPlaying = true; this.updateUI(); }).catch(e => console.error("Play error", e));
            },

            pause() { this.audio.pause(); this.isPlaying = false; this.updateUI(); },
            next() { let next = this.currentIdx + 1; if (next >= this.tracks.length) next = 0; this.play(next); },
            prev() { let prev = this.currentIdx - 1; if (prev < 0) prev = this.tracks.length - 1; this.play(prev); },
            
            async clearAll() {
                this.pause();
                for (let t of this.tracks) { await AssetDB.deleteTrack(t.id); }
                this.tracks = [];
                this.currentIdx = 0;
                this.updateUI();
            },

            async rename(idx) {
                const t = this.tracks[idx];
                const newName = prompt("重命名歌曲:", t.name);
                if (newName && newName.trim() !== "") {
                    t.name = newName.trim();
                    const dbTrack = await new Promise((res) => {
                        const tx = AssetDB.db.transaction(["tracks"], "readonly");
                        const r = tx.objectStore("tracks").get(t.id);
                        r.onsuccess = () => res(r.result);
                    });
                    
                    if (dbTrack) {
                        dbTrack.name = t.name;
                        await AssetDB.saveTrack(dbTrack);
                        this.updateUI();
                    }
                }
            },

            updateUI() {
                const min = document.getElementById('music-widget-min');
                const max = document.getElementById('music-widget-max');
                
                if (this.isPlaying) { min.classList.add('playing'); max.classList.add('playing'); } 
                else { min.classList.remove('playing'); max.classList.remove('playing'); }

                const title = document.getElementById('player-title');
                const status = document.getElementById('player-status');
                const playIcon = document.getElementById('main-play-icon');
                const art = document.getElementById('album-art-display');
                
                if (this.tracks.length > 0) {
                    const t = this.tracks[this.currentIdx];
                    title.innerText = t.name;
                    status.innerText = this.isPlaying ? "Playing" : "Paused";
                    
                    if(t.thumb) { art.style.backgroundImage = `url(${t.thumb})`; } 
                    else { 
                        const hue = (this.currentIdx * 137) % 360; 
                        art.style.backgroundImage = `linear-gradient(135deg, hsl(${hue}, 60%, 20%), hsl(${hue}, 70%, 10%))`;
                    }
                } else {
                    title.innerText = "No Music"; status.innerText = "Idle";
                    art.style.backgroundImage = "linear-gradient(135deg, #333, #111)";
                }

                playIcon.className = this.isPlaying ? "fa-solid fa-pause" : "fa-solid fa-play";

                const list = document.getElementById('playlist-box');
                list.innerHTML = '';
                if (this.tracks.length === 0) {
                    list.innerHTML = '<div class="text-center text-[#565f89] text-[10px] py-2">暫無播放列表</div>';
                } else {
                    this.tracks.forEach((t, i) => {
                        const el = document.createElement('div');
                        el.className = `p-item ${i === this.currentIdx ? 'active' : ''}`;
                        el.innerHTML = `
                            <span class="truncate pr-2 flex-1" onclick="MusicPlayer.play(${i})">${i+1}. ${t.name}</span>
                            <div class="flex gap-2">
                                <i class="fa-solid fa-pen hover:text-white" onclick="event.stopPropagation(); MusicPlayer.rename(${i})"></i>
                                <i class="fa-solid fa-xmark hover:text-red-400" onclick="event.stopPropagation(); MusicPlayer.remove(${i})"></i>
                            </div>
                        `;
                        list.appendChild(el);
                    });
                }
            },
            
            async remove(idx) {
                if (idx === this.currentIdx) this.pause();
                const t = this.tracks[idx];
                await AssetDB.deleteTrack(t.id); 
                this.tracks.splice(idx, 1);
                if (this.currentIdx >= this.tracks.length) this.currentIdx = 0;
                this.updateUI();
            }
        };

        const App = {
            data: [], currentScriptId: null, currentSaveId: null, fsTargetId: null, editMsgIndex: null, currentPin: "", audioUnlocked: false,
            currentIdentity: "YOU", editingPersonaId: null, 
            dataLoaded: false,
            phoneOpen: false,

            async init() {
                document.getElementById('phone-notification-sound').src = "data:audio/wav;base64,UklGRn4AAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YV4AAAAAAAABAAAAAQAAAAEAAAABAAEAAQABAAIAAgACAAIAAwADAAMAAwAEAAQABAAFAAUABQAFAAYABgAGAAcABwAHAAgACAAIAAkACQAJAAoACgAKAAoACwALAAwADAA="; 

                const hitbox = document.getElementById('login-hitbox');
                if(hitbox) {
                    const unlockFn = (e) => { e.preventDefault(); e.stopPropagation(); this.tryUnlock(); };
                    hitbox.addEventListener('click', unlockFn); hitbox.addEventListener('touchend', unlockFn);
                }

                MusicPlayer.init();

                try { 
                    try { await AssetDB.init(); } catch(e) { console.warn("DB Fail", e); } 
                    const newData = await AssetDB.get('roleplay_saves_v50'); 
                    if (newData && Array.isArray(newData)) { this.data = newData; this.dataLoaded = true; } 
                    else { 
                        const oldData = localStorage.getItem('roleplay_saves_v2');
                        if(oldData) {
                             try {
                                const oldList = JSON.parse(oldData);
                                this.data = oldList.map(adv => ({
                                    id: adv.id, title: adv.title, charName: adv.charName, charDesc: adv.charDesc, firstMes: adv.firstMes, worldScenario: adv.worldScenario, jailbreak: adv.jailbreak, charAvatar: adv.charAvatar,
                                    personas: [{ id: 'p-'+Date.now()+Math.random(), name: "默認", desc: adv.userPersona || "", avatar: adv.userAvatar || "" }],
                                    saves: [{ id: Date.now().toString(), title: "默認时间线", timestamp: Date.now(), chatHistory: adv.chatHistory || [], personaId: null }]
                                }));
                                this.dataLoaded = true; await this.saveToLocal(); 
                             } catch(e) { console.error("Migration failed", e); }
                        }
                    }
                } catch (e) { this.showToast("數據重置（救援模式）"); this.data = []; this.dataLoaded = true; }
                
                if (this.dataLoaded && this.data.length === 0) { this.createNewScript("默認劇本"); }
                
                try { await this.loadAudioSettings(); } catch(e) { console.warn("Audio load error:", e); } 
                try { this.loadSystemSettings(); } catch(e){}
                try { this.loadBackground(); } catch(e){}
                try { this.loadCoverSettings(); } catch(e){}
                try { this.loadAppearanceSettings(); } catch(e){}
                
                this.renderScriptList(); 
                this.switchTab('adventure'); 
                document.getElementById('chat-container').addEventListener('click', (e) => { document.querySelectorAll('.message-group').forEach(el => el.classList.remove('active-touch')); const bubble = e.target.closest('.message-group'); if (bubble) bubble.classList.add('active-touch'); });
                document.addEventListener('click', (e) => { if(!e.target.closest('#appearance-menu') && !e.target.closest('button[onclick="App.toggleAppearanceMenu()"]')) { document.getElementById('appearance-menu').classList.remove('show'); }});
                this.updatePreviewThumb('bg_image', 'preview-bg'); this.updatePreviewThumb('cover_image', 'preview-cover'); this.updateAudioPreview();
                this.showToast("SYSTEM READY");
                
                setInterval(() => {
                    const now = new Date();
                    document.getElementById('ios-clock').innerText = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                }, 1000);
            },

            async saveToLocal() { if(!this.dataLoaded) { console.warn("Prevented overwrite: Data not loaded."); return; } try { await AssetDB.save('roleplay_saves_v50', this.data); } catch (e) { console.error(e); } },
            async manualSave() { if(!this.dataLoaded) return alert("数据未加载，无法保存"); try { await AssetDB.save('roleplay_saves_v50', this.data); this.showToast("✅ 強制保存成功"); } catch(e) { this.showToast("❌ 保存失敗"); } },
            
            saveSystemSettings() {
                const s = JSON.parse(localStorage.getItem('roleplay_api_settings')) || {};
                s.url = document.getElementById('input-api-url').value; s.key = document.getElementById('input-api-key').value; s.model = document.getElementById('select-model').value; s.temp = document.getElementById('input-temp').value; s.tokens = document.getElementById('input-tokens').value; s.context = document.getElementById('input-context').value; s.welcomeText = document.getElementById('input-welcome-text').value; s.passcode = document.getElementById('input-passcode').value; s.theatreMode = document.getElementById('theatre-mode-toggle').checked; s.bgOpacity = document.getElementById('input-bg-opacity').value;
                localStorage.setItem('roleplay_api_settings', JSON.stringify(s));
            },

            loadSystemSettings() {
                const s = JSON.parse(localStorage.getItem('roleplay_api_settings')) || { url: '', key: '', model: '', temp: 0.9, tokens: 65536, context: 20, bgOpacity: 15 };
                if(s.url) document.getElementById('input-api-url').value = s.url; if(s.key) document.getElementById('input-api-key').value = s.key;
                if(s.model) { const sel = document.getElementById('select-model'); sel.innerHTML = `<option value="${s.model}">${s.model}</option>`; sel.value = s.model; }
                if(s.temp) { document.getElementById('input-temp').value = s.temp; document.getElementById('disp-temp').innerText = s.temp; }
                if(s.tokens) { document.getElementById('input-tokens').value = s.tokens; document.getElementById('disp-tokens').innerText = s.tokens; }
                if(s.context) { document.getElementById('input-context').value = s.context; document.getElementById('disp-context').innerText = s.context; }
                if(s.welcomeText) document.getElementById('input-welcome-text').value = s.welcomeText;
                if(s.passcode) document.getElementById('input-passcode').value = s.passcode;
                if(s.theatreMode !== undefined) document.getElementById('theatre-mode-toggle').checked = s.theatreMode;
                const op = s.bgOpacity !== undefined ? s.bgOpacity : 15; document.getElementById('input-bg-opacity').value = op; document.getElementById('disp-bg-opacity').innerText = op + '%'; this.updateBgOpacity(op);
                this.renderAestheticTitle(s.welcomeText); this.updateLockIcon();
            },
            
            updateBgOpacity(val) { document.getElementById('app-background').style.opacity = val / 100; },
            updateLockIcon() { const p = document.getElementById('input-passcode').value; const icon = document.getElementById('lock-status'); if(p && p.length === 4) { icon.className = "fa-solid fa-lock text-[10px] ml-2 text-green-400"; } else { icon.className = "fa-solid fa-unlock text-[10px] ml-2 text-gray-500"; } },

            createNewScript(t = "新剧本") { 
                const n = { id: Date.now().toString() + Math.random().toString().slice(2,5), title: t, charName: "", charDesc: "", firstMes: "你好，旅行者。", worldScenario: "", jailbreak: "", charAvatar: "", personas: [{ id: 'p-'+Date.now(), name: "默認", desc: "普通玩家", avatar: "" }], saves: [] }; 
                if(!this.data) this.data = []; this.data.push(n); this.saveToLocal(); this.currentScriptId = n.id; this.loadScriptSettings(n.id); 
                if(t !== "默認劇本" && t !== "緊急恢復劇本") { this.enterSettings(); setTimeout(() => document.getElementById('input-title').focus(), 100); this.showToast("新剧本已创建"); }
            },
            
            updateScriptData(key, value) { if (!this.currentScriptId) return; const script = this.data.find(s => s.id === this.currentScriptId); if (script) { script[key] = value; this.saveToLocal(); if (key === 'title') this.renderScriptList(); } },

            loadScriptSettings(id) { this.loadScriptSettings_Internal(id); },
            loadScriptSettings_Internal(id) {
                const script = this.data.find(s => s.id === id); if (!script) return;
                if (!script.personas || !Array.isArray(script.personas)) { script.personas = [{ id: 'p-'+Date.now(), name: "默認", desc: script.userPersona || "", avatar: script.userAvatar || "" }]; }
                ['title', 'charName', 'charDesc', 'firstMes', 'worldScenario', 'jailbreak'].forEach(key => { const el = document.getElementById(`input-${key.replace(/[A-Z]/g, m => "-" + m.toLowerCase())}`); if(el) el.value = script[key] || ""; }); 
                this.renderAvatar('char', script.charAvatar); this.renderPersonaList();
            },

            renderPersonaList() {
                const script = this.data.find(s => s.id === this.currentScriptId); const container = document.getElementById('persona-list-container'); container.innerHTML = '';
                if (!this.editingPersonaId || !script.personas.find(p => p.id === this.editingPersonaId)) { this.editingPersonaId = script.personas[0].id; }
                script.personas.forEach(p => { const el = document.createElement('div'); el.className = `persona-avatar-item ${p.id === this.editingPersonaId ? 'active' : ''}`; el.onclick = () => { this.editingPersonaId = p.id; this.renderPersonaList(); this.loadPersonaToEditor(p); }; const img = p.avatar || "https://api.dicebear.com/7.x/initials/svg?seed=ME"; el.innerHTML = `<img src="${img}">`; container.appendChild(el); });
                const addBtn = document.createElement('div'); addBtn.className = "w-10 h-10 rounded-full border border-dashed border-[#565f89] flex items-center justify-center text-[#565f89] cursor-pointer hover:text-[#ff9e64] hover:border-[#ff9e64] flex-shrink-0 ml-2"; addBtn.innerHTML = '<i class="fa-solid fa-plus"></i>'; addBtn.onclick = () => this.addNewPersona(); container.appendChild(addBtn);
                const current = script.personas.find(p => p.id === this.editingPersonaId); this.loadPersonaToEditor(current);
            },

            loadPersonaToEditor(p) { if(!p) return; document.getElementById('input-persona-name').value = p.name || ""; document.getElementById('input-persona-desc').value = p.desc || ""; this.renderAvatar('persona', p.avatar); },
            addNewPersona() { const script = this.data.find(s => s.id === this.currentScriptId); const newP = { id: 'p-'+Date.now(), name: "新身份", desc: "", avatar: "" }; script.personas.push(newP); this.editingPersonaId = newP.id; this.saveToLocal(); this.renderPersonaList(); this.showToast("已添加新身份"); },
            saveCurrentPersona() { const script = this.data.find(s => s.id === this.currentScriptId); const p = script.personas.find(x => x.id === this.editingPersonaId); if(p) { p.name = document.getElementById('input-persona-name').value; p.desc = document.getElementById('input-persona-desc').value; this.saveToLocal(); } },
            handlePersonaAvatar(i) { const f = i.files[0]; if (!f) return; const r = new FileReader(); r.onload = (e) => { const script = this.data.find(s => s.id === this.currentScriptId); const p = script.personas.find(x => x.id === this.editingPersonaId); if(p) { p.avatar = e.target.result; this.saveToLocal(); this.renderPersonaList(); } }; r.readAsDataURL(f); i.value = ''; },
            deleteCurrentPersona() { const script = this.data.find(s => s.id === this.currentScriptId); if (script.personas.length <= 1) return this.showToast("至少保留一個身份"); if(!confirm("確定刪除此身份？")) return; script.personas = script.personas.filter(p => p.id !== this.editingPersonaId); this.editingPersonaId = script.personas[0].id; this.saveToLocal(); this.renderPersonaList(); },
            promptNewSave() { const script = this.data.find(s => s.id === this.currentScriptId); if (script.personas.length <= 1) { this.createNewSave(script.personas[0].id); } else { const list = document.getElementById('persona-select-list'); list.innerHTML = ''; script.personas.forEach(p => { const el = document.createElement('div'); el.className = "bg-[#1f2335] border border-[#2f334d] p-2 rounded flex flex-col items-center cursor-pointer hover:border-[#ff9e64] hover:bg-[#24283b]"; const img = p.avatar || "https://api.dicebear.com/7.x/initials/svg?seed=ME"; el.innerHTML = `<img src="${img}" class="w-8 h-8 rounded-full mb-1 object-cover"><span class="text-[10px] text-[#c0caf5] font-bold truncate w-full text-center">${p.name}</span>`; el.onclick = () => { document.getElementById('modal-overlay').classList.remove('active'); this.createNewSave(p.id); }; list.appendChild(el); }); document.getElementById('modal-overlay').classList.add('active'); } },
            createNewSave(personaId) { if (!this.currentScriptId) return; const script = this.data.find(s => s.id === this.currentScriptId); if(!script.saves) script.saves = []; if (!personaId && script.personas.length > 0) personaId = script.personas[0].id; const saveId = Date.now().toString(); const newSave = { id: saveId, title: `輪迴 #${script.saves.length + 1}`, timestamp: Date.now(), chatHistory: [], personaId: personaId }; script.saves.unshift(newSave); this.saveToLocal(); this.renderSaveList(); setTimeout(() => this.enterChat(saveId), 50); this.showToast("新輪迴開啟"); },
            renameSave(saveId) { if (!this.currentScriptId) return; const script = this.data.find(s => s.id === this.currentScriptId); const save = script.saves.find(s => s.id === saveId); if (save) { const newName = prompt("重命名此时间线：", save.title); if (newName && newName.trim() !== "") { save.title = newName.trim(); this.saveToLocal(); this.renderSaveList(); this.showToast("更名成功"); } } },
            deleteSave(saveId) { if (!this.currentScriptId) return; const script = this.data.find(s => s.id === this.currentScriptId); if(!confirm("確定刪除？")) return; script.saves = script.saves.filter(s => s.id !== saveId); this.saveToLocal(); 
this.renderSaveList(); this.showToast("時間線已抹除"); },
            deleteScript(id) { if(!confirm("確定刪除劇本？此操作不可逆！")) return; this.data = this.data.filter(s => s.id !== id); this.saveToLocal(); this.renderScriptList(); this.showToast("剧本已销毁"); },
            
            closePhone() {
                this.phoneOpen = false;
                document.getElementById('view-phone').classList.remove('active');
                document.getElementById('phone-overlay-backdrop').classList.remove('active');
                document.getElementById('ios-chat-input').blur(); 
                document.getElementById('ios-chat-container').innerHTML = '';
            },

            togglePhone() {
                const el = document.getElementById('view-phone');
                const bd = document.getElementById('phone-overlay-backdrop');
                
                this.phoneOpen = !this.phoneOpen;
                
                if(this.phoneOpen) {
                    el.classList.add('active');
                    bd.classList.add('active');
                    this.renderPhoneChat(); 
                    
                    document.getElementById('phone-badge').classList.remove('show');
                } else {
                    this.closePhone();
                }
            },

            enterSettings() { 
                this.closePhone();
                document.getElementById('view-dashboard').classList.add('view-hidden'); 
                document.getElementById('view-chat').classList.add('view-hidden'); 
                document.getElementById('view-settings').classList.remove('view-hidden'); 
                this.renderSaveList(); 
            },
            enterDashboard() { 
                this.closePhone();
                document.getElementById('view-settings').classList.add('view-hidden'); 
                document.getElementById('view-chat').classList.add('view-hidden'); 
                document.getElementById('view-dashboard').classList.remove('view-hidden'); 
                this.currentScriptId = null; 
                this.renderScriptList(); 
                this.switchTab('adventure'); 
            },
            backToSettings() { this.enterSettings(); },
            
            enterChat(saveId) { 
                this.closePhone();
                this.currentSaveId = saveId; 
                document.getElementById('view-settings').classList.add('view-hidden'); 
                document.getElementById('view-chat').classList.remove('view-hidden'); 
                this.renderChat(); 
                const c = document.getElementById('chat-container'); 
                setTimeout(() => c.scrollTop = c.scrollHeight, 50); 
            },

            renderScriptList() { const l = document.getElementById('script-list'); l.innerHTML = ''; if(!this.data) return; this.data.forEach(script => { const el = document.createElement('div'); el.className = `bg-[#1f2335]/60 backdrop-blur-sm border border-[#292e42]/50 rounded-lg p-3 cursor-pointer relative group hover:border-[#414868] transition-all`; el.onclick = () => { this.currentScriptId = script.id; this.loadScriptSettings(script.id); this.enterSettings(); }; el.innerHTML = `<div class="flex justify-between items-center"><div class="flex-1"><h3 class="font-bold text-[#c0caf5] text-sm mb-1">${script.title || '未命名劇本'}</h3><p class="text-xs text-[#565f89]">${script.charName || '未知角色'} · ${script.saves ? script.saves.length : 0} 個輪迴</p></div><div class="flex items-center gap-2"><i class="fa-solid fa-chevron-right text-[#565f89]"></i></div><button onclick="event.stopPropagation(); App.deleteScript('${script.id}')" class="absolute right-2 top-2 text-[#565f89] hover:text-red-400 p-2 hidden group-hover:block"><i class="fa-solid fa-trash-can pointer-events-none"></i></button></div>`; l.appendChild(el); }); },
            renderSaveList() { const l = document.getElementById('save-list'); l.innerHTML = ''; const script = this.data.find(s => s.id === this.currentScriptId); if (!script) return; if (!script.saves || script.saves.length === 0) { l.innerHTML = `<div class="text-center text-[#565f89] text-xs py-4">暂无时间线记录</div>`; return; } script.saves.forEach(save => { const el = document.createElement('div'); let personaName = "未知身份"; if (script.personas) { const p = script.personas.find(x => x.id === save.personaId); if (p) personaName = p.name; else if (!save.personaId && script.personas.length > 0) personaName = script.personas[0].name; } const lastMsg = save.chatHistory.length > 0 ? save.chatHistory[save.chatHistory.length-1].content.substring(0, 30) + "..." : "（新開局）"; const date = new Date(save.timestamp).toLocaleString(); el.className = `bg-[#16161e]/60 backdrop-blur-sm border border-[#2f334d]/50 rounded p-2 flex justify-between items-center hover:bg-[#1a1b26]/80 group`; el.innerHTML = `<div class="flex-1 cursor-pointer" onclick="App.enterChat('${save.id}')"><div class="flex items-center gap-2"><span class="text-[#c0caf5] text-xs font-bold">${save.title}</span><span class="text-[9px] px-1.5 rounded bg-[#3b4261] text-[#7aa2f7]">${personaName}</span></div><div class="text-[10px] text-[#787c99] mt-1 truncate pr-4">${lastMsg}</div></div><div class="flex gap-2"><button onclick="App.renameSave('${save.id}')" class="text-[#565f89] hover:text-[#ff9e64] p-2" title="重命名"><i class="fa-solid fa-pen"></i></button><button onclick="App.deleteSave('${save.id}')" class="text-[#565f89] hover:text-red-400 p-2" title="刪除"><i class="fa-solid fa-trash-can"></i></button></div>`; l.appendChild(el); }); },
            loadScriptSettings(id) { this.loadScriptSettings_Internal(id); },
            loadScriptSettings_Internal(id) { const script = this.data.find(s => s.id === id); if (!script) return; if (!script.personas || !Array.isArray(script.personas)) { script.personas = [{ id: 'p-'+Date.now(), name: "默認", desc: script.userPersona || "", avatar: script.userAvatar || "" }]; } ['title', 'charName', 'charDesc', 'firstMes', 'worldScenario', 'jailbreak'].forEach(key => { const el = document.getElementById(`input-${key.replace(/[A-Z]/g, m => "-" + m.toLowerCase())}`); if(el) el.value = script[key] || ""; }); this.renderAvatar('char', script.charAvatar); this.renderPersonaList(); },
            renameIdentity() { const newName = prompt("设置当前发言身份（例如：旁白、系统、神秘人）：", this.currentIdentity); if (newName && newName.trim() !== "") { this.currentIdentity = newName.trim(); document.getElementById('input-name-display').innerText = this.currentIdentity; } },

            async generateAIResponse(triggerSource = 'main') { 
                const script = this.data.find(s => s.id === this.currentScriptId); 
                const save = script.saves.find(s => s.id === this.currentSaveId); 
                if (!script || !save) return; 

                const s = JSON.parse(localStorage.getItem('roleplay_api_settings')); 
                if (!s || !s.url || !s.key) { this.showToast("請先配置 API"); return; } 

                let activePersona = null; 
                if (script.personas) { activePersona = script.personas.find(p => p.id === save.personaId); } 
                const userDesc = activePersona ? activePersona.desc : (script.userPersona || ""); 
                
                let sysPrompt = [`[Character: ${script.charName}]`, `[Description: ${script.charDesc}]`, `[Scenario: ${script.worldScenario}]`, `[User: ${userDesc}]`, script.jailbreak].join('\n\n'); 
                
                sysPrompt += `\n\n[SYSTEM: MOBILE PHONE INTERACTION PROTOCOL]
                1. The User has a mobile phone. You (Character) have a mobile phone.
                2. IF you want to send a text message (SMS/WeChat) to the User, you MUST enclose the message content in <sms> tags.
                3. You can send MULTIPLE messages in a row by using multiple tags.
                   Example: <sms>Where are you?</sms><sms>I am worried.</sms>
                4. You can mix Narrative Action and SMS.
                   Example: "He picked up his phone, hesitating." <sms>I'm sorry.</sms> "He put the phone down."
                5. If the User sent you an SMS (marked as [SMS from User]), you should generally reply via <sms> tags, unless the plot dictates you ignore it or call them.
                6. Be strictly immersive. If you are angry, send short, cold texts. If happy, use emojis.`;

                let hist = []; 
                let isGemini = s.url.includes('googleapis'); 
                const contextLimit = parseInt(s.context) || 20; 
                
                const recentHistory = save.chatHistory.slice(-contextLimit).map(msg => {
                    let content = msg.content;
                    if (msg.role === 'user' && msg.isPhone) {
                        content = `[SMS from User]: ${content}`;
                    }
                    else if (msg.role === 'user') {
                        content = `${msg.customName || 'User'}: ${content}`;
                    }
                    return { role: msg.role === 'user' ? 'user' : (isGemini ? 'model' : 'assistant'), content: content };
                });

                if (isGemini) { 
                    if(script.firstMes) hist.push({ role: 'model', parts: [{ text: script.firstMes }] }); 
                    recentHistory.forEach(m => hist.push({ role: m.role, parts: [{ text: m.content }] })); 
                } else { 
                    hist.push({ role: "system", content: sysPrompt }); 
                    if(script.firstMes) hist.push({ role: "assistant", content: script.firstMes }); 
                    recentHistory.forEach(m => hist.push({ role: m.role, content: m.content })); 
                } 

                const c = document.getElementById('chat-container'); 
                const tid = 'thinking-' + Date.now(); 
                if(triggerSource === 'main') {
                    c.insertAdjacentHTML('beforeend', `<div id="${tid}" class="flex gap-3 animate-pulse"><div class="w-8 h-8 rounded-full bg-gray-700 shrink-0"></div><div class="bg-[#24283b] bg-opacity-60 backdrop-blur-md border border-[#2f334d] text-gray-400 p-3 text-sm rounded-r-xl rounded-bl-xl w-fit">Thinking...</div></div>`); 
                    c.scrollTop = c.scrollHeight; 
                } else {
                    const pc = document.getElementById('ios-chat-container');
                    if(pc) {
                        const existing = document.getElementById('ios-typing-bubble');
                        if(existing) existing.remove();
                        const typingHtml = `<div id="ios-typing-bubble" class="typing-bubble"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
                        pc.insertAdjacentHTML('beforeend', typingHtml);
                        pc.scrollTop = pc.scrollHeight;
                    }
                }

                try { 
                    let fUrl, body, head = {}; 
                    if (isGemini) { 
                        let b = (s.url || 'https://generativelanguage.googleapis.com').replace(/\/$/, '');
                        if (!b.includes('/v1beta')) b += '/v1beta';
                        const modelName = s.model || 'gemini-1.5-flash';
                        fUrl = `${b}/models/${modelName}:generateContent?key=${s.key}`;
                        head = { 'Content-Type': 'application/json' }; 
                        body = JSON.stringify({ contents: hist, systemInstruction: { parts: [{ text: sysPrompt }] }, generationConfig: { temperature: parseFloat(document.getElementById('disp-temp').innerText)||0.9, maxOutputTokens: parseInt(document.getElementById('disp-tokens').innerText)||65536 } }); 
                    } else { 
                        let baseUrl = s.url.replace(/\/$/, ''); 
                        if (baseUrl.endsWith('/chat/completions')) { fUrl = baseUrl; } else { fUrl = `${baseUrl}/chat/completions`; }
                        head = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${s.key}` }; 
                        body = JSON.stringify({ model: s.model, messages: hist, temperature: parseFloat(document.getElementById('disp-temp').innerText)||0.9, max_tokens: parseInt(document.getElementById('disp-tokens').innerText)||65536 }); 
                    }
                    
                    const res = await fetch(fUrl, { method: 'POST', headers: head, body }); 
                    if (!res.ok) { 
                        const errText = await res.text();
                        console.error('🔴 API 错误:', { status: res.status, error: errText });
                        throw new Error(`API Error: ${res.status}`); 
                    } 
                    const data = await res.json(); 
                    let reply = isGemini ? (data.candidates?.[0]?.content?.parts?.[0]?.text || "") : (data.choices?.[0]?.message?.content || ""); 

                    if(document.getElementById(tid)) document.getElementById(tid).remove(); 
                    
                    this.processAIOutput(reply, script, save);

                } catch (e) { 
                    if(document.getElementById(tid)) document.getElementById(tid).remove(); 
                    const pt = document.getElementById('ios-typing-bubble');
                    if(pt) pt.remove();
                    
                    this.showToast(e.message || "API 錯誤"); 
                    console.error(e); 
                } 
            },

            processAIOutput(rawText, script, save) {
                const pt = document.getElementById('ios-typing-bubble');
                if(pt) pt.remove();

                const smsRegex = /<sms>([\s\S]*?)<\/sms>/gi;
                let match;
                let smsFound = false;
                let narrativeText = rawText; 

                while ((match = smsRegex.exec(rawText)) !== null) {
                    smsFound = true;
                    const smsContent = match[1].trim();
                    if(smsContent) {
                        save.chatHistory.push({ 
                            role: 'ai', 
                            content: smsContent, 
                            timestamp: Date.now(),
                            isPhone: true 
                        });
                    }
                }

                narrativeText = rawText.replace(smsRegex, "").trim();

                if (narrativeText.length > 0) {
                    save.chatHistory.push({ 
                        role: 'ai', 
                        content: narrativeText, 
                        timestamp: Date.now(),
                        isPhone: false 
                    });
                }

                save.timestamp = Date.now(); 
                this.saveToLocal(); 

                this.renderChat(); 
                
                if(this.phoneOpen) {
                    this.renderPhoneChat();
                }

                if (smsFound) {
                    this.triggerPhoneNotification();
                }
            },

            sendUserMessage(contentOverride) { 
                const i = document.getElementById('chat-input'); 
                const t = contentOverride || i.value.trim(); 
                if (!t || !this.currentScriptId || !this.currentSaveId) return; 
                
                const script = this.data.find(s => s.id === this.currentScriptId); 
                const save = script.saves.find(s => s.id === this.currentSaveId); 
                
                save.chatHistory.push({ 
                    role: 'user', 
                    content: t, 
                    timestamp: Date.now(), 
                    customName: this.currentIdentity !== 'YOU' ? this.currentIdentity : null,
                    isPhone: false 
                }); 
                
                this.saveToLocal(); 
                this.renderChat(); 
                if(!contentOverride) i.value = ''; 
                this.updateCharCount(i);
                
                this.generateAIResponse('main'); 
            },

            sendPhoneMessage() {
                const input = document.getElementById('ios-chat-input');
                const t = input.value.trim();
                if(!t || !this.currentScriptId || !this.currentSaveId) return;

                const script = this.data.find(s => s.id === this.currentScriptId); 
                const save = script.saves.find(s => s.id === this.currentSaveId); 

                save.chatHistory.push({ 
                    role: 'user', 
                    content: t, 
                    timestamp: Date.now(),
                    isPhone: true 
                });

                this.saveToLocal();
                this.renderPhoneChat(); 
                input.value = '';
                input.style.height = 'auto';

                this.generateAIResponse('phone');
            },

            // [V79] RENDER FIX: SEPARATE TEXT AND CARD LOGIC
            renderChat() { 
                const script = this.data.find(s => s.id === this.currentScriptId); if(!script) return; 
                const save = script.saves ? script.saves.find(s => s.id === this.currentSaveId) : null; if (!save) return; 
                
                const c = document.getElementById('chat-container'); c.innerHTML = ''; 
                
                if (script.firstMes) { this.appendChatBubble(script.firstMes, 'ai', -1); } 
                
                if (save.chatHistory) {
                    save.chatHistory.forEach((msg, idx) => {
                        const isPhoneMsg = msg.isPhone === true; 
                        if (!isPhoneMsg) {
                            this.appendChatBubble(msg.content, msg.role, idx, msg.timestamp, msg.customName);
                        }
                    });
                }
                this.updateChatHeader(); 
            },

            // [V79] UPDATED BUBBLE FUNCTION
            appendChatBubble(text, role, idx, timestamp = Date.now(), customName = null) { 
                const script = this.data.find(s => s.id === this.currentScriptId); 
                const save = script.saves.find(s => s.id === this.currentSaveId); 
                const isUser = role === 'user'; 
                
                let avatar = "";
                let name = "";
                if (isUser) {
                    let activePersona = null;
                    if (save && script.personas) {
                        activePersona = script.personas.find(p => p.id === save.personaId);
                    }
                    if (!activePersona && script.personas && script.personas.length > 0) activePersona = script.personas[0]; 
                    
                    avatar = activePersona ? (activePersona.avatar || "https://api.dicebear.com/7.x/initials/svg?seed=ME") : "https://api.dicebear.com/7.x/initials/svg?seed=ME";
                    name = customName || (activePersona ? activePersona.name : "YOU");
                } else {
                    avatar = script.charAvatar || "https://api.dicebear.com/7.x/adventurer/svg?seed=Gener";
                    name = script.charName || "GM";
                }

                const date = new Date(timestamp); 
                const timeStr = `${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`; 
                let html = "";
                
                if (isUser) { 
                    const bubbleColor = "bg-[#3d59a1]/80 backdrop-blur-md text-white"; 
                    html = `<div class="flex flex-row-reverse gap-3 group message-group animate-fade-in-up relative mb-4" id="msg-${idx}"><img src="${avatar}" class="w-8 h-8 rounded-full mt-1 shrink-0 object-cover bg-[#1a1b26]/50 border border-[#2f334d]/50"><div class="flex flex-col gap-1 max-w-[85%] items-end relative"><div class="flex items-center gap-2"><span class="text-[10px] text-[#7aa2f7] font-bold">${name}</span><div class="msg-actions relative flex gap-3 mr-2"><button onclick="App.editMessage(${idx})" class="text-sm text-gray-500 hover:text-[#ff9e64] transition-colors cursor-pointer"><i class="fa-solid fa-pencil"></i></button>${idx !== -1 ? `<button onclick="App.deleteMessage(${idx})" class="text-sm text-gray-500 hover:text-red-400 transition-colors cursor-pointer"><i class="fa-solid fa-trash-can"></i></button>` : ''}</div></div><div class="${bubbleColor} p-2 px-3 text-sm rounded-l-xl rounded-br-xl shadow-sm relative z-10 w-fit"><div class="whitespace-pre-wrap break-words">${text}</div><span class="float-right text-[9px] opacity-50 ml-2 mt-1 select-none font-mono tracking-tighter">${timeStr}</span></div></div></div>`; 
                } else { 
                    // [V79] AI Message Layout: Centered & Full Width for Cards
                    html = `
                    <div class="flex flex-col gap-2 group message-group animate-fade-in-up relative mb-6 w-full items-center" id="msg-${idx}">
                        <div class="flex items-center justify-between w-full px-1">
                            <div class="flex items-center gap-3">
                                <img src="${avatar}" class="w-8 h-8 rounded-full object-cover bg-[#1a1b26]/50 border border-[#414868]/50 shadow-sm">
                                <span class="text-xs text-[#ff9e64] font-bold tracking-wider uppercase">${name}</span>
                            </div>
                            <div class="msg-actions flex gap-3 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="App.editMessage(${idx})" class="text-xs text-gray-500 hover:text-[#ff9e64]"><i class="fa-solid fa-pencil"></i></button>
                                ${idx !== -1 ? `<button onclick="App.deleteMessage(${idx})" class="text-xs text-gray-500 hover:text-red-400"><i class="fa-solid fa-trash-can"></i></button>` : ''}
                            </div>
                        </div>
                        <div class="ai-content-area dynamic-text">
                            ${text}
                        </div>
                        <div class="text-[9px] text-[#565f89] font-mono opacity-30 self-end mr-2">${timeStr}</div>
                    </div>`; 
                }
                document.getElementById('chat-container').insertAdjacentHTML('beforeend', html); 
            },

            renderPhoneChat() {
                const script = this.data.find(s => s.id === this.currentScriptId);
                const save = script ? script.saves.find(s => s.id === this.currentSaveId) : null;
                if(!save) return;

                const avatar = script.charAvatar || "https://api.dicebear.com/7.x/adventurer/svg?seed=Gener";
                document.getElementById('ios-header-avatar').src = avatar;
                document.getElementById('ios-contact-name').innerText = script.charName || "Unknown";
                
                const hintEl = document.getElementById('ios-contact-name-hint');
                if(hintEl) hintEl.innerText = script.charName || "Unknown";

                const c = document.getElementById('ios-chat-container');
                c.innerHTML = '<div class="text-center mt-4 mb-6 opacity-40 text-[10px] text-white">iMessage with <span id="ios-contact-name-hint" class="font-bold">' + (script.charName||'Char') + '</span></div>';

                save.chatHistory.forEach((msg, globalIdx) => {
                    if (msg.isPhone) {
                        const isUser = msg.role === 'user';
                        const div = document.createElement('div');
                        div.className = `ios-bubble ${isUser ? 'ios-bubble-user' : 'ios-bubble-other'}`;
                        div.innerHTML = `${msg.content.replace(/\n/g, '<br>')}<div class="delete-btn" onclick="App.deleteMessage(${globalIdx})"><i class="fa-solid fa-trash-can"></i></div>`;
                        c.appendChild(div);
                    }
                });
                
                setTimeout(() => {
                    c.scrollTop = c.scrollHeight;
                }, 50);
            },

            triggerPhoneNotification() {
                if(!this.phoneOpen) {
                    const audio = document.getElementById('phone-notification-sound');
                    if(audio) {
                        audio.currentTime = 0;
                        audio.volume = 0.5;
                        audio.play().catch(e => console.log("Audio blocked", e));
                    }
                    document.getElementById('phone-badge').classList.add('show');
                    this.showToast("收到新短信 ✉️");
                } else {
                    const c = document.getElementById('ios-chat-container');
                    setTimeout(() => c.scrollTop = c.scrollHeight, 100);
                }
            },
            regenerateResponse() { const script = this.data.find(s => s.id === this.currentScriptId); const save = script.saves.find(s => s.id === this.currentSaveId); if (!script || !save) return; if (save.chatHistory.length === 0) return; const lastMsg = save.chatHistory[save.chatHistory.length - 1]; if (lastMsg.role === 'ai') { save.chatHistory.pop(); this.saveToLocal(); this.renderChat(); this.generateAIResponse(); } else { this.showToast("最後一條不是AI消息"); } },
            scrollToTop() { document.getElementById('chat-container').scrollTo({ top: 0, behavior: 'smooth' }); },
            scrollToBottom() { const c = document.getElementById('chat-container'); c.scrollTo({ top: c.scrollHeight, behavior: 'smooth' }); },
            autoResizeInput(t) { t.style.height = 'auto'; t.style.height = (t.scrollHeight) + 'px'; },
            handleCardSelection(text) { const script = this.data.find(s => s.id === this.currentScriptId); const save = script.saves.find(s => s.id === this.currentSaveId); save.chatHistory.push({ role: 'user', content: "我選擇了：" + text, timestamp: Date.now() }); this.saveToLocal(); this.renderChat(); this.generateAIResponse(); this.showToast("劇情已觸發"); },
            sendHiddenContinue() { this.sendUserMessage("(繼續)"); },
            toggleFlip(card) { card.classList.toggle('is-flipped'); },
            async updatePreviewThumb(key, elId) { const b = await AssetDB.get(key); const el = document.getElementById(elId); if(b) { el.src = URL.createObjectURL(b); el.classList.add('show'); } else { el.classList.remove('show'); } },
            async updateAudioPreview() { const b = await AssetDB.get('custom_audio'); const el = document.getElementById('preview-audio-icon'); if(b) el.classList.add('show'); else el.classList.remove('show'); },
            async loadAudioSettings() { try { const a = document.getElementById('startup-audio'); const d = await AssetDB.get('custom_audio'); if (d) { a.src = URL.createObjectURL(d); a.load(); } else { a.src = "data:audio/wav;base64,UklGRl9vT1BXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"; } } catch(e) { console.error("Audio Load Fail", e); } },
            unlockAudioEngine() { if (this.audioUnlocked) return; const a = document.getElementById('startup-audio'); if(!a.src) return; a.volume = 0; a.play().then(() => { a.pause(); a.currentTime = 0; a.volume = 0.6; this.audioUnlocked = true; }).catch(()=>{}); },
            tryUnlock() { this.unlockAudioEngine(); document.getElementById('login-text').innerText = "Processing..."; try { const s = JSON.parse(localStorage.getItem('roleplay_api_settings')) || {}; if (s.passcode && s.passcode.length === 4) { document.getElementById('keypad-overlay').classList.add('active'); this.currentPin = ""; this.updatePinDots(); } else { this.performUnlock(); } } catch(e){ this.performUnlock(); } },
            performUnlock() { 
                const a = document.getElementById('startup-audio'); if(a) { a.currentTime = 0; a.volume = 0.6; a.play().catch(e => console.warn(e)); } 
                this.animateScan(); 
                document.getElementById('music-widget-min').style.display = 'flex';
            },
            inputPin(n) { if (this.currentPin.length < 4) { this.currentPin += n; this.updatePinDots(); if (this.currentPin.length === 4) setTimeout(() => this.checkPin(), 200); } },
            clearPin() { this.currentPin = this.currentPin.slice(0, -1); this.updatePinDots(); },
            cancelPin() { document.getElementById('keypad-overlay').classList.remove('active'); this.currentPin = ""; this.updatePinDots(); },
            updatePinDots() { for(let i=1; i<=4; i++) { const d = document.getElementById(`dot-${i}`); if (i <= this.currentPin.length) d.classList.add('filled'); else d.classList.remove('filled'); } },
            checkPin() { const s = JSON.parse(localStorage.getItem('roleplay_api_settings')) || {}; if (this.currentPin === s.passcode) { document.getElementById('keypad-overlay').classList.remove('active'); this.performUnlock(); } else { document.querySelector('.mb-10').classList.add('animate-bounce'); setTimeout(() => { document.querySelector('.mb-10').classList.remove('animate-bounce'); this.currentPin = ""; this.updatePinDots(); }, 500); } },
            animateScan() { document.getElementById('scan-line').style.display = 'block'; document.getElementById('login-text').innerText = "Verifying..."; document.getElementById('login-text').classList.add('text-[#7aa2f7]', 'animate-pulse'); setTimeout(() => { document.getElementById('login-text').innerText = "Granted"; document.getElementById('login-text').classList.replace('text-[#7aa2f7]', 'text-green-400'); setTimeout(() => { document.getElementById('view-cover').style.display = 'none'; document.getElementById('view-dashboard').classList.remove('view-hidden'); }, 500); }, 1200); },
            renderAestheticTitle(text) { const c = document.getElementById('aesthetic-title'); c.innerHTML = ''; const str = text || "以文為碼，重構森羅萬象"; const lines = str.split(/[ ，,。.\n]/).filter(l => l.trim() !== ""); lines.forEach((line) => { const div = document.createElement('div'); div.className = 'title-line'; div.innerText = line; c.appendChild(div); }); },
            handleImageUpload(i, t) { const f = i.files[0]; if (!f) return; const r = new FileReader(); r.onload = (e) => { this.updateScriptData(t, e.target.result); this.renderAvatar(t === 'charAvatar' ? 'char' : 'user', e.target.result); }; r.readAsDataURL(f); i.value = ''; },
            renderAvatar(p, s) { if (p === 'user') return; const i = document.getElementById(`img-${p}-avatar`); const ph = document.getElementById(`ph-${p}-avatar`); if (s) { i.src = s; i.classList.remove('hidden'); ph.classList.add('hidden'); } else { i.src = ""; i.classList.add('hidden'); ph.classList.remove('hidden'); } },
            exportData() { const j = JSON.stringify(this.data, null, 2); const b = new Blob([j], {type: "application/json"}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = `RP_V71_Backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); },

            importData(i) { const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload = (e) => { try { const j = JSON.parse(e.target.result); if (Array.isArray(j)) { this.data = j; this.dataLoaded = true; this.saveToLocal(); this.renderScriptList(); alert(`成功導入 ${j.length} 個劇本！`); } else { alert("格式錯誤"); } } catch(e) { alert("解析失敗"); } }; r.readAsText(f); i.value = ''; },
            handleFileImport(i, t) { const f = i.files[0]; if (!f) return; const r = new FileReader(); r.onload = (e) => { const raw = e.target.result; try { const j = JSON.parse(raw); if (t === 'character') { if(j.name) { document.getElementById('input-char-name').value = j.name; this.updateScriptData('charName', j.name); } if(j.description) { document.getElementById('input-char-desc').value = j.description; this.updateScriptData('charDesc', j.description); } if(j.first_mes) { document.getElementById('input-first-mes').value = j.first_mes; this.updateScriptData('firstMes', j.first_mes); } this.showToast("导入成功"); } else if (t === 'world') { let x = j.entries ? j.entries.map(en => `[${en.keys}]: ${en.content}`).join('\n\n') : (j.world_scenario || JSON.stringify(j, null, 2)); const c = document.getElementById('input-world-scenario').value; const n = c ? c + "\n\n" + x : x; document.getElementById('input-world-scenario').value = n; this.updateScriptData('worldScenario', n); this.showToast("世界书追加"); } } catch (err) { if (t === 'world') { const c = document.getElementById('input-world-scenario').value; const n = c ? c + "\n\n" + raw : raw; document.getElementById('input-world-scenario').value = n; this.updateScriptData('worldScenario', n); this.showToast("文本追加"); } } }; r.readAsText(f); i.value = ''; },
            handleAudioUpload(i) { const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload = async (e) => { const b = new Blob([e.target.result], { type: f.type }); await AssetDB.save('custom_audio', b); this.loadAudioSettings(); this.updateAudioPreview(); this.showToast("音效已更換"); setTimeout(()=>document.getElementById('startup-audio').play(), 500); }; r.readAsArrayBuffer(f); i.value = ''; },
            async clearAudio() { await AssetDB.delete('custom_audio'); this.loadAudioSettings(); this.updateAudioPreview(); this.showToast("已恢復"); },
            async loadBackground() { try{ const b = await AssetDB.get('bg_image'); const el = document.getElementById('app-background'); if (b) { el.style.backgroundImage = `url(${URL.createObjectURL(b)})`; const s = JSON.parse(localStorage.getItem('roleplay_api_settings')) || {}; const op = s.bgOpacity !== undefined ? s.bgOpacity : 15; el.style.opacity = op / 100; } else { el.style.backgroundImage = 'none'; el.style.opacity = '0'; } }catch(e){} },
            handleBgUpload(i) { const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload = async (e) => { const b = new Blob([e.target.result], {type: f.type}); await AssetDB.save('bg_image', b); this.loadBackground(); this.updatePreviewThumb('bg_image', 'preview-bg'); this.showToast("背景已設"); }; r.readAsArrayBuffer(f); i.value = ''; },
            async clearBackground() { await AssetDB.delete('bg_image'); this.showToast("背景已刪"); },
            async loadCoverSettings() { try { const s = JSON.parse(localStorage.getItem('roleplay_api_settings')) || {}; this.renderAestheticTitle(s.welcomeText); document.getElementById('input-welcome-text').value = s.welcomeText || ""; document.getElementById('input-passcode').value = s.passcode || ""; document.getElementById('theatre-mode-toggle').checked = s.theatreMode || false; const b = await AssetDB.get('cover_image'); if (b) document.getElementById('view-cover').style.backgroundImage = `url(${URL.createObjectURL(b)})`; } catch(e){}},
            handleCoverUpload(i) { const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload = async (e) => { const b = new Blob([e.target.result], {type: f.type}); await AssetDB.save('cover_image', b); this.loadCoverSettings(); this.updatePreviewThumb('cover_image', 'preview-cover'); this.showToast("封面已換"); }; r.readAsArrayBuffer(f); i.value = ''; },
            async clearCover() { await AssetDB.delete('cover_image'); document.getElementById('view-cover').style.backgroundImage = "url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop')"; this.showToast("封面重置"); },
            updateCharCount(t) { document.getElementById('char-count').innerText = t.value.length + ' chars'; },
            toggleAppearanceMenu() { document.getElementById('appearance-menu').classList.toggle('show'); },
            updateAppearance(key, value) { document.documentElement.style.setProperty(`--chat-${key.replace(/[A-Z]/g, m => "-" + m.toLowerCase())}`, value); const settings = JSON.parse(localStorage.getItem('roleplay_ui_settings')) || {}; settings[key] = value; localStorage.setItem('roleplay_ui_settings', JSON.stringify(settings)); const btns = document.querySelectorAll(`.setting-btn[onclick*="${key}"]`); btns.forEach(b => { if (b.getAttribute('onclick').includes(`'${value}'`)) { btns.forEach(btn => btn.classList.remove('active')); b.classList.add('active'); } }); if(key === 'color' && document.getElementById('color-picker')) { document.getElementById('color-picker').value = value; } },
            loadAppearanceSettings() { const s = JSON.parse(localStorage.getItem('roleplay_ui_settings')) || {}; if(s.fontSize) this.updateAppearance('fontSize', s.fontSize); if(s.lineHeight) this.updateAppearance('lineHeight', s.lineHeight); if(s.color) this.updateAppearance('color', s.color); if(s.fontWeight) this.updateAppearance('fontWeight', s.fontWeight); },
            clearInput(id) { const el = document.getElementById(id); if(el) { el.value = ""; el.dispatchEvent(new Event('input')); this.showToast("已清空"); } },
            showToast(m) { const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = 'bg-[#1f2335] text-[#7aa2f7] px-4 py-2 rounded-full border border-[#2f334d] shadow-lg text-xs font-bold toast-enter'; t.innerText = m; c.appendChild(t); setTimeout(() => { t.classList.remove('toast-enter'); t.classList.add('toast-enter-active'); }, 10); setTimeout(() => { t.classList.remove('toast-enter-active'); t.classList.add('toast-exit-active'); }, 2000); setTimeout(() => t.remove(), 2300); },
            openFullscreen(id, t) { this.fsTargetId = id; document.getElementById('fs-textarea').value = document.getElementById(id).value; document.getElementById('fs-title').innerText = "正在編輯: " + t; document.getElementById('fullscreen-editor').style.display = 'flex'; document.getElementById('fs-textarea').oninput = (e) => { document.getElementById(this.fsTargetId).value = e.target.value; document.getElementById(this.fsTargetId).dispatchEvent(new Event('input')); }; },
            closeFullscreen() { document.getElementById('fullscreen-editor').style.display = 'none'; this.fsTargetId = null; if (this.editMsgIndex !== null) { const script = this.data.find(s => s.id === this.currentScriptId); const save = script.saves.find(s => s.id === this.currentSaveId); if (script && save) { const n = document.getElementById('fs-textarea').value; if (this.editMsgIndex === -1) { script.firstMes = n; const el = document.getElementById('input-first-mes'); if(el) el.value = n; } else { save.chatHistory[this.editMsgIndex].content = n; } this.saveToLocal(); this.renderChat(); } this.editMsgIndex = null; } },
            
            // [V78] FIX: Centered AI Message Layout
            appendChatBubble(text, role, idx, timestamp = Date.now(), customName = null) { 
                const script = this.data.find(s => s.id === this.currentScriptId); 
                const save = script.saves.find(s => s.id === this.currentSaveId); 
                const isUser = role === 'user'; 
                
                let avatar = "";
                let name = "";
                if (isUser) {
                    let activePersona = null;
                    if (save && script.personas) {
                        activePersona = script.personas.find(p => p.id === save.personaId);
                    }
                    if (!activePersona && script.personas && script.personas.length > 0) activePersona = script.personas[0]; 
                    
                    avatar = activePersona ? (activePersona.avatar || "https://api.dicebear.com/7.x/initials/svg?seed=ME") : "https://api.dicebear.com/7.x/initials/svg?seed=ME";
                    name = customName || (activePersona ? activePersona.name : "YOU");
                } else {
                    avatar = script.charAvatar || "https://api.dicebear.com/7.x/adventurer/svg?seed=Gener";
                    name = script.charName || "GM";
                }

                const date = new Date(timestamp); 
                const timeStr = `${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`; 
                let html = "";
                if (isUser) { 
                    const bubbleColor = "bg-[#3d59a1]/80 backdrop-blur-md text-white"; 
                    html = `<div class="flex flex-row-reverse gap-3 group message-group animate-fade-in-up relative mb-4" id="msg-${idx}"><img src="${avatar}" class="w-8 h-8 rounded-full mt-1 shrink-0 object-cover bg-[#1a1b26]/50 border border-[#2f334d]/50"><div class="flex flex-col gap-1 max-w-[85%] items-end relative"><div class="flex items-center gap-2"><span class="text-[10px] text-[#7aa2f7] font-bold">${name}</span><div class="msg-actions relative flex gap-3 mr-2"><button onclick="App.editMessage(${idx})" class="text-sm text-gray-500 hover:text-[#ff9e64] transition-colors cursor-pointer"><i class="fa-solid fa-pencil"></i></button>${idx !== -1 ? `<button onclick="App.deleteMessage(${idx})" class="text-sm text-gray-500 hover:text-red-400 transition-colors cursor-pointer"><i class="fa-solid fa-trash-can"></i></button>` : ''}</div></div><div class="${bubbleColor} p-2 px-3 text-sm rounded-l-xl rounded-br-xl shadow-sm relative z-10 w-fit"><div class="whitespace-pre-wrap break-words">${text}</div><span class="float-right text-[9px] opacity-50 ml-2 mt-1 select-none font-mono tracking-tighter">${timeStr}</span></div></div></div>`; 
                } else { 
                    // [V78] AI Message Layout: Centered & Full Width for Cards
                    html = `<div class="flex flex-col gap-2 group message-group animate-fade-in-up relative mb-6 w-full items-center" id="msg-${idx}"><div class="flex items-center justify-between w-full px-1"><div class="flex items-center gap-3"><img src="${avatar}" class="w-8 h-8 rounded-full object-cover bg-[#1a1b26]/50 border border-[#414868]/50 shadow-sm"><span class="text-xs text-[#ff9e64] font-bold tracking-wider uppercase">${name}</span></div><div class="msg-actions flex gap-3 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="App.editMessage(${idx})" class="text-xs text-gray-500 hover:text-[#ff9e64]"><i class="fa-solid fa-pencil"></i></button>${idx !== -1 ? `<button onclick="App.deleteMessage(${idx})" class="text-xs text-gray-500 hover:text-red-400"><i class="fa-solid fa-trash-can"></i></button>` : ''}</div></div><div class="ai-content-area dynamic-text"><div class="whitespace-pre-wrap break-words w-full">${text}</div></div><div class="text-[9px] text-[#565f89] font-mono opacity-30 self-end mr-2">${timeStr}</div></div>`; 
                }
                document.getElementById('chat-container').insertAdjacentHTML('beforeend', html); 
            },
            updateChatHeader() { const script = this.data.find(s => s.id === this.currentScriptId); if(!script) return; document.getElementById('chat-title').innerText = script.title || "未命名"; document.getElementById('chat-header-avatar').src = script.charAvatar || "https://api.dicebear.com/7.x/adventurer/svg?seed=Gener"; },
            
            editMessage(idx) { const script = this.data.find(s => s.id === this.currentScriptId); const save = script.saves.find(s => s.id === this.currentSaveId); let c = idx === -1 ? script.firstMes : save.chatHistory[idx].content; this.editMsgIndex = idx; document.getElementById('fs-textarea').value = c; document.getElementById('fs-title').innerText = "正在編輯消息"; document.getElementById('fullscreen-editor').style.display = 'flex'; },
            deleteMessage(idx) { 
                const script = this.data.find(s => s.id === this.currentScriptId); 
                const save = script.saves.find(s => s.id === this.currentSaveId); 
                save.chatHistory.splice(idx, 1); 
                this.saveToLocal(); 
                this.renderChat(); 
                if(this.phoneOpen) this.renderPhoneChat();
                this.showToast("已刪除"); 
            },
            handleRawPresetUpload(i) { const f = i.files; if (!f || f.length === 0) return; let txt = ""; let c = 0; Array.from(f).forEach(file => { const r = new FileReader(); r.onload = (e) => { txt += `\n\n--- File: ${file.name} ---\n${e.target.result}`; c++; if (c === f.length) { 
                const currentVal = document.getElementById('input-jailbreak').value;
                const newVal = currentVal + txt;
                document.getElementById('input-jailbreak').value = newVal;
                this.updateScriptData('jailbreak', newVal); 
                this.showToast(`已追加 ${f.length} 個文件`); i.value = ''; } }; r.readAsText(file); }); },
            async fetchModels() { 
                let url = document.getElementById('input-api-url').value.replace(/\/$/, ''); const key = document.getElementById('input-api-key').value; const select = document.getElementById('select-model'); 
                if (!url) return alert("請先填寫 API 地址"); select.innerHTML = '<option>連接中...</option>'; 
                const fallback = ["gemini-1.5-flash", "gemini-1.5-pro", "gemini-1.5-flash-8b", "gemini-1.0-pro", "gpt-4o", "gpt-4o-mini", "claude-3-5-sonnet"]; 
                try { 
                    let fUrl = "", h = {}; 
                    if (url.includes('googleapis.com')) { if (!url.includes('v1beta')) url += '/v1beta'; fUrl = `${url}/models?key=${key}`; } else { fUrl = `${url}/models`; h = { 'Authorization': `Bearer ${key}` }; } 
                    const res = await fetch(fUrl, { method: 'GET', headers: h }); if (!res.ok) throw new Error("Err"); const data = await res.json(); 
                    const models = data.models || data.data || []; select.innerHTML = ''; 
                    if (models.length === 0) throw new Error("No models");
                    models.forEach(m => { let id = m.name || m.id; if (id.startsWith('models/')) id = id.replace('models/', ''); const opt = document.createElement('option'); opt.value = id; opt.text = id; select.appendChild(opt); }); 
                    this.showToast(`已獲取 ${models.length} 個模型`); 
                } catch (err) { 
                    select.innerHTML = ''; fallback.forEach(m => { const opt = document.createElement('option'); opt.value = m; opt.text = m; select.appendChild(opt); }); 
                    this.showToast("已加載通用模型列表"); select.value = fallback[0]; this.saveSystemSettings(); 
                } 
            },
            switchTab(t) { document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); document.getElementById(`nav-${t}`).classList.add('active'); ['adventure', 'system'].forEach(p => { const el = document.getElementById(`page-${p}`); if(el) el.style.display = (p === t) ? 'block' : 'none'; }); },

        };
        window.onload = () => App.init();
    </script>
</body>
</html>
